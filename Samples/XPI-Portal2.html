<html lang="en" class="h-full bg-gray-900" width="1200px" height="800px">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="h-full text-gray-200">
    <div id="app" class="flex h-full">
        <!-- Navigation Bar -->
        <nav id="nav-bar" class="bg-gray-800 w-64 p-4 flex-shrink-0 hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-xl font-bold">XPI Portal</h1>
                <button id="nav-toggle-btn" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
            <ul id="nav-modules"></ul>
            <div id="profile-area" class="absolute bottom-4 left-4 hidden">
                <div class="flex items-center">
                    <img id="avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
                    <div>
                        <p id="user-name" class="font-semibold"></p>
                        <a href="#" id="logout-link" class="text-sm text-blue-400 hover:underline">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 overflow-y-auto">
            <!-- Admin Module -->
            <div id="admin-module" class="module hidden"></div>
            <!-- Login Module -->
            <div id="login-module" class="module hidden"></div>
            <!-- Campaign Submission Module -->
            <div id="campaign-submission-module" class="module hidden"></div>
        </main>

        <!-- Developer Tool -->
        <div id="dev-tool">
            <button id="dev-tool-toggle" class="fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-1.414 1.414a1 1 0 01-1.414 0l-1.293-1.293a1 1 0 00-1.414 0l-1.414 1.414a1 1 0 01-1.414 0L6.586 13.293A1 1 0 006 13H4m16 0L12 7 4 13m8 6v-6"></path></svg>
            </button>
            <div id="dev-tool-logs" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-gray-800 w-4/5 h-4/5 rounded-lg shadow-xl p-6 relative">
                    <h2 class="text-2xl font-bold mb-4">API Call Logs</h2>
                    <button id="dev-tool-close" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <button id="dev-tool-purge" class="absolute top-4 right-12 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                    <div id="dev-tool-log-table-container" class="overflow-y-auto h-full"></div>
                </div>
            </div>
            <div id="payload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-gray-800 w-3/5 rounded-lg shadow-xl p-6 relative">
                    <h3 class="text-xl font-bold mb-4">Payload</h3>
                    <button id="payload-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <pre id="payload-content" class="bg-gray-900 p-4 rounded overflow-auto max-h-96"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configuration
            const modules = [
                { name: 'Admin', code: 'MOD.A', description: 'Administrative Module', type: 'Built-in' },
                { name: 'Login', code: 'MOD.B', description: 'Login Module', type: 'Built-in' },
                { name: 'Campaign Submission', code: 'MOD.C', description: 'Campaign Submission Module', type: 'User-defined' }
            ];

            // DOM Elements
            const navBar = document.getElementById('nav-bar');
            const navToggleBtn = document.getElementById('nav-toggle-btn');
            const navModules = document.getElementById('nav-modules');
            const profileArea = document.getElementById('profile-area');
            const avatar = document.getElementById('avatar');
            const userName = document.getElementById('user-name');
            const logoutLink = document.getElementById('logout-link');
            const mainContent = document.getElementById('main-content');
            const adminModule = document.getElementById('admin-module');
            const loginModule = document.getElementById('login-module');
            const campaignSubmissionModule = document.getElementById('campaign-submission-module');
            const devToolToggle = document.getElementById('dev-tool-toggle');
            const devToolLogs = document.getElementById('dev-tool-logs');
            const devToolClose = document.getElementById('dev-tool-close');
            const devToolPurge = document.getElementById('dev-tool-purge');
            const devToolLogTableContainer = document.getElementById('dev-tool-log-table-container');
            const payloadModal = document.getElementById('payload-modal');
            const payloadModalClose = document.getElementById('payload-modal-close');
            const payloadContent = document.getElementById('payload-content');

            // App State
            let isLoggedIn = false;

            // --- Initialization ---
            function init() {
                // Global Config
                if (!localStorage.getItem('xpiBaseUrl')) {
                    localStorage.setItem('xpiBaseUrl', 'https://api.wrikexpi.groupm.com');
                }

                // Check login status
                if (localStorage.getItem('token') && localStorage.getItem('username') && localStorage.getItem('password')) {
                    isLoggedIn = true;
                }

                // Routing
                handleRouting();

                // Event Listeners
                navToggleBtn.addEventListener('click', () => navBar.classList.toggle('w-64'));
                logoutLink.addEventListener('click', logout);
                devToolToggle.addEventListener('click', () => devToolLogs.classList.remove('hidden'));
                devToolClose.addEventListener('click', () => devToolLogs.classList.add('hidden'));
                devToolPurge.addEventListener('click', purgeLogs);
                payloadModalClose.addEventListener('click', () => payloadModal.classList.add('hidden'));
                window.addEventListener('hashchange', handleRouting);
            }

            // --- Routing ---
            function handleRouting() {
                hideAllModules();
                const hash = window.location.hash;
                const params = new URLSearchParams(window.location.search);

                if (hash === '#admin') {
                    showModule(adminModule);
                    renderAdminModule();
                } else if (params.has('code')) {
                    showModule(loginModule);
                    renderLoginModule(params.get('code'));
                } else if (isLoggedIn) {
                    showModule(campaignSubmissionModule);
                    renderCampaignSubmissionModule();
                    showNavBar();
                } else {
                    showModule(loginModule);
                    renderLoginModule();
                }
            }

            function showModule(module) {
                module.classList.remove('hidden');
            }

            function hideAllModules() {
                document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
            }

            // --- UI Rendering ---
            function showNavBar() {
                navBar.classList.remove('hidden');
                profileArea.classList.remove('hidden');
                userName.textContent = `${localStorage.getItem('firstName')} ${localStorage.getItem('lastName')}`;
                avatar.src = localStorage.getItem('avatarUrl');
                renderNavModules();
            }

            function renderNavModules() {
                navModules.innerHTML = '';
                modules.filter(m => m.type === 'User-defined').forEach(m => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" class="block py-2 px-4 rounded hover:bg-gray-700">${m.name}</a>`;
                    navModules.appendChild(li);
                });
            }

            // --- Admin Module ---
            function renderAdminModule() {
                adminModule.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Admin Configuration</h2>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <label for="xpiBaseUrl" class="block text-sm font-medium mb-2">XPI Base URL</label>
                        <input type="text" id="xpiBaseUrl" value="${localStorage.getItem('xpiBaseUrl')}" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                        <button id="save-config-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save</button>
                    </div>
                `;
                document.getElementById('save-config-btn').addEventListener('click', () => {
                    localStorage.setItem('xpiBaseUrl', document.getElementById('xpiBaseUrl').value);
                    alert('Configuration saved!');
                });
            }

            // --- Login Module ---
            async function renderLoginModule(code = null) {
                if (code) {
                    // OAuth Callback Mode
                    loginModule.innerHTML = `<div class="flex justify-center items-center"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div></div>`;
                    const clientId = localStorage.getItem('clientId');
                    if (!clientId || !code) {
                        loginModule.innerHTML = `<p class="text-red-500">Error: Missing client ID or code.</p>`;
                        setTimeout(() => window.location.href = window.location.pathname, 10000);
                        return;
                    }

                    try {
                        const xpiBaseUrl = localStorage.getItem('xpiBaseUrl');
                        const response = await apiFetch(`${xpiBaseUrl}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`);

                        if (response.success) {
                            localStorage.setItem('token', response.data.token);
                            localStorage.setItem('username', response.data.credentials.username);
                            localStorage.setItem('password', response.data.credentials.password);

                            // Verify login
                            const profileResponse = await apiFetch(`${xpiBaseUrl}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`, {
                                headers: { 'Authorization': 'Basic ' + btoa(`${response.data.credentials.username}:${response.data.credentials.password}`) }
                            });

                            if (profileResponse.success && profileResponse.data.length > 0) {
                                const user = profileResponse.data[0];
                                localStorage.setItem('firstName', user.firstName);
                                localStorage.setItem('lastName', user.lastName);
                                localStorage.setItem('avatarUrl', user.avatarUrl);
                                isLoggedIn = true;
                                loginModule.innerHTML = `<p class="text-green-500">${user.firstName} ${user.lastName} login successfully.</p>`;
                                setTimeout(() => window.location.href = window.location.pathname, 2000);
                            } else {
                                throw new Error('Failed to verify account.');
                            }
                        } else {
                            throw new Error('API call unsuccessful.');
                        }
                    } catch (error) {
                        loginModule.innerHTML = `
                            <p class="text-red-500">Login failed. Please try again.</p>
                            <pre class="bg-gray-800 p-4 rounded mt-4">${error.message}</pre>
                            <button id="start-over-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Start Over</button>
                        `;
                        document.getElementById('start-over-btn').addEventListener('click', () => window.location.href = window.location.pathname);
                    }
                } else {
                    // Authentication Mode
                    loginModule.innerHTML = `<button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Login & Authenticate</button>`;
                    document.getElementById('login-btn').addEventListener('click', async () => {
                        const timestamp = new Date().getTime();
                        const random = Math.random();
                        const hash = await sha256(timestamp.toString() + random.toString());
                        const clientId = hash.slice(-7);
                        localStorage.setItem('clientId', clientId);
                        const redirectUri = window.location.origin + window.location.pathname;
                        const xpiBaseUrl = localStorage.getItem('xpiBaseUrl');
                        window.location.href = `${xpiBaseUrl}/?accountId=3128883&redirectUri=${redirectUri}&client_id=${clientId}`;
                    });
                }
            }

            // --- Campaign Submission Module ---
            async function renderCampaignSubmissionModule() {
                campaignSubmissionModule.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Campaign Submission</h2>
                    <form id="campaign-form" class="bg-gray-800 p-8 rounded-lg max-w-4xl mx-auto">
                        <!-- Hidden fields -->
                        <input type="hidden" name="type" value="Campaign Request">
                        <input type="hidden" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" name="entity" value="Campaign">
                        <input type="hidden" name="varientId" value="1">

                        <div class="grid md:grid-cols-2 gap-6">
                            <div><label for="requestedstartdate" class="block mb-2">Requested Start Date</label><input type="date" id="requestedstartdate" name="requestedstartdate" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="agency" class="block mb-2">Agency</label><select id="agency" name="agency" class="w-full bg-gray-700 p-2 rounded"></select></div>
                            <div><label for="brand" class="block mb-2">Brand</label><input type="text" id="brand" name="brand" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="client" class="block mb-2">Client</label><select id="client" name="client" class="w-full bg-gray-700 p-2 rounded"></select></div>
                            <div><label for="debtor" class="block mb-2">Debtor</label><select id="debtor" name="debtor" class="w-full bg-gray-700 p-2 rounded"></select></div>
                            <div><label for="currency" class="block mb-2">Currency</label><input type="text" id="currency" name="currency" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="pod" class="block mb-2">Pod</label><input type="text" id="pod" name="pod" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="campaignname" class="block mb-2">Campaign Name</label><input type="text" id="campaignname" name="campaignname" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="campaignstartdate" class="block mb-2">Campaign Start Date</label><input type="date" id="campaignstartdate" name="campaignstartdate" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="campaignenddate" class="block mb-2">Campaign End Date</label><input type="date" id="campaignenddate" name="campaignenddate" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="campaignobjective" class="block mb-2">Campaign Objective</label><input type="text" id="campaignobjective" name="campaignobjective" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="requestormarket" class="block mb-2">Requestor Market</label><input type="text" id="requestormarket" name="requestormarket" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="optin" class="block mb-2">Opt-in</label><select id="optin" name="optin" class="w-full bg-gray-700 p-2 rounded"><option>Yes</option><option>No</option></select></div>
                            <div><label for="porequired" class="block mb-2">PO Required</label><select id="porequired" name="porequired" class="w-full bg-gray-700 p-2 rounded"><option>Yes</option><option>No</option></select></div>
                            <div><label for="overallbudget" class="block mb-2">Overall Budget</label><input type="number" id="overallbudget" name="overallbudget" class="w-full bg-gray-700 p-2 rounded"></div>
                            <div><label for="selectedchannels" class="block mb-2">Selected Channels (comma-separated)</label><input type="text" id="selectedchannels" name="selectedchannels" class="w-full bg-gray-700 p-2 rounded"></div>
                        </div>
                        <button type="submit" id="submit-campaign-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Submit</button>
                    </form>
                    <pre id="campaign-result" class="hidden mt-6 bg-gray-900 p-4 rounded"></pre>
                `;

                // Populate dropdowns
                populateDropdown('client', `${localStorage.getItem('xpiBaseUrl')}/api/v1/wrikexpi/v1.0/value/clients-grm-mys`);
                populateDropdown('debtor', `${localStorage.getItem('xpiBaseUrl')}/api/v1/wrikexpi/v1.0/value/debtors-grm-mys`);
                populateDropdown('agency', `${localStorage.getItem('xpiBaseUrl')}/api/v1/wrikexpi/v1.0/value/agencies`);

                // Form submission
                document.getElementById('campaign-form').addEventListener('submit', handleCampaignSubmit);
            }

            async function populateDropdown(elementId, url) {
                const select = document.getElementById(elementId);
                try {
                    const response = await apiFetch(url, {
                        headers: { 'Authorization': 'Basic ' + btoa(`${localStorage.getItem('username')}:${localStorage.getItem('password')}`) }
                    });
                    if (response.value) {
                        response.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.value;
                            option.textContent = item.value;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error(`Failed to populate ${elementId}:`, error);
                }
            }

            async function handleCampaignSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const submitBtn = document.getElementById('submit-campaign-btn');
                const resultPre = document.getElementById('campaign-result');

                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                resultPre.classList.add('hidden');

                try {
                    const formData = new FormData(form);
                    const payload = {
                        fields: {}
                    };
                    for (let [key, value] of formData.entries()) {
                        if (['type', 'space', 'entity', 'varientId'].includes(key)) {
                            payload[key] = value;
                        } else {
                            payload.fields[key] = value;
                        }
                    }
                    payload.fields.selectedchannels = payload.fields.selectedchannels.split(',').map(s => s.trim()).filter(Boolean);

                    const response = await apiFetch(`${localStorage.getItem('xpiBaseUrl')}/api/v1/wrikexpi/campaign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(payload)
                    });

                    resultPre.textContent = JSON.stringify(response, null, 2);
                    resultPre.classList.remove('hidden');
                    resultPre.classList.add('text-green-500');
                } catch (error) {
                    resultPre.textContent = `Error: ${error.message}`;
                    resultPre.classList.remove('hidden');
                    resultPre.classList.add('text-red-500');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            }

            // --- Dev Tool ---
            function logApiCall(url, method, requestPayload, responsePayload, status) {
                const logs = JSON.parse(localStorage.getItem('apiLogs') || '[]');
                logs.unshift({
                    timestamp: new Date().toISOString(),
                    url,
                    method,
                    requestPayload,
                    responsePayload,
                    status
                });
                localStorage.setItem('apiLogs', JSON.stringify(logs));
                renderLogTable();
            }

            function renderLogTable() {
                const logs = JSON.parse(localStorage.getItem('apiLogs') || '[]');
                if (logs.length === 0) {
                    devToolLogTableContainer.innerHTML = '<p>No API calls logged yet.</p>';
                    return;
                }
                let tableHtml = `<table class="w-full text-left"><thead><tr>
                    <th class="p-2">Timestamp</th>
                    <th class="p-2">Status</th>
                    <th class="p-2">Method</th>
                    <th class="p-2">URL</th>
                    <th class="p-2">Request</th>
                    <th class="p-2">Response</th>
                </tr></thead><tbody>`;
                logs.forEach((log, index) => {
                    tableHtml += `<tr class="border-t border-gray-700">
                        <td class="p-2">${log.timestamp}</td>
                        <td class="p-2">${log.status}</td>
                        <td class="p-2">${log.method}</td>
                        <td class="p-2">${log.url}</td>
                        <td class="p-2"><a href="#" class="text-blue-400" data-log-index="${index}" data-payload-type="request">View</a></td>
                        <td class="p-2"><a href="#" class="text-blue-400" data-log-index="${index}" data-payload-type="response">View</a></td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                devToolLogTableContainer.innerHTML = tableHtml;

                devToolLogTableContainer.querySelectorAll('a').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const index = e.target.dataset.logIndex;
                        const type = e.target.dataset.payloadType;
                        const log = logs[index];
                        payloadContent.textContent = JSON.stringify(type === 'request' ? log.requestPayload : log.responsePayload, null, 2);
                        payloadModal.classList.remove('hidden');
                    });
                });
            }

            function purgeLogs() {
                localStorage.removeItem('apiLogs');
                renderLogTable();
            }

            // --- Helpers ---
            async function apiFetch(url, options = {}) {
                const method = options.method || 'GET';
                const body = options.body;
                let response, responseData;
                try {
                    response = await fetch(url, options);
                    responseData = await response.json();
                    logApiCall(url, method, body ? JSON.parse(body) : null, responseData, response.status);
                    if (!response.ok) {
                        throw new Error(responseData.message || `HTTP error! status: ${response.status}`);
                    }
                    return responseData;
                } catch (error) {
                    logApiCall(url, method, body ? JSON.parse(body) : null, { error: error.message }, response ? response.status : 'Network Error');
                    throw error;
                }
            }

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('password');
                localStorage.removeItem('firstName');
                localStorage.removeItem('lastName');
                localStorage.removeItem('avatarUrl');
                isLoggedIn = false;
                window.location.href = window.location.pathname;
            }

            async function sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            // --- Start the app ---
            init();
        });
    </script>
</body>
</html>