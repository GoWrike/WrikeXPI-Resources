<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Base styles */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid #4b5563; /* bg-gray-600 */
            border-top: 4px solid #3b82f6; /* border-blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div id="app" class="relative min-h-screen flex">

        <nav id="navbar" class="bg-gray-800 text-gray-300 w-64 flex-shrink-0 flex-col fixed inset-y-0 left-0 z-30
                           transform -translate-x-full transition-transform duration-300 ease-in-out hidden">
            <div class="flex items-center justify-between p-4 h-16 border-b border-gray-700">
                <span class="text-xl font-bold text-white">XPI Portal</span>
                <button id="nav-toggle-btn-close" class="p-1 rounded-md text-gray-400 hover:text-white hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="nav-links" class="flex-grow overflow-y-auto">
                </div>

            <div id="profile-area" class="p-4 border-t border-gray-700">
                <div class="flex items-center">
                    <img id="profile-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                    <div class="ml-3">
                        <p id="profile-name" class="font-semibold text-sm text-white">Loading...</p>
                        <a id="logout-link" href="#" class="text-xs text-blue-400 hover:text-blue-300">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <main id="main-content" class="flex-1 transition-all duration-300 ease-in-out">
            <button id="nav-toggle-btn-open" class="fixed top-4 left-4 z-20 p-2 bg-gray-800 text-gray-300 rounded-md shadow-lg hidden
                                                    hover:bg-gray-700 hover:text-white transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>

            <div class="p-4 sm:p-8">
                <div id="module-admin" class="module hidden max-w-2xl mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-6">Admin Configuration</h1>
                    <div class="bg-gray-800 shadow-xl rounded-lg p-6">
                        <form id="admin-form">
                            <label for="xpiBaseUrl" class="block text-sm font-medium text-gray-300 mb-2">XPI Base URL</label>
                            <input type="url" id="xpiBaseUrl-input" name="xpiBaseUrl" required
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 
                                          focus:ring-blue-500 focus:border-blue-500 focus:outline-none">
                            <p class="text-xs text-gray-400 mt-2">The Base URL for all XPI API calls.</p>
                            <button type="submit" class="mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700
                                                        disabled:bg-gray-500 transition">
                                Save Configuration
                            </button>
                            <p id="admin-save-feedback" class="text-green-400 text-sm mt-3"></p>
                        </form>
                    </div>
                </div>

                <div id="module-login" class="module hidden">
                    <div class="min-h-[80vh] flex items-center justify-center">
                        <div id="login-container" class="bg-gray-800 shadow-xl rounded-lg p-8 w-full max-w-md text-center">
                            </div>
                    </div>
                </div>

                <div id="module-campaign" class="module hidden max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-6">Create New Campaign</h1>
                    <form id="campaign-form" class="bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                        <input type="hidden" name="type" value="Campaign Request">
                        <input type="hidden" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" name="entity" value="Campaign">
                        <input type="hidden" name="varientId" value="1">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="campaignname" class="block text-sm font-medium text-gray-300 mb-2">Campaign Name</label>
                                <input type="text" id="campaignname" name="campaignname" value="World Pinball Day 7000" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="client" class="block text-sm font-medium text-gray-300 mb-2">Client</label>
                                <select id="client" name="client" required class="form-input">
                                    <option value="">Loading clients...</option>
                                </select>
                            </div>

                            <div>
                                <label for="debtor" class="block text-sm font-medium text-gray-300 mb-2">Debtor</label>
                                <select id="debtor" name="debtor" required class="form-input">
                                    <option value="">Loading debtors...</option>
                                </select>
                            </div>

                            <div>
                                <label for="agency" class="block text-sm font-medium text-gray-300 mb-2">Agency</label>
                                <select id="agency" name="agency" required class="form-input">
                                    <option value="">Loading agencies...</option>
                                </select>
                            </div>

                            <div>
                                <label for="brand" class="block text-sm font-medium text-gray-300 mb-2">Brand</label>
                                <input type="text" id="brand" name="brand" value="World Pinball" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="pod" class="block text-sm font-medium text-gray-300 mb-2">Pod</label>
                                <input type="text" id="pod" name="pod" value="Pod 1A" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-300 mb-2">Currency</label>
                                <input type="text" id="currency" name="currency" value="SGD" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="requestedstartdate" class="block text-sm font-medium text-gray-300 mb-2">Requested Start Date</label>
                                <input type="date" id="requestedstartdate" name="requestedstartdate" value="2026-07-01" required
                                       class="form-input" style="color-scheme: dark;">
                            </div>
                            
                            <div>
                                <label for="campaignstartdate" class="block text-sm font-medium text-gray-300 mb-2">Campaign Start Date</label>
                                <input type="date" id="campaignstartdate" name="campaignstartdate" value="2026-08-29" required
                                       class="form-input" style="color-scheme: dark;">
                            </div>

                            <div>
                                <label for="campaignenddate" class="block text-sm font-medium text-gray-300 mb-2">Campaign End Date</label>
                                <input type="date" id="campaignenddate" name="campaignenddate" value="2026-10-29" required
                                       class="form-input" style="color-scheme: dark;">
                            </div>

                            <div>
                                <label for="campaignobjective" class="block text-sm font-medium text-gray-300 mb-2">Campaign Objective</label>
                                <input type="text" id="campaignobjective" name="campaignobjective" value="Upper Funnel / Awareness" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="requestormarket" class="block text-sm font-medium text-gray-300 mb-2">Requestor Market</label>
                                <input type="text" id="requestormarket" name="requestormarket" value="Singapore" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="overallbudget" class="block text-sm font-medium text-gray-300 mb-2">Overall Budget</label>
                                <input type="number" id="overallbudget" name="overallbudget" value="100" required
                                       class="form-input">
                            </div>

                            <div>
                                <label for="optin" class="block text-sm font-medium text-gray-300 mb-2">Opt-in</label>
                                <select id="optin" name="optin" required class="form-input">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>

                            <div>
                                <label for="porequired" class="block text-sm font-medium text-gray-300 mb-2">PO Required</label>
                                <select id="porequired" name="porequired" required class="form-input">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>

                            <div class="md:col-span-2">
                                <label for="selectedchannels" class="block text-sm font-medium text-gray-300 mb-2">Selected Channels (comma-separated)</label>
                                <input type="text" id="selectedchannels" name="selectedchannels" value="Twitter" required
                                       class="form-input" placeholder="e.g. Twitter, Facebook, Google">
                            </div>
                        </div>

                        <div class="mt-8 text-right">
                            <button type="submit" id="campaign-submit-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md 
                                                       hover:bg-blue-700 disabled:bg-gray-500 transition-all">
                                Submit Campaign
                            </button>
                        </div>
                    </form>

                    <div id="campaign-result-container" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-white mb-2">Submission Result</h3>
                        <pre id="campaign-result-pre" class="bg-gray-800 p-4 rounded-md overflow-x-auto text-sm"></pre>
                    </div>

                </div>
            </div>
        </main>

        <button id="dev-tool-toggle" class="fixed bottom-6 right-6 z-40 p-3 bg-indigo-600 text-white rounded-full shadow-lg
                                           hover:bg-indigo-700 transition-all">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                <path d="M12 6c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                <path d="M5.64 16.36c-.49.49-1.28.49-1.77 0s-.49-1.28 0-1.77l1.77-1.77c.49-.49 1.28-.49 1.77 0s.49 1.28 0 1.77l-1.77 1.77zm12.72 0c.49.49 1.28.49 1.77 0s.49-1.28 0-1.77l-1.77-1.77c-.49-.49-1.28-.49-1.77 0s-.49 1.28 0 1.77l1.77 1.77z"/>
                <path d="M12 20.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5z"/>
                <path d="M12 5.5c-.83 0-1.5-.67-1.5-1.5S11.17 2.5 12 2.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                <path d="M3.5 12.5c0-.83-.67-1.5-1.5-1.5S.5 11.67.5 12.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5z"/>
                <path d="M20.5 12.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5z"/>
            </svg>
        </button>

        <div id="dev-tool-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-800 shadow-2xl rounded-lg w-[80%] h-[80%] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 class="text-xl font-semibold text-white">Developer Tool: API Logs</h2>
                    <div>
                        <button id="dev-tool-purge" class="p-2 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded-md transition-all" title="Purge All Logs">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <button id="dev-tool-close" class="ml-2 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-all" title="Close">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex-grow p-4 overflow-auto">
                    <table class="min-w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="p-3">Timestamp</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Method</th>
                                <th class="p-3">URL</th>
                                <th class="p-3">Request</th>
                                <th class="p-3">Response</th>
                            </tr>
                        </thead>
                        <tbody id="dev-tool-log-body" class="divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="payload-modal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center hidden">
            <div class="bg-gray-800 shadow-2xl rounded-lg w-2/3 max-w-4xl h-3/4 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 class="text-lg font-semibold text-white">Payload Viewer</h2>
                    <button id="payload-modal-close" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-all" title="Close">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="flex-grow p-4 overflow-auto">
                    <pre id="payload-content" class="text-sm text-gray-200 whitespace-pre-wrap break-all"></pre>
                </div>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. CONFIGURATION & CONSTANTS ---

        const MODULE_CONFIG = {
            'MOD.A': { name: 'Admin', type: 'Built-in', hash: '#admin' },
            'MOD.B': { name: 'Login', type: 'Built-in', hash: '#login' },
            'MOD.C': { name: 'Campaign Submission', type: 'User-defined', hash: '#campaign' }
        };

        const STORAGE_KEYS = {
            baseUrl: 'xpiBaseUrl',
            token: 'xpiToken',
            username: 'xpiUsername',
            password: 'xpiPassword',
            firstName: 'xpiFirstName',
            lastName: 'xpiLastName',
            avatarUrl: 'xpiAvatarUrl',
            clientId: 'xpiOAuthClientId',
            apiLogs: 'xpiApiLogs'
        };

        // --- 2. DOM ELEMENT SELECTORS ---
        const dom = {
            navbar: document.getElementById('navbar'),
            navToggleOpen: document.getElementById('nav-toggle-btn-open'),
            navToggleClose: document.getElementById('nav-toggle-btn-close'),
            navLinks: document.getElementById('nav-links'),
            profileArea: document.getElementById('profile-area'),
            profileAvatar: document.getElementById('profile-avatar'),
            profileName: document.getElementById('profile-name'),
            logoutLink: document.getElementById('logout-link'),
            mainContent: document.getElementById('main-content'),
            
            // Modules
            moduleAdmin: document.getElementById('module-admin'),
            moduleLogin: document.getElementById('module-login'),
            moduleCampaign: document.getElementById('module-campaign'),

            // Admin Module
            adminForm: document.getElementById('admin-form'),
            adminInput: document.getElementById('xpiBaseUrl-input'),
            adminFeedback: document.getElementById('admin-save-feedback'),

            // Login Module
            loginContainer: document.getElementById('login-container'),
            
            // Campaign Module
            campaignForm: document.getElementById('campaign-form'),
            campaignSubmitBtn: document.getElementById('campaign-submit-btn'),
            campaignResultContainer: document.getElementById('campaign-result-container'),
            campaignResultPre: document.getElementById('campaign-result-pre'),

            // Dev Tool
            devToolToggle: document.getElementById('dev-tool-toggle'),
            devToolModal: document.getElementById('dev-tool-modal'),
            devToolClose: document.getElementById('dev-tool-close'),
            devToolPurge: document.getElementById('dev-tool-purge'),
            devToolLogBody: document.getElementById('dev-tool-log-body'),

            // Payload Modal
            payloadModal: document.getElementById('payload-modal'),
            payloadModalClose: document.getElementById('payload-modal-close'),
            payloadContent: document.getElementById('payload-content')
        };
        
        // Add shared form input styles
        const formInputClasses = 'w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none disabled:bg-gray-600 disabled:opacity-70';
        document.querySelectorAll('.form-input').forEach(el => el.classList.add(...formInputClasses.split(' ')));


        // --- 3. LOCALSTORAGE HELPERS ---

        const getStorage = (key, defaultValue = null) => {
            return localStorage.getItem(key) || defaultValue;
        };
        
        const setStorage = (key, value) => {
            localStorage.setItem(key, value);
        };
        
        const removeStorage = (key) => {
            localStorage.removeItem(key);
        };

        const getApiLogs = () => {
            return JSON.parse(getStorage(STORAGE_KEYS.apiLogs, '[]'));
        };

        const logApiCall = async (method, url, status, requestPayload, responsePayload) => {
            try {
                const logs = getApiLogs();
                const newLog = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    method,
                    url,
                    status,
                    request: requestPayload,
                    response: responsePayload
                };
                logs.unshift(newLog); // Add to the beginning
                if (logs.length > 100) logs.pop(); // Limit to 100 logs
                setStorage(STORAGE_KEYS.apiLogs, JSON.stringify(logs));
                
                // If dev tool is open, refresh it
                if (!dom.devToolModal.classList.contains('hidden')) {
                    renderDevLogs();
                }
            } catch (e) {
                console.error("Failed to log API call:", e);
            }
        };

        // --- 4. API & AUTH HELPERS ---

        /**
         * Generic API fetch wrapper
         * @param {string} url - The full URL to fetch
         * @param {object} options - The options for fetch()
         * @param {string} authType - 'bearer', 'basic', or 'none'
         * @param {object} requestPayload - The body of the request (for logging)
         * @returns {Promise<object>} - { data, error, errorData, status }
         */
        const apiFetch = async (url, options, authType = 'bearer', requestPayload = null) => {
            const headers = new Headers(options.headers || {});
            
            // Add Authorization header based on authType
            if (authType === 'bearer') {
                const token = getStorage(STORAGE_KEYS.token);
                if (token) headers.set('Authorization', `Bearer ${token}`);
            } else if (authType === 'basic') {
                const username = getStorage(STORAGE_KEYS.username);
                const password = getStorage(STORAGE_KEYS.password);
                if (username && password) {
                    headers.set('Authorization', `Basic ${btoa(`${username}:${password}`)}`);
                }
            }
            options.headers = headers;

            let response, data, errorData;
            let status = 0;

            try {
                response = await fetch(url, options);
                status = response.status;
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }

                if (!response.ok) {
                    errorData = data;
                    data = null;
                }
            } catch (error) {
                console.error('API Fetch Error:', error);
                errorData = { message: error.message, isNetworkError: true };
                data = null;
            }

            // Log the API call
            logApiCall(options.method || 'GET', url, status, requestPayload, data || errorData);

            return { data, error: !data, errorData, status };
        };

        const getApi = (url, authType = 'bearer') => {
            return apiFetch(url, { method: 'GET' }, authType);
        };

        const postApi = (url, body, authType = 'bearer') => {
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            };
            return apiFetch(url, options, authType, body);
        };

        /**
         * Generates a SHA-256 hash and returns the last 7 hex chars
         */
        const generateClientId = async () => {
            const data = `${Date.now()}-${Math.random()}`;
            const encoder = new TextEncoder();
            const buffer = await crypto.subtle.digest('SHA-256', encoder.encode(data));
            const hashArray = Array.from(new Uint8Array(buffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash.slice(-7);
        };

        // --- 5. UI & ROUTING ---

        const showModule = (moduleId) => {
            [dom.moduleAdmin, dom.moduleLogin, dom.moduleCampaign].forEach(module => {
                if (module.id === `module-${moduleId}`) {
                    module.classList.remove('hidden');
                } else {
                    module.classList.add('hidden');
                }
            });
        };

        const updateUiForLoginState = (isLoggedIn) => {
            if (isLoggedIn) {
                // Show nav and profile
                dom.navbar.classList.remove('hidden');
                dom.navToggleOpen.classList.remove('hidden');
                dom.profileArea.classList.remove('hidden');

                // Populate profile
                dom.profileAvatar.src = getStorage(STORAGE_KEYS.avatarUrl, 'https://via.placeholder.com/40');
                dom.profileName.textContent = `${getStorage(STORAGE_KEYS.firstName, 'User')} ${getStorage(STORAGE_KEYS.lastName, '')}`;

                // Build nav links
                dom.navLinks.innerHTML = ''; // Clear existing
                Object.values(MODULE_CONFIG).forEach(mod => {
                    if (mod.type === 'User-defined') {
                        const link = document.createElement('a');
                        link.href = mod.hash;
                        link.className = `block p-4 text-sm hover:bg-gray-700 transition-all ${window.location.hash === mod.hash ? 'bg-gray-900 text-white font-semibold' : ''}`;
                        link.textContent = mod.name;
                        dom.navLinks.appendChild(link);
                    }
                });
            } else {
                // Hide nav and profile
                dom.navbar.classList.add('hidden', '-translate-x-full');
                dom.navToggleOpen.classList.add('hidden');
                dom.profileArea.classList.add('hidden');
                dom.mainContent.classList.remove('md:ml-64');
            }
        };

        const handleRouting = () => {
            const hash = window.location.hash;
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const isLoggedIn = !!getStorage(STORAGE_KEYS.token);
            
            updateUiForLoginState(isLoggedIn);

            if (hash === '#admin') {
                showModule('admin');
                initAdminModule();
            } else if (code) {
                showModule('login');
                initLoginModule(code);
            } else if (isLoggedIn) {
                // Default to campaign module if logged in and no other hash
                const targetHash = hash || MODULE_CONFIG['MOD.C'].hash;
                const activeModule = Object.values(MODULE_CONFIG).find(m => m.hash === targetHash);
                
                if (activeModule && activeModule.type === 'User-defined') {
                    if (window.location.hash !== activeModule.hash) {
                         window.location.hash = activeModule.hash; // Set default hash
                         return; // Routing will re-trigger
                    }
                    showModule('campaign');
                    initCampaignModule();
                } else {
                    // Fallback to default campaign module
                    window.location.hash = MODULE_CONFIG['MOD.C'].hash;
                }
            } else {
                showModule('login');
                initLoginModule(null); // No code, show auth mode
            }
            
            // Highlight active nav link
            document.querySelectorAll('#nav-links a').forEach(a => {
                if (a.getAttribute('href') === window.location.hash) {
                    a.classList.add('bg-gray-900', 'text-white', 'font-semibold');
                } else {
                    a.classList.remove('bg-gray-900', 'text-white', 'font-semibold');
                }
            });
        };

        // --- 6. MODULE INITIALIZATION ---

        // A. Admin Module
        const initAdminModule = () => {
            dom.adminInput.value = getStorage(STORAGE_KEYS.baseUrl, 'https://api.wrikexpi.groupm.com');
            dom.adminForm.onsubmit = (e) => {
                e.preventDefault();
                setStorage(STORAGE_KEYS.baseUrl, dom.adminInput.value);
                dom.adminFeedback.textContent = 'Configuration saved!';
                setTimeout(() => dom.adminFeedback.textContent = '', 3000);
            };
        };

        // B. Login Module
        const initLoginModule = (code) => {
            if (code) {
                // Mode 2: OAuth Callback
                dom.loginContainer.innerHTML = `
                    <div class="flex justify-center mb-4"><div class="spinner"></div></div>
                    <p class="text-lg font-semibold text-white">Authenticating...</p>
                    <p class="text-sm text-gray-400">Please wait while we verify your credentials.</p>
                `;
                handleOAuthCallback(code);
            } else {
                // Mode 1: Authentication
                dom.loginContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-6">Welcome to XPI Portal</h2>
                    <p class="text-gray-400 mb-8">Please log in to continue.</p>
                    <button id="login-redirect-btn" class="${formInputClasses} w-full bg-blue-600 font-semibold hover:bg-blue-700 transition">
                        Login & Authenticate
                    </button>
                `;
                document.getElementById('login-redirect-btn').onclick = handleLoginRedirect;
            }
        };

        // C. Campaign Module
        const initCampaignModule = async () => {
            // This module is only loaded if user is logged in, so Basic Auth creds exist.
            const baseUrl = getStorage(STORAGE_KEYS.baseUrl);

            const loadDropdown = async (elementId, endpoint) => {
                const select = document.getElementById(elementId);
                select.disabled = true;
                const { data, error, errorData } = await getApi(`${baseUrl}/${endpoint}`, 'basic');
                
                if (error) {
                    console.error(`Failed to load ${elementId}:`, errorData);
                    select.innerHTML = `<option value="">Error loading data</option>`;
                    return;
                }
                
                const defaultValue = dom.campaignForm.elements[elementId].value;
                select.innerHTML = ''; // Clear "Loading..."
                data.value.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.value;
                    if (item.value === defaultValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                select.disabled = false;
            };

            // Load all dropdowns in parallel
            await Promise.all([
                loadDropdown('client', 'api/v1/wrikexpi/v1.0/value/clients-grm-mys'),
                loadDropdown('debtor', 'api/v1/wrikexpi/v1.0/value/debtors-grm-mys'),
                loadDropdown('agency', 'api/v1/wrikexpi/v1.0/value/agencies')
            ]);
            
            dom.campaignForm.onsubmit = handleCampaignSubmit;
        };
        
        // --- 7. CORE LOGIC HANDLERS ---

        const handleLoginRedirect = async () => {
            const btn = document.getElementById('login-redirect-btn');
            btn.disabled = true;
            btn.textContent = 'Redirecting...';

            try {
                const clientId = await generateClientId();
                setStorage(STORAGE_KEYS.clientId, clientId);
                
                const baseUrl = getStorage(STORAGE_KEYS.baseUrl, 'https://api.wrikexpi.groupm.com');
                const redirectUri = window.location.origin + window.location.pathname;
                
                const authUrl = `${baseUrl}/?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${clientId}`;
                
                // Redirect
                window.location.href = authUrl;
            } catch (error) {
                dom.loginContainer.innerHTML += `<p class="text-red-400 text-sm mt-4">Error: ${error.message}</p>`;
                btn.disabled = false;
                btn.textContent = 'Login & Authenticate';
            }
        };

        const handleOAuthCallback = async (code) => {
            const clientId = getStorage(STORAGE_KEYS.clientId);
            const baseUrl = getStorage(STORAGE_KEYS.baseUrl);

            const showError = (message, response = null) => {
                dom.loginContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Login Failed</h2>
                    <p class="text-gray-300 mb-6">${message}</p>
                    ${response ? `<pre class="bg-gray-900 text-left text-xs text-red-300 p-4 rounded-md overflow-auto max-h-60">
${JSON.stringify(response, null, 2)}
</pre>` : ''}
                    <button id="start-over-btn" class="${formInputClasses} w-full bg-blue-600 font-semibold hover:bg-blue-700 transition mt-6">
                        Start Over
                    </button>
                `;
                document.getElementById('start-over-btn').onclick = () => window.location.href = window.location.pathname;
            };

            if (!clientId || !code) {
                showError('Missing authentication code or client ID. Your session may have expired.');
                setTimeout(() => {
                    if (document.getElementById('start-over-btn')) { // Check if user hasn't already clicked
                        window.location.href = window.location.pathname;
                    }
                }, 10000);
                return;
            }

            try {
                // 1. Exchange code for token
                const tokenUrl = `${baseUrl}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                const tokenRes = await getApi(tokenUrl, 'none'); // No auth for this call

                if (tokenRes.error || !tokenRes.data.success) {
                    showError('An unexpected technical error occurred during login.', tokenRes.errorData || tokenRes.data);
                    return;
                }

                const { token, credentials } = tokenRes.data.data;
                setStorage(STORAGE_KEYS.token, token);
                setStorage(STORAGE_KEYS.username, credentials.username);
                setStorage(STORAGE_KEYS.password, credentials.password);
                
                // 2. Verify credentials by getting profile
                const profileUrl = `${baseUrl}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`;
                const profileRes = await getApi(profileUrl, 'basic'); // Use Basic Auth now

                if (profileRes.error || !profileRes.data.success || !profileRes.data.data.length) {
                    // Clear failed creds
                    handleLogout(); 
                    showError('Login failed, we are unable to verify your account. Please try again.', profileRes.errorData || profileRes.data);
                    return;
                }

                // 3. Success! Store profile and redirect
                const user = profileRes.data.data[0];
                setStorage(STORAGE_KEYS.firstName, user.firstName);
                setStorage(STORAGE_KEYS.lastName, user.lastName);
                setStorage(STORAGE_KEYS.avatarUrl, user.avatarUrl);
                
                removeStorage(STORAGE_KEYS.clientId); // Clean up client ID

                dom.loginContainer.innerHTML = `
                    <h2 class="text-2xl font-bold text-green-400 mb-4">Success!</h2>
                    <p class="text-gray-300 text-lg">
                        ${user.firstName} ${user.lastName} logged in successfully.
                    </p>
                    <p class="text-gray-400 mt-4">Redirecting you to the portal...</p>
                `;
                
                setTimeout(() => {
                    // Redirect to base URL + campaign hash
                    window.location.href = window.location.pathname + MODULE_CONFIG['MOD.C'].hash;
                }, 2000);

            } catch (error) {
                showError('A critical error occurred.', { message: error.message });
            }
        };

        const handleCampaignSubmit = async (e) => {
            e.preventDefault();
            dom.campaignSubmitBtn.disabled = true;
            dom.campaignSubmitBtn.textContent = 'Submitting...';
            dom.campaignResultContainer.classList.add('hidden');

            try {
                const formData = new FormData(dom.campaignForm);
                const data = Object.fromEntries(formData.entries());

                // Parse channels
                const parsedChannels = data.selectedchannels
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean); // Filter out empty strings

                // Construct the payload
                const payload = {
                    type: data.type,
                    space: data.space,
                    entity: data.entity,
                    varientId: parseInt(data.varientId, 10),
                    fields: {
                        requestedstartdate: data.requestedstartdate,
                        agency: data.agency,
                        brand: data.brand,
                        client: data.client,
                        debtor: data.debtor,
                        currency: data.currency,
                        pod: data.pod,
                        campaignname: data.campaignname,
                        campaignstartdate: data.campaignstartdate,
                        campaignenddate: data.campaignenddate,
                        campaignobjective: data.campaignobjective,
                        requestormarket: data.requestormarket,
                        optin: data.optin,
                        porequired: data.porequired,
                        overallbudget: parseFloat(data.overallbudget), // Use parseFloat for budget
                        selectedchannels: parsedChannels
                    }
                };

                const baseUrl = getStorage(STORAGE_KEYS.baseUrl);
                const url = `${baseUrl}/api/v1/wrikexpi/campaign`;
                
                // Submit using Bearer token
                const { data: responseData, error, errorData } = await postApi(url, payload, 'bearer');

                if (error) {
                    dom.campaignResultPre.className = 'bg-gray-900 p-4 rounded-md overflow-x-auto text-sm text-red-400';
                    dom.campaignResultPre.textContent = `HTTP Error: ${errorData.status || 'Unknown'}\n\n${JSON.stringify(errorData, null, 2)}`;
                } else {
                    dom.campaignResultPre.className = 'bg-gray-900 p-4 rounded-md overflow-x-auto text-sm text-green-400';
                    dom.campaignResultPre.textContent = JSON.stringify(responseData, null, 2);
                }
                dom.campaignResultContainer.classList.remove('hidden');

            } catch (err) {
                dom.campaignResultPre.className = 'bg-gray-900 p-4 rounded-md overflow-x-auto text-sm text-red-400';
                dom.campaignResultPre.textContent = `Something went wrong, please try again.\n\n${err.message}`;
                dom.campaignResultContainer.classList.remove('hidden');
            } finally {
                dom.campaignSubmitBtn.disabled = false;
                dom.campaignSubmitBtn.textContent = 'Submit Campaign';
            }
        };

        const handleLogout = () => {
            Object.values(STORAGE_KEYS).forEach(key => {
                // Don't clear logs or base URL on logout, only session data
                if (key !== STORAGE_KEYS.apiLogs && key !== STORAGE_KEYS.baseUrl) {
                    removeStorage(key);
                }
            });
            window.location.href = window.location.pathname; // Reload to login
        };
        
        // --- 8. DEV TOOL & MODAL LOGIC ---

        const renderDevLogs = () => {
            const logs = getApiLogs();
            dom.devToolLogBody.innerHTML = ''; // Clear existing
            
            if (logs.length === 0) {
                dom.devToolLogBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No API logs recorded.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const statusColor = log.status >= 400 ? 'text-red-400' : log.status >= 300 ? 'text-yellow-400' : 'text-green-400';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition-colors';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="p-3 font-semibold ${statusColor}">${log.status || '-'}</td>
                    <td class="p-3 font-semibold">${log.method}</td>
                    <td class="p-3 max-w-xs truncate" title="${log.url}">${log.url.replace(getStorage(STORAGE_KEYS.baseUrl, ''), '...')}</td>
                    <td class="p-3">
                        ${log.request ? `<a href="#" class="text-blue-400 hover:underline" data-payload-type="request" data-log-id="${log.id}">View</a>` : '-'}
                    </td>
                    <td class="p-3">
                        ${log.response ? `<a href="#" class="text-blue-400 hover:underline" data-payload-type="response" data-log-id="${log.id}">View</a>` : '-'}
                    </td>
                `;
                dom.devToolLogBody.appendChild(row);
            });
        };

        const showPayloadModal = (payload) => {
            try {
                // Try to pretty-print if it's JSON
                const parsed = JSON.parse(payload);
                dom.payloadContent.textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                // Otherwise, show as text
                dom.payloadContent.textContent = payload;
            }
            dom.payloadModal.classList.remove('hidden');
        };

        const handleDevLogClick = (e) => {
            if (e.target.tagName === 'A' && e.target.dataset.logId) {
                e.preventDefault();
                const logId = parseInt(e.target.dataset.logId, 10);
                const payloadType = e.target.dataset.payloadType;
                const logs = getApiLogs();
                const log = logs.find(l => l.id === logId);

                if (log) {
                    const payload = log[payloadType];
                    showPayloadModal(typeof payload === 'object' ? JSON.stringify(payload, null, 2) : payload);
                }
            }
        };

        const purgeDevLogs = () => {
            if (confirm('Are you sure you want to purge all API logs?')) {
                setStorage(STORAGE_KEYS.apiLogs, '[]');
                renderDevLogs();
            }
        };

        const toggleNav = (forceOpen = null) => {
            const isOpen = !dom.navbar.classList.contains('-translate-x-full');
            if (forceOpen === true || (forceOpen === null && !isOpen)) {
                // Open
                dom.navbar.classList.remove('-translate-x-full');
                dom.mainContent.classList.add('md:ml-64');
            } else {
                // Close
                dom.navbar.classList.add('-translate-x-full');
                dom.mainContent.classList.remove('md:ml-64');
            }
        };

        // --- 9. EVENT LISTENERS ---

        // Navigation
        dom.navToggleOpen.onclick = () => toggleNav(true);
        dom.navToggleClose.onclick = () => toggleNav(false);
        dom.logoutLink.onclick = handleLogout;
        window.addEventListener('hashchange', handleRouting);

        // Dev Tool
        dom.devToolToggle.onclick = () => {
            dom.devToolModal.classList.remove('hidden');
            renderDevLogs();
        };
        dom.devToolClose.onclick = () => dom.devToolModal.classList.add('hidden');
        dom.devToolPurge.onclick = purgeDevLogs;
        dom.devToolLogBody.addEventListener('click', handleDevLogClick);

        // Payload Modal
        dom.payloadModalClose.onclick = () => dom.payloadModal.classList.add('hidden');
        dom.payloadModal.onclick = (e) => {
            if (e.target === dom.payloadModal) dom.payloadModal.classList.add('hidden');
        };

        // --- 10. APP INITIALIZATION ---

        const initApp = () => {
            // Set default base URL if not present
            if (!getStorage(STORAGE_KEYS.baseUrl)) {
                setStorage(STORAGE_KEYS.baseUrl, 'https://api.wrikexpi.groupm.com');
            }
            handleRouting();
        };

        initApp();
    });
    </script>

</body>
</html>