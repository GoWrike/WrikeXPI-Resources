<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Submission Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            750: '#2d3748', // A slightly lighter dark
                            850: '#1a202c', // A slightly darker dark
                            950: '#111827', // Even darker
                        }
                    }
                },
            },
            darkMode: 'class', // We'll force dark mode
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        /* Force dark mode */
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            /* Use a gradient for a more premium feel, like Netflix/Amazon */
            background-color: #111827; /* bg-gray-950 */
            color: #f3f4f6; /* text-gray-100 */
        }
        
        /* Custom spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #3b82f6; /* blue-500 */
            animation: spin 1s linear infinite;
        }
        
        /* Custom styled form inputs for dark mode */
        .form-input, .form-select {
            @apply w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-inner text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out;
        }
        
        .form-select {
            @apply appearance-none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        /* Primary button style */
        .btn-primary {
            @apply w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        
        /* Secondary/danger button style */
        .btn-secondary {
            @apply w-full px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-200 ease-in-out;
        }
        
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* Transition classes for sidebar */
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
    </style>
</head>

<body class="h-full font-sans antialiased">
    <!-- Main App Container -->
    <div id="app" class="flex h-screen overflow-hidden">
        <!-- This will be dynamically rendered by JavaScript -->
    </div>

    <!-- Main Application Logic -->
    <script type="module">
        // --- STATE ---
        const appState = {
            sidebarOpen: true,
            user: null, // { firstName, lastName }
            isAuthenticated: false,
            currentModule: 'login', // 'login' or 'campaign'
        };

        const appContainer = document.getElementById('app');

        // --- UTILITY FUNCTIONS ---

        /**
         * Generates a SHA-256 hash of a string.
         * @param {string} str - The input string.
         * @returns {Promise<string>} The hex-encoded hash.
         */
        async function sha256(str) {
            const textAsBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        /**
         * Checks localStorage for auth data and updates app state.
         */
        function checkAuthState() {
            const token = localStorage.getItem('token');
            const firstName = localStorage.getItem('firstName');
            const lastName = localStorage.getItem('lastName');
            
            if (token && firstName && lastName) {
                appState.isAuthenticated = true;
                appState.user = { firstName, lastName };
            } else {
                appState.isAuthenticated = false;
                appState.user = null;
            }
        }
        
        /**
         * Clears all auth data from localStorage and resets state.
         */
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('password');
            localStorage.removeItem('firstName');
            localStorage.removeItem('lastName');
            localStorage.removeItem('clientId');
            appState.isAuthenticated = false;
            appState.user = null;
            navigateTo('login');
        }
        
        /**
         * Gets the current base URL (without query params or hash).
         * @returns {string} The base URL.
         */
        function getBaseUrl() {
            return window.location.origin + window.location.pathname;
        }

        /**
         * Renders a message overlay.
         * @param {string} title - The title of the message.
         * @param {string} message - The message content (can be HTML).
         * @param {'success' | 'error' | 'info'} type - The message type.
         * @param {Function} [onClose] - Optional callback when closed.
         */
        function showMessage(title, message, type = 'info', onClose) {
            let bgColor, titleColor, buttonColor;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-600';
                    titleColor = 'text-green-100';
                    buttonColor = 'bg-green-700 hover:bg-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-600';
                    titleColor = 'text-red-100';
                    buttonColor = 'bg-red-700 hover:bg-red-800';
                    break;
                default:
                    bgColor = 'bg-blue-600';
                    titleColor = 'text-blue-100';
                    buttonColor = 'bg-blue-700 hover:bg-blue-800';
                    break;
            }

            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            overlay.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-2xl overflow-hidden max-w-lg w-full transform transition-all scale-95 opacity-0" style="transition-duration: 200ms;">
                    <div class="p-6 ${bgColor}">
                        <h3 class="text-2xl font-bold ${titleColor}">${title}</h3>
                    </div>
                    <div class="p-6 text-gray-200 text-base overflow-y-auto max-h-96">
                        ${message}
                    </div>
                    <div class="p-4 bg-gray-750 text-right">
                        <button class="close-btn px-6 py-2 ${buttonColor} text-white font-semibold rounded-lg shadow-md transition-all">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // For transition effect
            setTimeout(() => {
                overlay.firstElementChild.classList.remove('scale-95', 'opacity-0');
                overlay.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);

            overlay.querySelector('.close-btn').onclick = () => {
                overlay.firstElementChild.classList.add('scale-95', 'opacity-0');
                overlay.firstElementChild.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    if (onClose) onClose();
                }, 200);
            };
        }

        // --- NAVIGATION & ROUTING ---

        /**
         * Navigates to a specific module.
         * @param {string} moduleName - 'login' or 'campaign'.
         */
        function navigateTo(moduleName) {
            checkAuthState();
            
            if (moduleName !== 'login' && !appState.isAuthenticated) {
                appState.currentModule = 'login';
                window.location.hash = '#login';
            } else {
                appState.currentModule = moduleName;
                window.location.hash = `#${moduleName}`;
            }
            renderApp();
        }

        /**
         * Handles hash changes to navigate.
         */
        function handleHashChange() {
            const hash = window.location.hash.substring(1); // Remove '#'
            const validModules = ['login', 'campaign'];
            
            if (validModules.includes(hash)) {
                navigateTo(hash);
            } else {
                navigateTo('login'); // Default to login
            }
        }
        
        /**
         * Initial router setup.
         */
        function initializeRouter() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const hash = window.location.hash.substring(1);

            if (code) {
                // If there's a code, force login module to handle it
                appState.currentModule = 'login';
                renderApp();
            } else if (hash) {
                handleHashChange();
            } else {
                // Default view
                navigateTo('login');
            }
        }

        // --- RENDERING ---

        /**
         * Main application render function.
         */
        function renderApp() {
            const { sidebarOpen, user, isAuthenticated, currentModule } = appState;
            
            // Sidebar links
            const loginLinkClass = currentModule === 'login' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white';
            const campaignLinkClass = currentModule === 'campaign' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white';

            appContainer.innerHTML = `
                <!-- Sidebar -->
                <nav id="sidebar" class="absolute md:relative ${sidebarOpen ? 'sidebar-open' : 'sidebar-closed'} w-64 bg-gray-850 h-full flex-shrink-0 flex flex-col z-20 shadow-lg transition-transform duration-300 ease-in-out">
                    <!-- Brand/Logo -->
                    <div class="flex items-center justify-between h-16 px-4 bg-gray-950 shadow-md">
                        <span class="text-2xl font-bold text-white">Portal</span>
                        <!-- Close button for mobile -->
                        <button id="sidebar-close-btn" class="md:hidden text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-2">
                        <a href="#login" data-module="login" class="nav-link flex items-center px-4 py-3 rounded-lg ${loginLinkClass} transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1"></path></svg>
                            <span>Login</span>
                        </a>
                        ${isAuthenticated ? `
                        <a href="#campaign" data-module="campaign" class="nav-link flex items-center px-4 py-3 rounded-lg ${campaignLinkClass} transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>Campaign Form</span>
                        </a>
                        ` : `
                        <div class="flex items-center px-4 py-3 rounded-lg text-gray-500 cursor-not-allowed">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <span>Campaign Form</span>
                        </div>
                        `}
                    </div>
                    
                    <!-- Footer / Logout -->
                    ${isAuthenticated ? `
                    <div class="p-4 border-t border-gray-700">
                        <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-3 rounded-lg text-red-400 hover:bg-red-800 hover:text-red-100 transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1"></path></svg>
                            <span>Logout</span>
                        </button>
                    </div>
                    ` : ''}
                </nav>
                
                <!-- Main Content -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Header -->
                    <header class="bg-gray-900 h-16 flex-shrink-0 flex justify-between items-center px-6 shadow-md z-10">
                        <button id="sidebar-toggle-btn" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <div class="text-lg font-semibold text-gray-200">
                            ${user ? `Welcome, ${user.firstName} ${user.lastName}` : 'Campaign Submission Portal'}
                        </div>
                        <div>
                            <!-- Placeholder for other icons -->
                        </div>
                    </header>
                    
                    <!-- Content Area -->
                    <main id="content-area" class="flex-1 overflow-y-auto no-scrollbar p-4 md:p-8 lg:p-12">
                        <!-- Module content will be injected here -->
                    </main>
                </div>
            `;
            
            // Render the specific module
            const contentArea = document.getElementById('content-area');
            switch(currentModule) {
                case 'login':
                    renderLoginModule(contentArea);
                    break;
                case 'campaign':
                    renderCampaignModule(contentArea);
                    break;
                default:
                    contentArea.innerHTML = `<h1 class="text-3xl font-bold">Module not found.</h1>`;
            }

            // Attach event listeners
            attachGlobalListeners();
        }
        
        /**
         * Attaches event listeners for the main layout.
         */
        function attachGlobalListeners() {
            document.getElementById('sidebar-toggle-btn').addEventListener('click', () => {
                appState.sidebarOpen = !appState.sidebarOpen;
                document.getElementById('sidebar').classList.toggle('sidebar-open', appState.sidebarOpen);
                document.getElementById('sidebar').classList.toggle('sidebar-closed', !appState.sidebarOpen);
            });
            
            const closeBtn = document.getElementById('sidebar-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    appState.sidebarOpen = false;
                    document.getElementById('sidebar').classList.remove('sidebar-open');
                    document.getElementById('sidebar').classList.add('sidebar-closed');
                });
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const module = e.currentTarget.dataset.module;
                    if (module) navigateTo(module);
                });
            });
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
        }

        // --- MODULE A: LOGIN ---

        /**
         * Renders the Login module content.
         * @param {HTMLElement} container - The element to render into.
         */
        function renderLoginModule(container) {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                // Mode 2: OAuth Callback
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-full">
                        <div class="spinner"></div>
                        <h2 class="text-2xl font-semibold text-gray-300 mt-6">Authenticating...</h2>
                        <p class="text-gray-400 mt-2">Please wait while we verify your credentials.</p>
                    </div>
                `;
                handleLoginCallback(code);
            } else {
                // Mode 1: Authentication Button
                container.innerHTML = `
                    <div class="max-w-md mx-auto mt-10 md:mt-20 bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
                        <div class="p-8 md:p-12">
                            <h2 class="text-3xl font-bold text-center text-white mb-4">Welcome</h2>
                            <p class="text-center text-gray-300 mb-8">Please log in with your Wrike account to continue.</p>
                            <button id="login-btn" class="btn-primary text-lg">
                                Login & Authenticate
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('login-btn').addEventListener('click', handleLoginButton);
            }
        }

        /**
         * Mode 1: Generate clientId and redirect for OAuth.
         */
        async function handleLoginButton() {
            try {
                const timestamp = Date.now();
                const random = Math.random();
                const data = `${timestamp}${random}`;
                const hash = await sha256(data);
                const clientId = hash.slice(-7);
                
                localStorage.setItem('clientId', clientId);
                
                const redirectUri = getBaseUrl();
                const authUrl = `https://xpi-api.gowrike.space/?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${encodeURIComponent(clientId)}`;
                
                window.location.href = authUrl;
            } catch (error) {
                console.error('Failed to generate SHA-256 or redirect:', error);
                showMessage('Login Error', `An unexpected error occurred: ${error.message}`, 'error');
            }
        }

        /**
         * Mode 2: Handle the OAuth callback, exchange code for token.
         * @param {string} code - The authorization code from the URL.
         */
        async function handleLoginCallback(code) {
            const clientId = localStorage.getItem('clientId');
            const container = document.getElementById('content-area');
            
            // Clear the 'code' from URL
            window.history.replaceState({}, document.title, getBaseUrl() + window.location.hash);

            // Validation
            if (!clientId || !code) {
                const errorMsg = 'Authentication failed: Missing Client ID or Code. Please try logging in again.';
                container.innerHTML = `<h2 class="text-2xl text-red-400">${errorMsg}</h2><p class="text-gray-400 mt-4">Redirecting to login page...</p>`;
                setTimeout(() => {
                    window.location.href = getBaseUrl(); // Full redirect to clear state
                }, 10000);
                return;
            }

            // API Call 1: Exchange code for token
            try {
                const tokenUrl = `https://xpi-api.gowrike.space/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                const response1 = await fetch(tokenUrl);
                const data1 = await response1.json();

                if (!response1.ok || !data1.success) {
                    throw new Error(JSON.stringify(data1, null, 2));
                }

                // API 1 Success: Store credentials
                const { token, credentials } = data1.data;
                localStorage.setItem('token', token);
                localStorage.setItem('username', credentials.username);
                localStorage.setItem('password', credentials.password);
                
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-full">
                        <div class="spinner"></div>
                        <h2 class="text-2xl font-semibold text-gray-300 mt-6">Verifying Account...</h2>
                        <p class="text-gray-400 mt-2">Credentials received, checking user profile.</p>
                    </div>
                `;
                
                // API Call 2: Verify user profile
                try {
                    // Retrieve credentials for Basic Auth
                    const username = localStorage.getItem('username');
                    const password = localStorage.getItem('password');
                    
                    if (!username || !password) {
                        // This case should ideally not be hit if API 1 was successful, but good to check.
                        throw new Error("Credentials not found in storage for verification.");
                    }
                    
                    const basicAuth = 'Basic ' + btoa(`${username}:${password}`);
                    
                    const profileUrl = 'https://xpi-api.gowrike.space/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me';
                    const response2 = await fetch(profileUrl, {
                        headers: {
                            'Authorization': basicAuth // Use Basic Auth instead of Bearer
                        }
                    });
                    const data2 = await response2.json();

                    if (!response2.ok || !data2.success || !data2.data || data2.data.length === 0) {
                        throw new Error(JSON.stringify(data2, null, 2));
                    }
                    
                    // API 2 Success: Store user info and complete login
                    const user = data2.data[0];
                    localStorage.setItem('firstName', user.firstName);
                    localStorage.setItem('lastName', user.lastName);
                    
                    showMessage(
                        'Login Successful!',
                        `<p class="text-lg">Welcome, <strong>${user.firstName} ${user.lastName}</strong>!</p><p>You will be redirected to the campaign form shortly.</p>`,
                        'success',
                        () => navigateTo('campaign') // Navigate after user closes modal
                    );
                    
                    // Also auto-navigate after a delay
                    setTimeout(() => navigateTo('campaign'), 2000);

                } catch (verifyError) {
                    // API 2 Failed
                    logout(); // Clear partial login
                    showApiError(
                        container,
                        "Login failed, we are unable to verify your account. Please try again.",
                        verifyError.message
                    );
                }

            } catch (tokenError) {
                // API 1 Failed
                showApiError(
                    container,
                    "An unexpected technical error occurred during login.",
                    tokenError.message
                );
            }
        }
        
        /**
         * Helper to display API errors during login.
         * @param {HTMLElement} container - The element to render into.
         * @param {string} title - The error title.
         * @param {string} responseText - The full API response text.
         */
        function showApiError(container, title, responseText) {
            let formattedResponse = responseText;
            try {
                // Try to pretty-print if it's JSON
                formattedResponse = JSON.stringify(JSON.parse(responseText), null, 2);
            } catch (e) {
                // Not JSON, just use the text
            }
            
            container.innerHTML = `
                <div class="max-w-2xl mx-auto mt-10 bg-gray-800 rounded-xl shadow-2xl p-8">
                    <h2 class="text-3xl font-bold text-red-400 mb-4">${title}</h2>
                    <p class="text-gray-300 mb-6">The API returned the following response:</p>
                    <pre class="bg-gray-900 text-red-200 p-4 rounded-lg overflow-x-auto text-sm">${formattedResponse}</pre>
                    <button id="start-over-btn" class="btn-secondary text-lg mt-8">
                        Start Over
                    </button>
                </div>
            `;
            document.getElementById('start-over-btn').addEventListener('click', () => {
                window.location.href = getBaseUrl();
            });
        }

        // --- MODULE B: CAMPAIGN SUBMISSION ---

        /**
         * Renders the Campaign Submission module.
         * @param {HTMLElement} container - The element to render into.
         */
        function renderCampaignModule(container) {
            // Default values from cURL
            const defaults = {
                type: "Campaign Request",
                space: "GRM-MYS-GMN",
                entity: "Campaign",
                varientId: 1,
                fields: {
                    requestedstartdate: "2026-07-01",
                    agency: "Eightbar",
                    brand: "World Pinball",
                    client: "Adidas Group",
                    debtor: "Adidas Malaysia Sdn Bhd",
                    currency: "SGD",
                    pod: "Pod 1A",
                    campaignname: "World Pinball Day 7000",
                    campaignstartdate: "2026-08-29",
                    campaignenddate: "2026-10-29",
                    campaignobjective: "Upper Funnel / Awareness",
                    requestormarket: "Singapore",
                    optin: "No",
                    porequired: "No",
                    overallbudget: "100",
                    selectedchannels: "Twitter", // Will be parsed to array on submit
                }
            };

            // Field labels
            const labels = {
                requestedstartdate: "Requested Start Date",
                agency: "Agency",
                brand: "Brand",
                client: "Client",
                debtor: "Debtor",
                currency: "Currency",
                pod: "Pod",
                campaignname: "Campaign Name",
                campaignstartdate: "Campaign Start Date",
                campaignenddate: "Campaign End Date",
                campaignobjective: "Campaign Objective",
                requestormarket: "Requestor Market",
                optin: "Opt-in",
                porequired: "PO Required",
                overallbudget: "Overall Budget",
                selectedchannels: "Selected Channels (comma-separated)",
            };
            
            // Helper to create form fields
            const createField = (key, value) => {
                const label = labels[key] || key.charAt(0).toUpperCase() + key.slice(1);
                let inputHtml = '';
                
                if (key.includes('date')) {
                    inputHtml = `<input type="date" id="${key}" name="fields.${key}" value="${value}" class="form-input">`;
                } else if (key === 'overallbudget') {
                    inputHtml = `<input type="number" id="${key}" name="fields.${key}" value="${value}" class="form-input">`;
                } else if (key === 'optin' || key === 'porequired') {
                    inputHtml = `
                        <select id="${key}" name="fields.${key}" class="form-select">
                            <option value="No" ${value === 'No' ? 'selected' : ''}>No</option>
                            <option value="Yes" ${value === 'Yes' ? 'selected' : ''}>Yes</option>
                        </select>
                    `;
                } else if (key === 'client' || key === 'debtor' || key === 'agency') {
                    // Dropdowns will be populated by API
                    inputHtml = `
                        <select id="${key}" name="fields.${key}" class="form-select" disabled>
                            <option value="">Loading...</option>
                        </select>
                    `;
                } else {
                    inputHtml = `<input type="text" id="${key}" name="fields.${key}" value="${value}" class="form-input">`;
                }
                
                return `
                    <div class="col-span-1">
                        <label for="${key}" class="block text-sm font-medium text-gray-300 mb-2">${label}</label>
                        ${inputHtml}
                    </div>
                `;
            };
            
            // Build form fields
            let fieldsHtml = '';
            for (const [key, value] of Object.entries(defaults.fields)) {
                fieldsHtml += createField(key, value);
            }

            container.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-4xl font-bold text-white mb-8">New Campaign Request</h1>
                    
                    <form id="campaign-form" class="bg-gray-800 p-6 md:p-10 rounded-xl shadow-2xl space-y-8">
                        <!-- Hidden Fields -->
                        <input type="hidden" name="type" value="${defaults.type}">
                        <input type="hidden" name="space" value="${defaults.space}">
                        <input type="hidden" name="entity" value="${defaults.entity}">
                        <input type="hidden" name="varientId" value="${defaults.varientId}">
                        
                        <!-- Visible Fields Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${fieldsHtml}
                        </div>
                        
                        <!-- Submission & Result -->
                        <div class="pt-6 border-t border-gray-700">
                            <button type="submit" id="submit-btn" class="btn-primary text-lg w-full md:w-auto">
                                Submit Campaign
                            </button>
                            
                            <div id="form-result-wrapper" class="mt-6 hidden">
                                <h3 id="form-result-title" class="text-xl font-semibold mb-2"></h3>
                                <pre id="form-result" class="bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm"></pre>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            
            // Attach form listener
            document.getElementById('campaign-form').addEventListener('submit', handleCampaignSubmit);
            
            // Populate dynamic dropdowns
            populateDropdowns();
        }
        
        /**
         * Fetches data and populates the dropdowns for the campaign form.
         */
        async function populateDropdowns() {
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');
            
            if (!username || !password) {
                showMessage('Error', 'Credentials not found. Please log in again.', 'error', () => navigateTo('login'));
                return;
            }

            const basicAuth = 'Basic ' + btoa(`${username}:${password}`);
            const headers = { 'Authorization': basicAuth };

            const endpoints = {
                client: 'https://xpi-api.gowrike.space/api/v1/wrikexpi/v1.0/value/clients-grm-mys',
                debtor: 'https://xpi-api.gowrike.space/api/v1/wrikexpi/v1.0/value/debtors-grm-mys',
                agency: 'https://xpi-api.gowrike.space/api/v1/wrikexpi/v1.0/value/agencies'
            };
            
            const helper = async (id, url) => {
                const select = document.getElementById(id);
                try {
                    const response = await fetch(url, { headers });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    if (data && data.value && Array.isArray(data.value)) {
                        select.innerHTML = '<option value="">Select an option</option>';
                        data.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.value;
                            option.textContent = item.value;
                            select.appendChild(option);
                        });
                        select.disabled = false;
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } catch (error) {
                    console.error(`Failed to load ${id}:`, error);
                    select.innerHTML = '<option value="">Error loading data</option>';
                    select.disabled = true;
                }
            };
            
            // Fetch all dropdowns in parallel
            await Promise.all([
                helper('client', endpoints.client),
                helper('debtor', endpoints.debtor),
                helper('agency', endpoints.agency)
            ]);
        }
        
        /**
         * Handles the submission of the campaign form.
         * @param {Event} event - The form submit event.
         */
        async function handleCampaignSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const submitBtn = document.getElementById('submit-btn');
            const resultWrapper = document.getElementById('form-result-wrapper');
            const resultTitle = document.getElementById('form-result-title');
            const resultEl = document.getElementById('form-result');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            resultWrapper.classList.add('hidden');
            
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('Error', 'Authentication token missing. Please log in again.', 'error', () => navigateTo('login'));
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Campaign';
                return;
            }

            // Construct payload
            try {
                const formData = new FormData(form);
                const payload = {
                    type: formData.get('type'),
                    space: formData.get('space'),
                    entity: formData.get('entity'),
                    varientId: parseInt(formData.get('varientId'), 10),
                    fields: {}
                };
                
                // Populate the 'fields' object
                for (let [key, value] of formData.entries()) {
                    if (key.startsWith('fields.')) {
                        const fieldName = key.replace('fields.', '');
                        
                        if (fieldName === 'selectedchannels') {
                            // Parse comma-separated string into array
                            payload.fields[fieldName] = value.split(',')
                                .map(s => s.trim())
                                .filter(Boolean); // Filter out empty strings
                        } else {
                            payload.fields[fieldName] = value;
                        }
                    }
                }
                
                // API Call
                const response = await fetch('https://xpi-api.gowrike.space/api/v1/wrikexpi/campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const responseData = await response.json();
                const responseText = JSON.stringify(responseData, null, 2);

                if (response.ok) {
                    // Success
                    resultTitle.textContent = 'Campaign Submitted Successfully';
                    resultTitle.className = 'text-2xl font-semibold mb-2 text-green-400';
                    resultEl.className = 'bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm text-green-200';
                    resultEl.textContent = responseText;
                    showMessage('Success', 'Your campaign request has been submitted successfully.', 'success');
                    form.reset(); // Clear the form
                    populateDropdowns(); // Repopulate and set defaults
                } else {
                    // HTTP Error
                    resultTitle.textContent = `Error: ${response.status} ${response.statusText}`;
                    resultTitle.className = 'text-2xl font-semibold mb-2 text-red-400';
                    resultEl.className = 'bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm text-red-200';
                    resultEl.textContent = responseText;
                }
                resultWrapper.classList.remove('hidden');

            } catch (error) {
                // Network/CORS Error
                console.error('Submission error:', error);
                resultTitle.textContent = 'Submission Failed';
                resultTitle.className = 'text-2xl font-semibold mb-2 text-red-400';
                resultEl.className = 'bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm text-red-200';
                resultEl.textContent = `Something went wrong, please try again.\n${error.message}`;
                resultWrapper.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Campaign';
            }
        }

        // --- INITIALIZATION ---
        
        // Listen for hash changes to navigate
        window.addEventListener('hashchange', handleHashChange);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            initializeRouter();
        });

    </script>
</body>
</html>

