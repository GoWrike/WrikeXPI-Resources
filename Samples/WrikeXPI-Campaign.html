<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-full overflow-hidden">

    <!-- 
      App Layout: 
      This layout is for when the user is logged in or visiting #admin.
      It features the sidebar and the main content area.
    -->
    <div id="app-layout" class="hidden h-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 flex flex-col flex-shrink-0 transition-all duration-300">
            <!-- Logo/Title -->
            <div class="h-16 flex items-center justify-between px-6 flex-shrink-0">
                <h1 class="text-2xl font-bold text-white">XPI Portal</h1>
                <button id="sidebar-toggle-close" class="text-gray-400 hover:text-white lg:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto px-4 py-4 space-y-2">
                <a href="#/login" class="module-nav-link flex items-center px-4 py-2.5 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                    Login
                </a>
                <a href="#/campaign" class="module-nav-link flex items-center px-4 py-2.5 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Campaign Submission
                </a>
                <a href="#admin" class="module-nav-link flex items-center px-4 py-2.5 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Admin
                </a>
            </nav>
            
            <!-- User Profile -->
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center min-w-0"> <!-- Wrapper for truncation -->
                        <img id="user-avatar" src="https://placehold.co/40x40/374151/9ca3af?text=NA" alt="User Avatar" class="w-10 h-10 rounded-full object-cover bg-gray-700 flex-shrink-0">
                        <div class="ml-3 min-w-0">
                            <p id="user-name" class="text-sm font-medium text-white truncate">Not Logged In</p>
                            <p id="user-status" class="text-xs text-gray-400">User</p>
                        </div>
                    </div>
                    <button id="logout-button" class="hidden ml-2 text-gray-400 hover:text-white transition-colors flex-shrink-0" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Top bar with sidebar toggle -->
            <div class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-6 lg:hidden flex-shrink-0">
                <button id="sidebar-toggle-open" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl font-semibold text-white">XPI Portal</h1>
                <div class="w-6"></div> <!-- Spacer -->
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6 md:p-10">
                
                <!-- Module: Admin (MOD.A) -->
                <div id="module-admin" class="app-module hidden max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Admin Module</h2>
                    <div class="bg-gray-800 shadow-xl rounded-lg p-8">
                        <form id="admin-form">
                            <h3 class="text-xl font-semibold text-white mb-4">Global Configuration</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="xpiBaseUrl" class="block text-sm font-medium text-gray-300 mb-1">XPI Base URL</label>
                                    <input type="url" id="xpiBaseUrl" name="xpiBaseUrl" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="https://api.wrikexpi.groupm.com">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">Save Changes</button>
                            </div>
                            <div id="admin-feedback" class="mt-4 text-sm"></div>
                        </form>
                    </div>
                </div>

                <!-- Module: Campaign Submission (MOD.C) -->
                <div id="module-campaign" class="app-module hidden max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Campaign Submission</h2>
                    <form id="campaign-form" class="bg-gray-800 shadow-xl rounded-lg p-8">
                        <!-- Hidden fields -->
                        <input type="hidden" name="type" value="Campaign Request">
                        <input type="hidden" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" name="entity" value="Campaign">
                        <input type="hidden" name="varientId" value="1">
                        
                        <!-- Visible fields grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                            <!-- Field: requestedstartdate -->
                            <div>
                                <label for="requestedstartdate" class="block text-sm font-medium text-gray-300 mb-1">Requested Start Date</label>
                                <input type="date" id="requestedstartdate" name="requestedstartdate" value="2026-07-01" class="form-input">
                            </div>

                            <!-- Field: campaignname -->
                            <div>
                                <label for="campaignname" class="block text-sm font-medium text-gray-300 mb-1">Campaign Name</label>
                                <input type="text" id="campaignname" name="campaignname" value="World Pinball Day 7000" class="form-input">
                            </div>

                            <!-- Field: client -->
                            <div>
                                <label for="client" class="block text-sm font-medium text-gray-300 mb-1">Client</label>
                                <select id="client" name="client" class="form-input">
                                    <option value="">Loading clients...</option>
                                </select>
                            </div>

                            <!-- Field: debtor -->
                            <div>
                                <label for="debtor" class="block text-sm font-medium text-gray-300 mb-1">Debtor</label>
                                <select id="debtor" name="debtor" class="form-input">
                                    <option value="">Loading debtors...</option>
                                </select>
                            </div>

                            <!-- Field: agency -->
                            <div>
                                <label for="agency" class="block text-sm font-medium text-gray-300 mb-1">Agency</label>
                                <select id="agency" name="agency" class="form-input">
                                    <option value="">Loading agencies...</option>
                                </select>
                            </div>

                            <!-- Field: brand -->
                            <div>
                                <label for="brand" class="block text-sm font-medium text-gray-300 mb-1">Brand</label>
                                <input type="text" id="brand" name="brand" value="World Pinball" class="form-input">
                            </div>
                            
                            <!-- Field: currency -->
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-300 mb-1">Currency</label>
                                <input type="text" id="currency" name="currency" value="SGD" class="form-input">
                            </div>
                            
                            <!-- Field: pod -->
                            <div>
                                <label for="pod" class="block text-sm font-medium text-gray-300 mb-1">Pod</label>
                                <input type="text" id="pod" name="pod" value="Pod 1A" class="form-input">
                            </div>
                            
                            <!-- Field: campaignstartdate -->
                            <div>
                                <label for="campaignstartdate" class="block text-sm font-medium text-gray-300 mb-1">Campaign Start Date</label>
                                <input type="date" id="campaignstartdate" name="campaignstartdate" value="2026-08-29" class="form-input">
                            </div>
                            
                            <!-- Field: campaignenddate -->
                            <div>
                                <label for="campaignenddate" class="block text-sm font-medium text-gray-300 mb-1">Campaign End Date</label>
                                <input type="date" id="campaignenddate" name="campaignenddate" value="2026-10-29" class="form-input">
                            </div>
                            
                            <!-- Field: campaignobjective -->
                            <div>
                                <label for="campaignobjective" class="block text-sm font-medium text-gray-300 mb-1">Campaign Objective</label>
                                <input type="text" id="campaignobjective" name="campaignobjective" value="Upper Funnel / Awareness" class="form-input">
                            </div>
                            
                            <!-- Field: requestormarket -->
                            <div>
                                <label for="requestormarket" class="block text-sm font-medium text-gray-300 mb-1">Requestor Market</label>
                                <input type="text" id="requestormarket" name="requestormarket" value="Singapore" class="form-input">
                            </div>
                            
                            <!-- Field: optin -->
                            <div>
                                <label for="optin" class="block text-sm font-medium text-gray-300 mb-1">Opt-in</label>
                                <select id="optin" name="optin" class="form-input">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            
                            <!-- Field: porequired -->
                            <div>
                                <label for="porequired" class="block text-sm font-medium text-gray-300 mb-1">PO Required</label>
                                <select id="porequired" name="porequired" class="form-input">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            
                            <!-- Field: overallbudget -->
                            <div>
                                <label for="overallbudget" class="block text-sm font-medium text-gray-300 mb-1">Overall Budget</label>
                                <input type="number" id="overallbudget" name="overallbudget" value="100" class="form-input">
                            </div>
                            
                            <!-- Field: selectedchannels -->
                            <div>
                                <label for="selectedchannels" class="block text-sm font-medium text-gray-300 mb-1">Selected Channels (comma-separated)</label>
                                <input type="text" id="selectedchannels" name="selectedchannels-text" value="Twitter" class="form-input">
                            </div>
                        </div>

                        <!-- Submission -->
                        <div class="mt-8 pt-6 border-t border-gray-700">
                            <div class="flex justify-end">
                                <button type="submit" id="campaign-submit-btn" class="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-wait">
                                    Submit Campaign
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Result Section -->
                    <div id="campaign-result-wrapper" class="hidden mt-6">
                        <h3 class="text-xl font-semibold text-white mb-2">Submission Result</h3>
                        <pre id="campaign-result-output" class="bg-gray-800 p-4 rounded-lg text-sm overflow-x-auto"></pre>
                    </div>
                </div>

            </div> <!-- /Content Area -->
        </main>
    </div>

    <!-- 
      Full-screen Layout:
      This layout is for the login flow (initial login, callback, loading, errors).
    -->
    <div id="fullscreen-layout" class="hidden h-full flex items-center justify-center p-6">
        <div class="w-full max-w-md">

            <!-- Module: Login (MOD.B) -->
            <div id="module-login" class="app-module hidden">
                <div class="bg-gray-800 shadow-xl rounded-lg p-8">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-white">XPI Portal</h2>
                        <p class="text-gray-400 mt-2">Please login to continue</p>
                    </div>
                    
                    <!-- Login Feedback/Message Area -->
                    <div id="login-feedback" class="mb-4"></div>

                    <!-- Login Button -->
                    <button id="login-button" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-wait">
                        Login & Authenticate
                    </button>

                    <!-- "Start Over" Button (for errors) -->
                    <button id="start-over-button" class="hidden w-full mt-4 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Start Over
                    </button>
                </div>
            </div>

            <!-- Module: Loader -->
            <div id="module-loader" class="app-module hidden flex flex-col items-center">
                <div class="spinner"></div>
                <p class="text-white text-lg mt-4">Authenticating...</p>
                <p class="text-gray-400">Please wait, we're verifying your credentials.</p>
            </div>

        </div>
    </div>


    <!-- 
      Developer Tool 
    -->
    <div id="dev-tool">
        <!-- Toggle Icon -->
        <button id="dev-tool-toggle" class="fixed bottom-6 right-6 z-50 bg-blue-600 p-3 rounded-full text-white shadow-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900" title="Open Developer Tool">
            <!-- Hat Icon SVG -->
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM8.06 5.534a.75.75 0 001.06 0l1.06-1.06a.75.75 0 10-1.06-1.06l-1.06 1.06a.75.75 0 000 1.06zM6.25 7.75a.75.75 0 100-1.5.75.75 0 000 1.5zM4.466 8.06a.75.75 0 000 1.06l1.06 1.06a.75.75 0 101.06-1.06l-1.06-1.06a.75.75 0 00-1.06 0zM7.75 13.75a.75.75 0 10-1.5 0 .75.75 0 001.5 0zM8.06 15.534a.75.75 0 00-1.06 0l-1.06 1.06a.75.75 0 101.06 1.06l1.06-1.06a.75.75 0 000-1.06zM10 18a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5A.75.75 0 0110 18zM11.94 15.534a.75.75 0 000-1.06l-1.06-1.06a.75.75 0 10-1.06 1.06l1.06 1.06a.75.75 0 001.06 0zM13.75 12.25a.75.75 0 100 1.5.75.75 0 000-1.5zM15.534 11.94a.75.75 0 00-1.06 0l-1.06 1.06a.75.75 0 101.06 1.06l1.06-1.06a.75.75 0 000-1.06zM12.25 6.25a.75.75 0 101.5 0 .75.75 0 00-1.5 0zM11.94 4.466a.75.75 0 001.06 0l1.06-1.06a.75.75 0 10-1.06-1.06l-1.06 1.06a.75.75 0 000 1.06zM10 12a2 2 0 100-4 2 2 0 000 4z"/></svg>
        </button>

        <!-- Panel -->
        <div id="dev-tool-panel" class="hidden fixed bottom-0 right-0 z-40 w-full md:w-3/4 lg:w-1/2 h-2/5 bg-gray-800 border-t-2 border-blue-500 shadow-2xl flex flex-col rounded-t-lg">
            <!-- Header -->
            <div class="flex items-center justify-between p-3 bg-gray-700 rounded-t-lg flex-shrink-0">
                <h3 class="text-lg font-semibold text-white">Developer Tool: API Log</h3>
                <button id="dev-tool-close" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Log Content -->
            <div class="flex-1 overflow-auto p-4">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="p-2">Time</th>
                                <th class="p-2">Method</th>
                                <th class="p-2">URL</th>
                                <th class="p-2">Request</th>
                                <th class="p-2">Response</th>
                            </tr>
                        </thead>
                        <tbody id="api-log-table-body" class="divide-y divide-gray-700">
                            <!-- Rows will be injected by JS -->
                            <tr id="api-log-empty">
                                <td colspan="5" class="p-4 text-center text-gray-500">No API calls logged yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 
      JavaScript
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & CONFIG ---
            
            let apiLog = [];
            const configKeys = {
                xpiBaseUrl: 'xpiBaseUrl',
                clientId: 'clientId',
                token: 'token',
                username: 'username',
                password: 'password',
                firstName: 'firstName',
                lastName: 'lastName',
                avatarUrl: 'avatarUrl'
            };
            const defaultConfig = {
                xpiBaseUrl: 'https://api.wrikexpi.groupm.com'
            };
            
            // --- DOM SELECTORS ---
            
            const layouts = {
                app: document.getElementById('app-layout'),
                fullscreen: document.getElementById('fullscreen-layout')
            };
            
            const modules = {
                login: document.getElementById('module-login'),
                loader: document.getElementById('module-loader'),
                admin: document.getElementById('module-admin'),
                campaign: document.getElementById('module-campaign')
            };

            const allModules = document.querySelectorAll('.app-module');

            const sidebar = document.getElementById('sidebar');
            const sidebarToggleOpen = document.getElementById('sidebar-toggle-open');
            const sidebarToggleClose = document.getElementById('sidebar-toggle-close');

            const user = {
                avatar: document.getElementById('user-avatar'),
                name: document.getElementById('user-name'),
                status: document.getElementById('user-status'), // Added
                logoutButton: document.getElementById('logout-button') // Added
            };

            const devTool = {
                toggle: document.getElementById('dev-tool-toggle'),
                panel: document.getElementById('dev-tool-panel'),
                close: document.getElementById('dev-tool-close'),
                tableBody: document.getElementById('api-log-table-body'),
                emptyRow: document.getElementById('api-log-empty')
            };

            // --- HELPER FUNCTIONS ---

            /**
             * Gets a value from localStorage.
             * @param {string} key - The key to retrieve.
             * @param {*} [defaultValue] - The default value if key not found.
             * @returns {*} The retrieved value or default.
             */
            function getStorage(key, defaultValue = null) {
                const value = localStorage.getItem(key);
                // Note: We are not parsing JSON here, as per spec all stored items are strings.
                return value !== null ? value : defaultValue;
            }

            /**
             * Sets a value in localStorage.
             * @param {string} key - The key to set.
             * @param {string} value - The value to store.
             */
            function setStorage(key, value) {
                localStorage.setItem(key, value);
            }

            /**
             * Removes a value from localStorage.
             * @param {string} key - The key to remove.
             */
            function clearStorage(key) {
                localStorage.removeItem(key);
            }

            /**
             * Retrieves the current app configuration.
             * @returns {object} The configuration object.
             */
            function getConfig() {
                return {
                    xpiBaseUrl: getStorage(configKeys.xpiBaseUrl, defaultConfig.xpiBaseUrl)
                };
            }

            /**
             * Checks if the user is logged in (has essential credentials).
             * @returns {boolean} True if logged in, false otherwise.
             */
            function isLoggedIn() {
                return !!(
                    getStorage(configKeys.token) &&
                    getStorage(configKeys.username) &&
                    getStorage(configKeys.password)
                );
            }

            /**
             * Logs an API call to the dev tool.
             * @param {object} request - Request details { method, url, body }.
             * @param {object} response - Response details { status, data }.
             */
            function logApiCall(request, response) {
                const logEntry = {
                    time: new Date().toLocaleTimeString(),
                    request: request,
                    response: response
                };
                apiLog.unshift(logEntry); // Add to beginning

                // Update UI
                if (devTool.emptyRow) {
                    devTool.emptyRow.style.display = 'none';
                }

                const row = devTool.tableBody.insertRow(0);
                row.className = 'hover:bg-gray-700';
                row.innerHTML = `
                    <td class="p-2 align-top">${logEntry.time}</td>
                    <td class="p-2 align-top font-mono">${logEntry.request.method}</td>
                    <td class="p-2 align-top break-all">${logEntry.request.url}</td>
                    <td class="p-2 align-top"><pre class="text-xs whitespace-pre-wrap break-all">${logEntry.request.body ? JSON.stringify(logEntry.request.body, null, 2) : 'N/A'}</pre></td>
                    <td class="p-2 align-top"><pre class="text-xs whitespace-pre-wrap break-all">${logEntry.response.data ? JSON.stringify(logEntry.response.data, null, 2) : 'N/A'}</pre></td>
                `;
            }

            /**
             * Shows a specific module and hides all others.
             * @param {string} moduleId - The ID of the module to show (e.g., 'login', 'loader').
             */
            function showModule(moduleId) {
                allModules.forEach(module => module.classList.add('hidden'));
                const moduleToShow = document.getElementById(`module-${moduleId}`);
                if (moduleToShow) {
                    moduleToShow.classList.remove('hidden');
                }
            }

            /**
             * Updates the user avatar and name in the sidebar.
             */
            function updateUserUI() {
                if (isLoggedIn()) {
                    const firstName = getStorage(configKeys.firstName, '');
                    const lastName = getStorage(configKeys.lastName, '');
                    const avatarUrl = getStorage(configKeys.avatarUrl);
                    
                    user.name.textContent = `${firstName} ${lastName}`.trim() || 'Logged In';
                    user.status.textContent = 'Logged In';
                    user.logoutButton.classList.remove('hidden');
                    if (avatarUrl && avatarUrl !== 'null') {
                        user.avatar.src = avatarUrl;
                        user.avatar.onerror = () => {
                            user.avatar.src = 'https://placehold.co/40x40/374151/9ca3af?text=NA';
                        };
                    } else {
                        const initials = `${firstName.charAt(0)}${lastName.charAt(0)}` || 'U';
                        user.avatar.src = `https://placehold.co/40x40/374151/9ca3af?text=${initials}`;
                    }
                } else {
                    user.name.textContent = 'Not Logged In';
                    user.status.textContent = 'User';
                    user.avatar.src = 'https://placehold.co/40x40/374151/9ca3af?text=NA';
                    user.logoutButton.classList.add('hidden');
                }
            }

            /**
             * Generates a unique client ID using SHA-256.
             * @returns {Promise<string>} A 7-character client ID.
             */
            async function generateClientId() {
                const timestamp = Date.now();
                const random = Math.random();
                const data = `${timestamp}${random}`;
                const encoder = new TextEncoder();
                const buffer = encoder.encode(data);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hexHash.slice(-7);
            }

            /**
             * Displays a formatted message in the login feedback area.
             * @param {string} type - 'success', 'error', or 'info'.
             * @param {string} title - The main message.
             * @param {object | string} [details] - API response or extra text.
             */
            function showLoginFeedback(type, title, details = null) {
                const feedbackEl = document.getElementById('login-feedback');
                let bgColor, textColor, borderColor;

                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-900';
                        textColor = 'text-green-300';
                        borderColor = 'border-green-700';
                        break;
                    case 'error':
                        bgColor = 'bg-red-900';
                        textColor = 'text-red-300';
                        borderColor = 'border-red-700';
                        break;
                    default:
                        bgColor = 'bg-blue-900';
                        textColor = 'text-blue-300';
                        borderColor = 'border-blue-700';
                }

                let detailsHtml = '';
                if (details) {
                    const formattedDetails = (typeof details === 'object') 
                        ? JSON.stringify(details, null, 2) 
                        : details;
                    detailsHtml = `<pre class="mt-2 text-xs text-gray-400 bg-gray-900 p-3 rounded-md overflow-auto">${formattedDetails}</pre>`;
                }
                
                feedbackEl.innerHTML = `
                    <div class="${bgColor} ${textColor} ${borderColor} border p-4 rounded-lg">
                        <p class="font-semibold">${title}</p>
                        ${detailsHtml}
                    </div>
                `;
            }

            /**
             * Gets API headers for Basic or Bearer auth.
             * @param {'basic' | 'bearer'} authType 
             * @returns {Headers}
             */
            function getApiHeaders(authType) {
                const headers = new Headers();
                headers.append('Content-Type', 'application/json');

                if (authType === 'basic') {
                    const username = getStorage(configKeys.username);
                    const password = getStorage(configKeys.password);
                    if (username && password) {
                        headers.append('Authorization', 'Basic ' + btoa(`${username}:${password}`));
                    }
                } else if (authType === 'bearer') {
                    const token = getStorage(configKeys.token);
                    if (token) {
                        headers.append('Authorization', 'Bearer ' + token);
                    }
                }
                return headers;
            }

            /**
             * Generic fetch wrapper for dropdowns.
             * @param {string} url - The API endpoint.
             * @param {HTMLSelectElement} selectElement - The dropdown to populate.
             * @param {string} defaultValue - The default value to select.
             */
            async function populateDropdown(url, selectElement, defaultValue) {
                try {
                    const headers = getApiHeaders('basic');
                    const req = { method: 'GET', url: url };
                    const response = await fetch(url, { headers });
                    const data = await response.json();
                    
                    logApiCall(req, { status: response.status, data });

                    if (response.ok && data.value && Array.isArray(data.value)) {
                        selectElement.innerHTML = ''; // Clear "Loading..."
                        data.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.value;
                            option.textContent = item.value;
                            if (item.value === defaultValue) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        });
                    } else {
                        selectElement.innerHTML = '<option value="">Error loading data</option>';
                    }
                } catch (error) {
                    logApiCall({ method: 'GET', url: url }, { status: 'Network Error', data: { error: error.message } });
                    selectElement.innerHTML = '<option value="">Error loading data</option>';
                }
            }


            // --- MODULE INITIALIZATION ---

            /**
             * Initializes the Developer Tool listeners.
             */
            function initDevTool() {
                devTool.toggle.addEventListener('click', () => {
                    devTool.panel.classList.toggle('hidden');
                });
                devTool.close.addEventListener('click', () => {
                    devTool.panel.classList.add('hidden');
                });
            }

            /**
             * Initializes the Admin Module (MOD.A).
             */
            function initAdminModule() {
                const form = document.getElementById('admin-form');
                const urlInput = document.getElementById('xpiBaseUrl');
                const feedbackEl = document.getElementById('admin-feedback');
                
                // Load current config
                urlInput.value = getConfig().xpiBaseUrl;

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    setStorage(configKeys.xpiBaseUrl, urlInput.value);
                    feedbackEl.textContent = 'Configuration saved successfully.';
                    feedbackEl.className = 'mt-4 text-sm text-green-400';
                    setTimeout(() => feedbackEl.textContent = '', 3000);
                });
            }

            /**
             * Initializes the Login Module (MOD.B).
             * @param {string | null} code - The OAuth code from URL, or null.
             */
            function initLoginModule(code) {
                const loginButton = document.getElementById('login-button');
                const startOverButton = document.getElementById('start-over-button');
                document.getElementById('login-feedback').innerHTML = ''; // Clear feedback
                
                startOverButton.classList.add('hidden'); // Hide by default
                startOverButton.onclick = () => {
                    window.location.href = window.location.pathname; // Redirect to base URL
                };

                if (code) {
                    // Mode 2: OAuth Callback
                    loginButton.classList.add('hidden');
                    handleOAuthCallback(code);
                } else {
                    // Mode 1: Authentication
                    loginButton.classList.remove('hidden');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Login & Authenticate';
                    loginButton.onclick = async () => {
                        loginButton.disabled = true;
                        loginButton.textContent = 'Generating ID...';
                        
                        try {
                            const clientId = await generateClientId();
                            setStorage(configKeys.clientId, clientId);
                            
                            const config = getConfig();
                            const currentPageBaseUrl = window.location.origin + window.location.pathname;
                            const redirectUrl = `${config.xpiBaseUrl}/?accountId=3128883&redirectUri=${encodeURIComponent(currentPageBaseUrl)}&client_id=${clientId}`;
                            
                            logApiCall(
                                { method: 'REDIRECT', url: 'OAuth Redirect' },
                                { data: { redirectUrl } }
                            );
                            
                            // Redirect
                            window.location.href = redirectUrl;
                        } catch (error) {
                            showLoginFeedback('error', 'Failed to generate Client ID.', error.message);
                            loginButton.disabled = false;
                            loginButton.textContent = 'Login & Authenticate';
                        }
                    };
                }
            }

            /**
             * Handles the OAuth callback logic (Mode 2).
             * @param {string} code - The OAuth code.
             */
            async function handleOAuthCallback(code) {
                const clientId = getStorage(configKeys.clientId);
                const config = getConfig();
                const startOverButton = document.getElementById('start-over-button');

                // Validation
                if (!clientId || !code) {
                    showModule('login'); // Show login module to display error
                    showLoginFeedback('error', 'Authentication Error', 'Missing Client ID or Auth Code. Redirecting...');
                    logApiCall(
                        { method: 'CALLBACK', url: 'OAuth Callback' },
                        { status: 'Validation Error', data: { error: 'Missing clientId or code' } }
                    );
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 10000);
                    return;
                }

                // 1. API Call: Token Exchange
                const tokenUrl = `${config.xpiBaseUrl}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                let tokenData;
                try {
                    const tokenRequest = { method: 'GET', url: tokenUrl };
                    const response = await fetch(tokenUrl);
                    tokenData = await response.json();
                    logApiCall(tokenRequest, { status: response.status, data: tokenData });

                    if (!response.ok || !tokenData.success) {
                        throw new Error(tokenData.message || 'Failed to exchange token.');
                    }

                    // Store credentials
                    setStorage(configKeys.token, tokenData.data.token);
                    setStorage(configKeys.username, tokenData.data.credentials.username);
                    setStorage(configKeys.password, tokenData.data.credentials.password);

                } catch (error) {
                    showModule('login');
                    showLoginFeedback('error', 'Unexpected technical error in login.', tokenData || { error: error.message });
                    startOverButton.classList.remove('hidden');
                    return;
                }

                // 2. API Call: Verify Login (Get Profile)
                const profileUrl = `${config.xpiBaseUrl}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`;
                let profileData;
                try {
                    const profileRequest = { method: 'GET', url: profileUrl };
                    const headers = getApiHeaders('basic');
                    const response = await fetch(profileUrl, { headers });
                    profileData = await response.json();
                    logApiCall(profileRequest, { status: response.status, data: profileData });

                    if (!response.ok || !profileData.success || !profileData.data || profileData.data.length === 0) {
                        throw new Error(profileData.message || 'Failed to verify account.');
                    }

                    // Success: Store profile data
                    const profile = profileData.data[0];
                    setStorage(configKeys.firstName, profile.firstName);
                    setStorage(configKeys.lastName, profile.lastName);
                    setStorage(configKeys.avatarUrl, profile.avatarUrl);

                    // Update UI immediately
                    updateUserUI();
                    
                    showModule('login');
                    showLoginFeedback('success', `Login Successful!`, `Welcome, ${profile.firstName} ${profile.lastName}. Redirecting to app...`);
                    
                    // Redirect to app
                    setTimeout(() => {
                        window.location.href = window.location.pathname + '#/campaign';
                    }, 3000);

                } catch (error) {
                    showModule('login');
                    showLoginFeedback('error', 'Login failed, we are unable to verify your account. Please try again.', profileData || { error: error.message });
                    startOverButton.classList.remove('hidden');
                    // Clear bad credentials
                    clearStorage(configKeys.token);
                    clearStorage(configKeys.username);
                    clearStorage(configKeys.password);
                }
            }

            /**
             * Initializes the Campaign Submission Module (MOD.C).
             */
            function initCampaignModule() {
                const form = document.getElementById('campaign-form');
                const submitBtn = document.getElementById('campaign-submit-btn');
                const resultWrapper = document.getElementById('campaign-result-wrapper');
                const resultOutput = document.getElementById('campaign-result-output');

                const config = getConfig();

                // Populate dropdowns
                populateDropdown(
                    `${config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/value/clients-grm-mys`,
                    document.getElementById('client'),
                    "Adidas Group"
                );
                populateDropdown(
                    `${config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/value/debtors-grm-mys`,
                    document.getElementById('debtor'),
                    "Adidas Malaysia Sdn Bhd"
                );
                populateDropdown(
                    `${config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/value/agencies`,
                    document.getElementById('agency'),
                    "Eightbar"
                );

                // Handle form submission
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    resultWrapper.classList.add('hidden');

                    const formData = new FormData(form);
                    const data = {};
                    const fields = {};

                    formData.forEach((value, key) => {
                        if (['type', 'space', 'entity', 'varientId'].includes(key)) {
                            data[key] = isNaN(value) ? value : Number(value); // Convert varientId to number
                        } else if (key !== 'selectedchannels-text') {
                            fields[key] = value;
                        }
                    });

                    // Handle selectedchannels array
                    const channelsText = formData.get('selectedchannels-text') || '';
                    fields.selectedchannels = channelsText
                        .split(',')
                        .map(s => s.trim())
                        .filter(s => s.length > 0);
                    
                    data.fields = fields;

                    const url = `${config.xpiBaseUrl}/api/v1/wrikexpi/campaign`;
                    const headers = getApiHeaders('bearer');
                    const body = JSON.stringify(data);
                    
                    const request = { method: 'POST', url: url, body: data };
                    let responseData;
                    
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: headers,
                            body: body
                        });

                        responseData = await response.json();
                        logApiCall(request, { status: response.status, data: responseData });

                        resultOutput.textContent = JSON.stringify(responseData, null, 2);
                        if (response.ok) {
                            resultOutput.className = 'bg-gray-800 p-4 rounded-lg text-sm overflow-x-auto text-green-400';
                        } else {
                            throw new Error(responseData.message || `HTTP Error: ${response.status}`);
                        }
                    } catch (error) {
                        logApiCall(request, { status: 'Network Error', data: { error: error.message, response: responseData } });
                        resultOutput.textContent = `Submission Failed:\n${error.message}\n\n${responseData ? JSON.stringify(responseData, null, 2) : ''}`;
                        resultOutput.className = 'bg-gray-800 p-4 rounded-lg text-sm overflow-x-auto text-red-400';
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Campaign';
                        resultWrapper.classList.remove('hidden');
                    }
                });
            }

            /**
             * Initializes sidebar toggle controls.
             */
            function initSidebarControls() {
                sidebarToggleOpen.addEventListener('click', () => {
                    sidebar.classList.remove('-translate-x-full');
                });
                sidebarToggleClose.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                });
                
                // Add class for mobile responsiveness
                sidebar.classList.add('fixed', 'h-full', 'z-20', 'lg:static', 'lg:z-auto', 'lg:translate-x-0', '-translate-x-full');
            }


            /**
             * Initializes the logout button listener.
             */
            function initLogout() {
                user.logoutButton.addEventListener('click', () => {
                    // Clear all credentials
                    clearStorage(configKeys.clientId);
                    clearStorage(configKeys.token);
                    clearStorage(configKeys.username);
                    clearStorage(configKeys.password);
                    clearStorage(configKeys.firstName);
                    clearStorage(configKeys.lastName);
                    clearStorage(configKeys.avatarUrl);
                    
                    // Redirect to login page
                    window.location.hash = '#/login';
                    router(); // Re-run router to force update
                });
            }


            // --- ROUTER & INITIALIZATION ---

            /**
             * Main application router.
             */
            function router() {
                const hash = window.location.hash || '#/';
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');

                updateUserUI(); // Update user info on every route change
                
                const loggedIn = isLoggedIn();

                if (hash === '#admin') {
                    layouts.app.style.display = 'flex';
                    layouts.fullscreen.style.display = 'none';
                    showModule('admin');
                    initAdminModule();
                } else if (code) {
                    layouts.app.style.display = 'none';
                    layouts.fullscreen.style.display = 'flex';
                    showModule('loader'); // Show loader first
                    initLoginModule(code); // This handles the rest
                } else if (loggedIn) {
                    layouts.app.style.display = 'flex';
                    layouts.fullscreen.style.display = 'none';

                    if (hash === '#/campaign') {
                        showModule('campaign');
                        initCampaignModule();
                    } else if (hash === '#/login') {
                        // Allow re-login (or just show a "you are logged in" page)
                        // For now, redirect to default
                        window.location.hash = '#/campaign';
                    } else {
                        // Default for logged-in
                        window.location.hash = '#/campaign';
                    }
                } else {
                    // Not logged in, no code, not admin
                    layouts.app.style.display = 'none';
                    layouts.fullscreen.style.display = 'flex';
                    
                    // Clear any query params
                    if (window.location.search) {
                        window.history.replaceState(null, '', window.location.pathname + '#/login');
                    }
                    
                    showModule('login');
                    initLoginModule(null);
                }
            }

            // --- APP START ---
            
            initDevTool();
            initSidebarControls();
            initLogout(); // Added
            router(); // Call router on initial load
            window.addEventListener('hashchange', router); // Call router on hash change

        });
    </script>

    <!-- Custom form input styles for Tailwind -->
    <style>
        .form-input {
            @apply w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:opacity-50;
        }
        /* Style date/time inputs for dark mode */
        input[type="date"], input[type="number"] {
            color-scheme: dark;
        }
    </style>

</body>
</html>

