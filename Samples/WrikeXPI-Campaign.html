<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrike Campaign Submitter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind to use Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            width: 3rem;
            height: 3rem;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Hide scrollbar for main content, but allow scrolling */
        #main-content::-webkit-scrollbar {
            display: none;
        }
        #main-content {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body class="h-full text-gray-100">
    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 p-6 shadow-lg transition-transform duration-300 ease-in-out -translate-x-full lg:translate-x-0">
            <h1 class="text-2xl font-bold text-white mb-2">Modules</h1>
            <p id="user-greeting" class="text-sm text-gray-400 mb-6">Welcome, Guest</p>
            
            <nav class="flex flex-col space-y-2">
                <a href="#" id="nav-campaign" class="nav-link hidden p-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Campaign Form
                </a>
                <a href="#" id="nav-login" class="p-3 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                    <span id="nav-login-text">Login</span>
                </a>
            </nav>
        </aside>
        
        <!-- Mobile Sidebar Toggle -->
        <button id="sidebar-toggle" class="fixed top-4 left-4 z-40 lg:hidden p-2 bg-gray-800 text-white rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
        
        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto p-6 pt-20 lg:pt-8 lg:ml-64 transition-all duration-300 ease-in-out">
            
            <!-- Module: Login -->
            <div id="login-view" class="max-w-md mx-auto">
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl">
                    <h2 class="text-3xl font-bold text-center text-white mb-6">Wrike Authentication</h2>
                    
                    <div id="login-feedback" class="mb-4">
                        <p id="login-message" class="text-center text-gray-300">Please log in to continue.</p>
                        <pre id="login-error-details" class="hidden mt-4 p-4 bg-gray-900 text-red-300 rounded-md text-xs overflow-auto max-h-60"></pre>
                    </div>

                    <div id="loading-spinner" class="hidden spinner mx-auto my-4"></div>

                    <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                        Login & Authenticate
                    </button>
                    
                    <button id="start-over-button" class="hidden w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                        Start Over
                    </button>
                </div>
            </div>
            
            <!-- Module: Campaign Submission -->
            <div id="campaign-view" class="hidden max-w-4xl mx-auto">
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl">
                    <h2 class="text-3xl font-bold text-white mb-6">Create Wrike Campaign</h2>
                    
                    <form id="campaign-form">
                        <!-- Hidden Fields -->
                        <input type="hidden" id="type" name="type" value="Campaign Request">
                        <input type="hidden" id="space" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" id="entity" name="entity" value="Campaign">
                        <input type="hidden" id="varientId" name="varientId" value="1">
                        
                        <!-- Form Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Form Column 1 -->
                            <div class="space-y-4">
                                <div>
                                    <label for="campaignname" class="block text-sm font-medium text-gray-300 mb-1">Campaign Name</label>
                                    <input type="text" id="campaignname" name="campaignname" value="World Pinball Day 7000" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="client" class="block text-sm font-medium text-gray-300 mb-1">Client</label>
                                    <select id="client" name="client" required class="form-input">
                                        <option value="">Loading...</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="debtor" class="block text-sm font-medium text-gray-300 mb-1">Debtor</label>
                                    <select id="debtor" name="debtor" required class="form-input">
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="agency" class="block text-sm font-medium text-gray-300 mb-1">Agency</label>
                                    <select id="agency" name="agency" required class="form-input">
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="brand" class="block text-sm font-medium text-gray-300 mb-1">Brand</label>
                                    <input type="text" id="brand" name="brand" value="World Pinball" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="pod" class="block text-sm font-medium text-gray-300 mb-1">Pod</label>
                                    <input type="text" id="pod" name="pod" value="Pod 1A" required class="form-input">
                                </div>

                                <div>
                                    <label for="campaignobjective" class="block text-sm font-medium text-gray-300 mb-1">Campaign Objective</label>
                                    <input type="text" id="campaignobjective" name="campaignobjective" value="Upper Funnel / Awareness" required class="form-input">
                                </div>

                                <div>
                                    <label for="selectedchannels" class="block text-sm font-medium text-gray-300 mb-1">Selected Channels (comma-separated)</label>
                                    <input type="text" id="selectedchannels" name="selectedchannels" value="Twitter" required class="form-input">
                                </div>
                            </div>
                            
                            <!-- Form Column 2 -->
                            <div class="space-y-4">
                                <div>
                                    <label for="requestedstartdate" class="block text-sm font-medium text-gray-300 mb-1">Requested Start Date</label>
                                    <input type="date" id="requestedstartdate" name="requestedstartdate" value="2026-07-01" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="campaignstartdate" class="block text-sm font-medium text-gray-300 mb-1">Campaign Start Date</label>
                                    <input type="date" id="campaignstartdate" name="campaignstartdate" value="2026-08-29" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="campaignenddate" class="block text-sm font-medium text-gray-300 mb-1">Campaign End Date</label>
                                    <input type="date" id="campaignenddate" name="campaignenddate" value="2026-10-29" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="requestormarket" class="block text-sm font-medium text-gray-300 mb-1">Requestor Market</label>
                                    <input type="text" id="requestormarket" name="requestormarket" value="Singapore" required class="form-input">
                                </div>

                                <div>
                                    <label for="currency" class="block text-sm font-medium text-gray-300 mb-1">Currency</label>
                                    <input type="text" id="currency" name="currency" value="SGD" required class="form-input">
                                </div>

                                <div>
                                    <label for="overallbudget" class="block text-sm font-medium text-gray-300 mb-1">Overall Budget</label>
                                    <input type="number" id="overallbudget" name="overallbudget" value="100" step="0.01" required class="form-input">
                                </div>
                                
                                <div>
                                    <label for="optin" class="block text-sm font-medium text-gray-300 mb-1">Opt-in</label>
                                    <select id="optin" name="optin" required class="form-input">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="porequired" class="block text-sm font-medium text-gray-300 mb-1">PO Required</label>
                                    <select id="porequired" name="porequired" required class="form-input">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submission Button -->
                        <div class="mt-8">
                            <button type="submit" id="submit-campaign-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                                Submit Campaign
                            </button>
                        </div>
                    </form>
                    
                    <!-- Result Display -->
                    <div id="campaign-result-container" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Submission Result:</h3>
                        <p id="campaign-message" class="mb-2"></p>
                        <pre id="campaign-result" class="p-4 bg-gray-900 rounded-md text-xs overflow-auto max-h-96"></pre>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <!-- Custom CSS for form inputs -->
    <style>
        .form-input {
            width: 100%;
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4B5563; /* border-gray-600 */
            color: #F3F4F6; /* text-gray-100 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3B82F6; /* border-blue-500 */
            box-shadow: 0 0 0 2px #1E3A8A; /* ring-blue-500/50 */
        }
        /* Fix for date picker icon color in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>

    <!-- Application JavaScript -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTS ---
            const API_BASE = 'https://api.wrikexpi.groupm.com';
            const REDIRECT_URI = window.location.origin + window.location.pathname;
            const ACCOUNT_ID = '3128883';
            
            // --- DOM ELEMENTS ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mainContent = document.getElementById('main-content');
            
            const loginView = document.getElementById('login-view');
            const loginButton = document.getElementById('login-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const loginMessage = document.getElementById('login-message');
            const loginErrorDetails = document.getElementById('login-error-details');
            const startOverButton = document.getElementById('start-over-button');
            
            const campaignView = document.getElementById('campaign-view');
            const campaignForm = document.getElementById('campaign-form');
            const submitCampaignButton = document.getElementById('submit-campaign-button');
            const campaignResultContainer = document.getElementById('campaign-result-container');
            const campaignMessage = document.getElementById('campaign-message');
            const campaignResult = document.getElementById('campaign-result');
            
            const userGreeting = document.getElementById('user-greeting');
            const navLogin = document.getElementById('nav-login');
            const navLoginText = document.getElementById('nav-login-text');
            const navCampaign = document.getElementById('nav-campaign');

            const allViews = [loginView, campaignView];

            // --- STATE & STORAGE ---
            
            /**
             * Retrieves all auth data from localStorage.
             */
            function getAuthData() {
                return {
                    token: localStorage.getItem('wrikeToken'),
                    username: localStorage.getItem('wrikeUsername'),
                    password: localStorage.getItem('wrikePassword'),
                    firstName: localStorage.getItem('wrikeFirstName'),
                    lastName: localStorage.getItem('wrikeLastName'),
                };
            }
            
            /**
             * Clears all auth data from localStorage.
             */
            function clearAuthData() {
                localStorage.removeItem('wrikeToken');
                localStorage.removeItem('wrikeUsername');
                localStorage.removeItem('wrikePassword');
                localStorage.removeItem('wrikeFirstName');
                localStorage.removeItem('wrikeLastName');
                localStorage.removeItem('wrikeClientId'); // Clear this too
            }

            // --- UI HELPERS ---

            /**
             * Hides all views and shows the specified view.
             * @param {string} viewId - The ID of the view element to show.
             */
            function showView(viewId) {
                allViews.forEach(view => view.classList.add('hidden'));
                const viewToShow = document.getElementById(viewId);
                if (viewToShow) {
                    viewToShow.classList.remove('hidden');
                }
            }
            
            /**
             * Sets the loading state for a specific view (login or campaign).
             * @param {'login' | 'campaign'} view - The view to update.
             * @param {boolean} isLoading - Whether to show the loading state.
             */
            function setLoading(view, isLoading) {
                if (view === 'login') {
                    if (isLoading) {
                        loadingSpinner.classList.remove('hidden');
                        loginButton.classList.add('hidden');
                        startOverButton.classList.add('hidden');
                    } else {
                        loadingSpinner.classList.add('hidden');
                    }
                } else if (view === 'campaign') {
                    submitCampaignButton.disabled = isLoading;
                    submitCampaignButton.textContent = isLoading ? 'Submitting...' : 'Submit Campaign';
                }
            }

            /**
             * Displays a message and optional error details in the login view.
             * @param {string} message - The main message to display.
             * @param {boolean} [isError=false] - Whether to style as an error.
             * @param {string | null} [details=null] - JSON string or text for the <pre> tag.
             */
            function showLoginMessage(message, isError = false, details = null) {
                loginMessage.textContent = message;
                loginMessage.className = isError ? 'text-center text-red-400' : 'text-center text-green-400';
                
                if (details) {
                    loginErrorDetails.textContent = details;
                    loginErrorDetails.classList.remove('hidden');
                } else {
                    loginErrorDetails.classList.add('hidden');
                }
            }

            /**
             * Displays a message and optional response details in the campaign view.
             * @param {string} message - The main message to display.
             * @param {boolean} [isError=false] - Whether to style as an error.
             * @param {string | null} [details=null] - JSON string or text for the <pre> tag.
             */
            function showCampaignMessage(message, isError = false, details = null) {
                campaignResultContainer.classList.remove('hidden');
                campaignMessage.textContent = message;
                campaignMessage.className = isError ? 'mb-2 text-red-400' : 'mb-2 text-green-400';

                if (details) {
                    campaignResult.textContent = details;
                    campaignResult.className = `p-4 bg-gray-900 rounded-md text-xs overflow-auto max-h-96 ${isError ? 'text-red-300' : 'text-green-300'}`;
                    campaignResult.classList.remove('hidden');
                } else {
                    campaignResult.classList.add('hidden');
                }
            }

            // --- AUTHENTICATION LOGIC ---

            /**
             * Generates a SHA-256 hash of a string.
             * @param {string} message - The string to hash.
             * @returns {Promise<string>} The hex-encoded hash.
             */
            async function sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hexHash;
            }
            
            /**
             * Handles the click on the "Login & Authenticate" button.
             */
            async function handleLoginClick() {
                try {
                    setLoading('login', true);
                    showLoginMessage('Generating client ID...', false);

                    const data = `${Date.now()}${Math.random()}`;
                    const hexHash = await sha256(data);
                    const clientId = hexHash.slice(-7);
                    
                    localStorage.setItem('wrikeClientId', clientId);
                    
                    const redirectUrl = `${API_BASE}/?accountId=${ACCOUNT_ID}&redirectUri=${encodeURIComponent(REDIRECT_URI)}&client_id=${clientId}`;
                    
                    showLoginMessage('Redirecting to Wrike...', false);
                    window.location.href = redirectUrl;

                } catch (error) {
                    console.error('Login click failed:', error);
                    showLoginMessage('Failed to generate security token. Please try again.', true, error.message);
                    setLoading('login', false);
                }
            }
            
            /**
             * Handles the OAuth callback when the page loads with a "code" parameter.
             * @param {string} code - The authorization code from the URL.
             */
            async function handleOAuthCallback(code) {
                showView('login-view');
                setLoading('login', true);
                
                const clientId = localStorage.getItem('wrikeClientId');
                
                // 1. Validation
                if (!code || !clientId) {
                    showLoginMessage('Error: Missing authentication code or client ID. Redirecting...', true);
                    setLoading('login', false);
                    setTimeout(() => { window.location.href = REDIRECT_URI; }, 10000);
                    return;
                }
                
                showLoginMessage('Exchanging code for token...', false);
                
                try {
                    // 2. API Call 1: Exchange code for token
                    const tokenUrl = `${API_BASE}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                    const response = await fetch(tokenUrl);
                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        throw new Error(JSON.stringify(data, null, 2));
                    }
                    
                    // 3. Store Credentials
                    const { token, credentials } = data.data;
                    const { username, password } = credentials;
                    
                    localStorage.setItem('wrikeToken', token);
                    localStorage.setItem('wrikeUsername', username);
                    localStorage.setItem('wrikePassword', password);
                    
                    showLoginMessage('Token received. Verifying user profile...', false);
                    
                    // 4. API Call 2: Verify user profile
                    await verifyUserProfile(token);

                } catch (error) {
                    console.error('OAuth callback error:', error);
                    showLoginMessage('Login failed: Unexpected technical error.', true, error.message);
                    startOverButton.classList.remove('hidden');
                    setLoading('login', false);
                    clearAuthData();
                }
            }

            /**
             * Verifies the user's profile using the obtained Bearer token.
             * @param {string} token - The Bearer token.
             */
            async function verifyUserProfile(token) {
                try {
                    const profileUrl = `${API_BASE}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`;
                    const response = await fetch(profileUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (!response.ok || !data.success || !data.data || data.data.length === 0) {
                        throw new Error(JSON.stringify(data, null, 2));
                    }

                    // 5. Success
                    const user = data.data[0];
                    localStorage.setItem('wrikeFirstName', user.firstName);
                    localStorage.setItem('wrikeLastName', user.lastName);
                    
                    localStorage.removeItem('wrikeClientId'); // Clean up
                    
                    showLoginMessage(`${user.firstName} ${user.lastName} login successfully. Redirecting...`, false);
                    
                    // Redirect to base URL to clear code and trigger initApp
                    setTimeout(() => {
                        window.location.href = REDIRECT_URI;
                    }, 3000);

                } catch (error) {
                    console.error('Profile verification error:', error);
                    showLoginMessage('Login failed: We are unable to verify your account. Please try again.', true, error.message);
                    startOverButton.classList.remove('hidden');
                    setLoading('login', false);
                    clearAuthData(); // Clear partial auth
                }
            }

            /**
             * Handles user logout.
             */
            function handleLogout() {
                clearAuthData();
                setupLoggedOutState();
            }

            // --- CAMPAIGN FORM LOGIC ---

            /**
             * Fetches data and populates a dropdown select element.
             * @param {string} url - The API endpoint to fetch.
             * @param {string} selectId - The ID of the <select> element.
             * @param {string} basicAuthHeader - The "Basic <credentials>" header value.
             */
            async function populateDropdown(url, selectId, basicAuthHeader) {
                const select = document.getElementById(selectId);
                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': basicAuthHeader }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    
                    if (data && data.value && Array.isArray(data.value)) {
                        select.innerHTML = '<option value="">Select an option</option>'; // Clear "Loading..."
                        data.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.value;
                            option.textContent = item.value;
                            select.appendChild(option);
                        });
                        // Set default value from cURL if it exists in the list
                        if (selectId === 'client') select.value = 'Adidas Group';
                        if (selectId === 'debtor') select.value = 'Adidas Malaysia Sdn Bhd';
                        if (selectId === 'agency') select.value = 'Eightbar';

                    } else {
                        throw new Error('Invalid data structure');
                    }
                } catch (error) {
                    console.error(`Failed to load ${selectId}:`, error);
                    select.innerHTML = '<option value="">Error loading data</option>';
                }
            }

            /**
             * Loads all dynamic dropdowns for the campaign form.
             */
            async function loadCampaignDropdowns() {
                const { username, password } = getAuthData();
                if (!username || !password) {
                    showCampaignMessage('Error: Missing credentials to load form data. Please log out and log in again.', true);
                    return;
                }

                const basicAuthHeader = `Basic ${btoa(`${username}:${password}`)}`;
                
                const clientUrl = `${API_BASE}/api/v1/wrikexpi/v1.0/value/clients-grm-mys`;
                const debtorUrl = `${API_BASE}/api/v1/wrikexpi/v1.0/value/debtors-grm-mys`;
                const agencyUrl = `${API_BASE}/api/v1/wrikexpi/v1.0/value/agencies`;
                
                // Fetch all dropdown data concurrently
                await Promise.all([
                    populateDropdown(clientUrl, 'client', basicAuthHeader),
                    populateDropdown(debtorUrl, 'debtor', basicAuthHeader),
                    populateDropdown(agencyUrl, 'agency', basicAuthHeader)
                ]);
            }
            
            /**
             * Handles the submission of the campaign form.
             * @param {Event} event - The form submission event.
             */
            async function handleCampaignSubmit(event) {
                event.preventDefault();
                setLoading('campaign', true);
                campaignResultContainer.classList.add('hidden'); // Hide old results
                
                const { token } = getAuthData();
                if (!token) {
                    showCampaignMessage('Authentication error. Please log out and log in again.', true);
                    setLoading('campaign', false);
                    return;
                }
                
                try {
                    // Construct the payload
                    const fields = {
                        requestedstartdate: document.getElementById('requestedstartdate').value,
                        agency: document.getElementById('agency').value,
                        brand: document.getElementById('brand').value,
                        client: document.getElementById('client').value,
                        debtor: document.getElementById('debtor').value,
                        currency: document.getElementById('currency').value,
                        pod: document.getElementById('pod').value,
                        campaignname: document.getElementById('campaignname').value,
                        campaignstartdate: document.getElementById('campaignstartdate').value,
                        campaignenddate: document.getElementById('campaignenddate').value,
                        campaignobjective: document.getElementById('campaignobjective').value,
                        requestormarket: document.getElementById('requestormarket').value,
                        optin: document.getElementById('optin').value,
                        porequired: document.getElementById('porequired').value,
                        overallbudget: document.getElementById('overallbudget').value,
                        selectedchannels: document.getElementById('selectedchannels').value
                                                  .split(',')
                                                  .map(s => s.trim())
                                                  .filter(Boolean) // Remove empty strings
                    };
                    
                    const payload = {
                        type: document.getElementById('type').value,
                        space: document.getElementById('space').value,
                        entity: document.getElementById('entity').value,
                        varientId: parseInt(document.getElementById('varientId').value, 10),
                        fields: fields
                    };

                    // API Call
                    const submitUrl = `${API_BASE}/api/v1/wrikexpi/campaign`;
                    const response = await fetch(submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const responseData = await response.json();
                    const responseText = JSON.stringify(responseData, null, 2);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} ${response.statusText}\n${responseText}`);
                    }
                    
                    // Success
                    showCampaignMessage('Campaign submitted successfully!', false, responseText);
                    // Optionally reset the form: campaignForm.reset();
                    
                } catch (error) {
                    console.error('Campaign submission error:', error);
                    showCampaignMessage('Something went wrong, please try again.', true, error.message);
                } finally {
                    setLoading('campaign', false);
                }
            }

            // --- APP INITIALIZATION ---

            /**
             * Sets up the UI for a logged-out user.
             */
            function setupLoggedOutState() {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.add('hidden'); // Hide for good measure
                mainContent.classList.remove('lg:ml-64');
                userGreeting.textContent = 'Welcome, Guest';
                navLoginText.textContent = 'Login';
                navCampaign.classList.add('hidden');
                
                showView('login-view');
                loginButton.classList.remove('hidden');
                startOverButton.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                loginErrorDetails.classList.add('hidden');
                showLoginMessage('Please log in to continue.', false);
            }
            
            /**
             * Sets up the UI for a logged-in user.
             */
            function setupLoggedInState() {
                const { firstName } = getAuthData();
                sidebar.classList.remove('hidden'); // Show sidebar
                mainContent.classList.add('lg:ml-64');
                userGreeting.textContent = `Welcome, ${firstName}`;
                navLoginText.textContent = 'Logout';
                navCampaign.classList.remove('hidden');
                
                showView('campaign-view');
                loadCampaignDropdowns(); // Start loading form data
            }

            /**
             * Main application initialization function.
             */
            function initApp() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const auth = getAuthData();
                
                if (code) {
                    // Scenario 1: OAuth Callback
                    handleOAuthCallback(code);
                } else if (auth.token) {
                    // Scenario 2: Already Logged In
                    setupLoggedInState();
                } else {
                    // Scenario 3: Logged Out
                    setupLoggedOutState();
                }
            }
            
            // --- EVENT LISTENERS ---
            
            // Login button
            loginButton.addEventListener('click', handleLoginClick);
            
            // Start Over button
            startOverButton.addEventListener('click', () => {
                window.location.href = REDIRECT_URI;
            });
            
            // Campaign form submission
            campaignForm.addEventListener('submit', handleCampaignSubmit);

            // Sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Navigation Links
            navLogin.addEventListener('click', (e) => {
                e.preventDefault();
                if (getAuthData().token) {
                    // It's a "Logout" button
                    handleLogout();
                } else {
                    // It's a "Login" button
                    showView('login-view');
                    sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
                }
            });

            navCampaign.addEventListener('click', (e) => {
                e.preventDefault();
                if (getAuthData().token) {
                    showView('campaign-view');
                    sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
                } else {
                    // User is not logged in, redirect to login
                    showView('login-view');
                }
            });
            
            // --- START APP ---
            initApp();
            
        });
    </script>
</body>
</html>
