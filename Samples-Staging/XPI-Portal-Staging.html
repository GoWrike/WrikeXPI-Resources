<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Helper to hide elements */
        .hidden {
            display: none !important;
        }

        /* --- Placeholder Classes for JS Styling Engine --- */
        /* These will be replaced by Tailwind classes on load */
        .styled-body { /* Applied to <body> */ }
        .styled-navbar { /* Applied to <nav> */ }
        .styled-nav-toggle { /* Applied to nav toggle button */ }
        .styled-nav-link { /* Applied to <a> in nav */ }
        .styled-nav-link-active { /* Applied to active <a> in nav */ }
        .styled-user-profile { /* Applied to user profile div */ }
        
        .styled-main-content { /* Applied to <main> */ }
        .styled-card { /* Applied to module containers */ }
        .styled-title { /* Applied to h1, h2 */ }
        .styled-label { /* Applied to <label> */ }
        .styled-input { /* Applied to <input>, <select>, <textarea> */ }
        .styled-input-group { /* Applied to div wrapping label/input */ }
        
        .styled-btn { /* Base button style */ }
        .styled-btn-primary { /* Applied to primary buttons (Submit, Login) */ }
        .styled-btn-secondary { /* Applied to secondary (Load, Create) */ }
        .styled-btn-danger { /* Applied to (Delete) */ }
        .styled-btn-icon { /* Applied to icon-only buttons */ }

        .styled-table { /* Applied to <table> */ }
        .styled-thead { /* Applied to <thead> */ }
        .styled-th { /* Applied to <th> */ }
        .styled-tbody { /* Applied to <tbody> */ }
        .styled-td { /* Applied to <td> */ }

        .styled-modal-backdrop { /* Applied to modal overlay */ }
        .styled-modal-content { /* Applied to modal content box */ }
        .styled-modal-header { /* Applied to modal header */ }
        .styled-modal-body { /* Applied to modal body */ }
        .styled-modal-footer { /* Applied to modal footer */ }
        
        .styled-toast-container { /* Applied to toast container */ }
        .styled-toast { /* Base toast style */ }
        .styled-toast-success { /* Green success toast */ }
        .styled-toast-error { /* Red error toast */ }
        
        .styled-pre { /* Applied to <pre> tags for results */ }
        .styled-pre-success { /* Green border/text for <pre> */ }
        .styled-pre-error { /* Red border/text for <pre> */ }

        .styled-tag { /* Applied to channel tags */ }
        .styled-tag-remove { /* Applied to 'x' on tags */ }

        .styled-dev-tool-toggle { /* Applied to dev tool hat icon */ }
        .styled-dev-tool-log-link { /* Applied to Request/Response links */ }

        /* --- Loading Spinner --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="styled-body">

    <!-- --- SVG Icon Definitions --- -->
    <svg xmlns="http://www.w3.org/2000/svg" class="hidden">
        <symbol id="icon-nav-toggle" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
        </symbol>
        <symbol id="icon-logout" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2.5a.5.5 0 0 1-1 0v-2.5A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2.5a.5.5 0 0 1 1 0z"/>
            <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
        </symbol>
        <symbol id="icon-dev-hat" viewBox="0 0 16 16">
            <path d="M14.232 5.731a1.2 1.2 0 0 0-.962-.48 3.19 3.19 0 0 1-1.898.54 3.6 3.6 0 0 1-1.838-.504 3.19 3.19 0 0 1-1.967.54 3.6 3.6 0 0 1-1.838-.504 3.19 3.19 0 0 1-1.967.54 3.6 3.6 0 0 1-1.838-.504c-.388.232-.82.38-1.28.432-.618.069-1.25-.09-1.745-.387l-.002-.001-.002-.001c-.13-.08-.255-.164-.373-.254A1.2 1.2 0 0 0 .1 6.512C.03 6.845.06 7.2.144 7.538c.11.45.29.864.52 1.238.23.373.516.7.85 1.007.335.308.72.56 1.15.758.43.198.905.34 1.42.427.516.088 1.05.118 1.59.091.538-.027 1.07-.11 1.59-.248.52-.138 1.02-.33 1.49-.572.47-.242.91-.53 1.3-.86.39-.33.73-.7 1-1.1.27-.4.48-.84.62-1.3.14-.46.21-.94.21-1.43 0-.373-.03-.74-.09-1.096-.06-.353-.14-.694-.25-1.012a1.2 1.2 0 0 0-.961-.478Z"/>
            <path d="M8.752 12.019c.145.053.293.1.442.14a2.6 2.6 0 0 01.32-.018c.15-.029.297-.065.44-.108.145-.043.288-.09.428-.14L11.4 12c-.14.05-.283.097-.428.14a2.6 2.6 0 0 1-.44.108 2.6 2.6 0 0 1-.32.018 2.6 2.6 0 0 1-.442-.14zM8 9.032l.004-.001.004-.001c.142-.043.285-.09.428-.14.143-.05.286-.104.428-.162.142-.058.28-.12.413-.187.133-.067.26-.14.38-.217l.004-.003.004-.003c.12-.076.23-.158.33-.244.1-.086.19-.178.27-.271.08-.093.15-.19.21-.288l.003-.005.003-.005c.06-.098.11-.198.15-.3.04-.102.07-.205.09-.308l.001-.004.001-.004c.02-.103.03-.206.03-.31 0-.103-.01-.206-.03-.308l-.001-.004-.001-.004a3.19 3.19 0 0 0-.09-.308c-.04-.102-.09-.202-.15-.3l-.003-.005-.003-.005a3.19 3.19 0 0 0-.21-.288c-.08-.093-.17-.185-.27-.271a3.19 3.19 0 0 0-.33-.244l-.004-.003-.004-.003a3.19 3.19 0 0 0-.38-.217 3.19 3.19 0 0 0-.413-.187c-.142-.058-.285-.112-.428-.162-.143-.05-.286-.097-.428-.14l-.004-.001-.004-.001c-.142-.043-.285-.09-.428-.14a3.19 3.19 0 0 0-.428-.14l-.004-.001-.004-.001c-.142-.043-.285-.09-.428-.14-.143-.05-.286-.104-.428-.162-.142-.058-.28-.12-.413-.187-.133-.067-.26-.14-.38-.217l-.004-.003-.004-.003a3.19 3.19 0 0 0-.33-.244 3.19 3.19 0 0 0-.27-.271c-.08-.093-.15-.19-.21-.288l-.003-.005-.003-.005a3.19 3.19 0 0 0-.15-.3 3.19 3.19 0 0 0-.09-.308l-.001-.004-.001-.004a3.19 3.19 0 0 0-.03-.31c0-.103.01-.206.03-.308l.001-.004.001-.004c.02-.103.05-.206.09-.308.04-.102.09-.202.15-.3l.003-.005.003-.005c.06-.098.13-.195.21-.288.08-.093.17-.185.27-.271.1-.086.21-.168.33-.244l.004-.003.004-.003c.12-.076.247-.15.38-.217.133-.067.27-.129.413-.187.142-.058.285-.112.428-.162.143-.05.286-.097.428-.14l.004-.001.004-.001c.142-.043.285-.09.428-.14z"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 16 16">
            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 16 16">
            <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.5-.5H3v-.5a.5.5 0 0 1-.5-.5H2v.5a.5.5 0 0 1-.5.5H1.5a.5.5 0 0 1-.5.5H1v.5a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5.5v-1.5a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5z"/>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
        </symbol>
    </svg>

    <!-- Main Layout Container -->
    <div class="flex h-full">
        <!-- --- Navigation Bar --- -->
        <nav id="navbar" class="styled-navbar hidden">
            <div class="flex flex-col h-full">
                <!-- Nav Toggle -->
                <div class="flex-shrink-0 p-4">
                    <button id="nav-toggle-btn" class="styled-nav-toggle">
                        <svg class="w-6 h-6" fill="currentColor"><use href="#icon-nav-toggle"></use></svg>
                    </button>
                </div>
                <!-- Nav Links -->
                <div id="nav-links" class="flex-grow overflow-y-auto">
                    <!-- User-defined modules will be injected here by JS -->
                </div>
                <!-- User Profile -->
                <div id="user-profile" class="styled-user-profile hidden">
                    <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
                    <div class="flex-grow">
                        <span id="user-name" class="font-semibold block"></span>
                        <a href="#" id="logout-link" class="text-sm text-blue-400 hover:underline">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- --- Main Content Area --- -->
        <main id="main-content" class="styled-main-content">
            <div class="p-4 sm:p-6 lg:p-8 w-full">
                
                <!-- Module: Admin (MOD.A) -->
                <div id="module-MOD.A" class="module-container hidden">
                    <div class="styled-card max-w-2xl mx-auto">
                        <h1 class="styled-title mb-6">Admin Configuration</h1>
                        <form id="admin-form">
                            <div class="styled-input-group">
                                <label for="xpiBaseUrl" class="styled-label">XPI Base URL</label>
                                <input type="url" id="xpiBaseUrl" name="xpiBaseUrl" list="xpiBaseUrl-suggestions" class="styled-input" required>
                                <datalist id="xpiBaseUrl-suggestions">
                                    <!-- Suggestions added by JS -->
                                </datalist>
                            </div>
                            <button type="submit" class="styled-btn styled-btn-primary mt-4">Save Configuration</button>
                        </form>
                    </div>
                </div>

                <!-- Module: Login (MOD.B) -->
                <div id="module-MOD.B" class="module-container hidden">
                    <!-- Mode 1: Auth Button -->
                    <div id="login-auth-mode" class="styled-card max-w-md mx-auto text-center">
                        <h1 class="styled-title mb-6">XPI Portal Login</h1>
                        <button id="login-auth-btn" class="styled-btn styled-btn-primary w-full">Login & Authenticate</button>
                    </div>
                    <!-- Mode 2: Callback Handler -->
                    <div id="login-callback-mode" class="styled-card max-w-lg mx-auto text-center">
                        <h2 id="login-callback-title" class="styled-title mb-4">Authenticating...</h2>
                        <div id="login-callback-spinner" class="flex justify-center my-8">
                            <div class="spinner"></div>
                        </div>
                        <p id="login-callback-message" class="text-lg"></p>
                        <pre id="login-callback-error" class="styled-pre styled-pre-error hidden mt-4"></pre>
                        <button id="login-start-over-btn" class="styled-btn styled-btn-secondary mt-6 hidden">Start Over</button>
                    </div>
                </div>

                <!-- Module: Campaign Submission (MOD.C) -->
                <div id="module-MOD.C" class="module-container hidden">
                    <form id="campaign-form" class="styled-card max-w-4xl mx-auto">
                        <h1 class="styled-title mb-6">Campaign Submission</h1>
                        
                        <!-- Hidden fields -->
                        <input type="hidden" name="type" value="Campaign Request">
                        <input type="hidden" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" name="entity" value="Campaign">
                        <input type="hidden" name="varientId" value="1">

                        <!-- Form grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="styled-input-group">
                                <label for="campaignname" class="styled-label">Campaign Name</label>
                                <input type="text" id="campaignname" name="campaignname" class="styled-input" value="World Pinball Day 7000" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="requestedstartdate" class="styled-label">Requested Start Date</label>
                                <input type="date" id="requestedstartdate" name="requestedstartdate" class="styled-input" value="2026-07-01" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="agency" class="styled-label">Agency</label>
                                <select id="agency" name="agency" class="styled-input" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="styled-input-group">
                                <label for="brand" class="styled-label">Brand</label>
                                <input type="text" id="brand" name="brand" class="styled-input" value="World Pinball" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="client" class="styled-label">Client</label>
                                <select id="client" name="client" class="styled-input" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="styled-input-group">
                                <label for="debtor" class="styled-label">Debtor</label>
                                <select id="debtor" name="debtor" class="styled-input" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="styled-input-group">
                                <label for="currency" class="styled-label">Currency</label>
                                <input type="text" id="currency" name="currency" class="styled-input" value="SGD" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="pod" class="styled-label">Pod</label>
                                <input type="text" id="pod" name="pod" class="styled-input" value="Pod 1A" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="campaignstartdate" class="styled-label">Campaign Start Date</label>
                                <input type="date" id="campaignstartdate" name="campaignstartdate" class="styled-input" value="2026-08-29" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="campaignenddate" class="styled-label">Campaign End Date</label>
                                <input type="date" id="campaignenddate" name="campaignenddate" class="styled-input" value="2026-10-29" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="campaignobjective" class="styled-label">Campaign Objective</label>
                                <input type="text" id="campaignobjective" name="campaignobjective" class="styled-input" value="Upper Funnel / Awareness" required>
                            </div>
                            <div class="styled-input-group">
                                <label for="requestormarket" class="styled-label">Requestor Market</label>
                                <input type="text" id="requestormarket" name="requestormarket" class="styled-input" value="Singapore" required>
                            </div>
                             <div class="styled-input-group">
                                <label for="optin" class="styled-label">Opt-in</label>
                                <select id="optin" name="optin" class="styled-input" required>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="styled-input-group">
                                <label for="porequired" class="styled-label">PO Required</label>
                                <select id="porequired" name="porequired" class="styled-input" required>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="styled-input-group">
                                <label for="overallbudget" class="styled-label">Overall Budget</label>
                                <input type="number" id="overallbudget" name="overallbudget" class="styled-input" value="100" required>
                            </div>
                            <!-- Tagging Interface for Selected Channels -->
                            <div class="styled-input-group md:col-span-2">
                                <label for="selectedchannels-input" class="styled-label">Selected Channels (type and press Enter)</label>
                                <div class="styled-input flex flex-wrap items-center gap-2 p-2">
                                    <div id="selectedchannels-container" class="flex flex-wrap gap-2">
                                        <!-- Tags will be added here -->
                                        <span class="styled-tag">Twitter<button type="button" class="styled-tag-remove" data-value="Twitter">&times;</button></span>
                                    </div>
                                    <input type="text" id="selectedchannels-input" class="bg-transparent flex-grow outline-none p-1" placeholder="Add a channel...">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end">
                            <button type="submit" id="campaign-submit-btn" class="styled-btn styled-btn-primary">
                                Submit Campaign
                            </button>
                        </div>
                    </form>
                    <!-- Result Display -->
                    <pre id="campaign-result" class="styled-pre max-w-4xl mx-auto mt-6 hidden"></pre>
                </div>

                <!-- Module: Demo Client (MAS.DemoCient) -->
                <div id="module-MAS.DemoCient" class="module-container hidden">
                    <!-- Master Data Template will be injected here -->
                </div>

                <!-- Module: XPI Field Mapping (MAS.XPICFMapping) -->
                <div id="module-MAS.XPICFMapping" class="module-container hidden">
                    <!-- Master Data Template will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- --- Master Data Module Template --- -->
    <template id="master-data-template">
        <div class="styled-card max-w-6xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h1 class="styled-title md-title">Master Data</h1>
                <div class="flex gap-3">
                    <button class="styled-btn styled-btn-secondary md-load-btn">Load Data</button>
                    <button class="styled-btn styled-btn-primary md-create-btn">
                        <svg class="w-5 h-5 mr-2" fill="currentColor"><use href="#icon-plus"></use></svg>
                        Create New
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="styled-table">
                    <thead class="styled-thead md-table-head">
                        <!-- Headers injected by JS -->
                    </thead>
                    <tbody class="styled-tbody md-table-body">
                        <tr><td class="styled-td text-center" colspan="100">Click "Load Data" to begin.</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Create/Edit Modal -->
            <div class="md-modal styled-modal-backdrop hidden">
                <div class="styled-modal-content max-w-lg w-full">
                    <form class="md-modal-form">
                        <div class="styled-modal-header">
                            <h3 class="styled-title md-modal-title">Create/Edit Record</h3>
                            <button type="button" class="styled-btn-icon md-modal-close">
                                <svg class="w-6 h-6" fill="currentColor"><use href="#icon-close"></use></svg>
                            </button>
                        </div>
                        <div class="styled-modal-body grid grid-cols-1 gap-4 md-modal-fields">
                            <!-- Form fields injected by JS -->
                        </div>
                        <div class="styled-modal-footer">
                            <button type="button" class="styled-btn styled-btn-secondary md-modal-close">Cancel</button>
                            <button type="submit" class="styled-btn styled-btn-primary">Save Record</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="md-delete-modal styled-modal-backdrop hidden">
                <div class="styled-modal-content max-w-md w-full">
                    <div class="styled-modal-header">
                        <h3 class="styled-title">Confirm Deletion</h3>
                        <button type="button" class="styled-btn-icon md-delete-close">
                            <svg class="w-6 h-6" fill="currentColor"><use href="#icon-close"></use></svg>
                        </button>
                    </div>
                    <div class="styled-modal-body">
                        <p>Are you sure you want to delete this record? This action cannot be undone.</p>
                        <p class="font-semibold my-2 md-delete-record-name"></p>
                    </div>
                    <div class="styled-modal-footer">
                        <button type="button" class="styled-btn styled-btn-secondary md-delete-close">Cancel</button>
                        <button type="button" class="styled-btn styled-btn-danger md-delete-confirm-btn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <!-- --- Developer Tool --- -->
    <button id="dev-tool-toggle" class="styled-dev-tool-toggle">
        <svg class="w-6 h-6" fill="currentColor"><use href="#icon-dev-hat"></use></svg>
    </button>
    
    <div id="dev-tool-modal" class="styled-modal-backdrop hidden">
        <div class="styled-modal-content w-full max-w-6xl h-[80vh] flex flex-col">
            <div class="styled-modal-header">
                <h3 class="styled-title">Developer Tool: API Logs</h3>
                <div class="flex gap-4">
                     <button id="dev-tool-purge-btn" class="styled-btn-icon" title="Purge All Logs">
                        <svg class="w-6 h-6" fill="currentColor"><use href="#icon-trash"></use></svg>
                    </button>
                    <button id="dev-tool-close-btn" class="styled-btn-icon" title="Close">
                        <svg class="w-6 h-6" fill="currentColor"><use href="#icon-close"></use></svg>
                    </button>
                </div>
            </div>
            <div class="styled-modal-body flex-grow overflow-auto">
                <table class="styled-table">
                    <thead class="styled-thead">
                        <tr>
                            <th class="styled-th">Timestamp</th>
                            <th class="styled-th">Status</th>
                            <th class="styled-th">Method</th>
                            <th class="styled-th">URL</th>
                            <th class="styled-th">Request</th>
                            <th class="styled-th">Response</th>
                        </tr>
                    </thead>
                    <tbody id="dev-tool-log-body" class="styled-tbody">
                        <!-- Logs injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dev Tool Payload Modal -->
    <div id="dev-tool-payload-modal" class="styled-modal-backdrop hidden">
        <div class="styled-modal-content w-full max-w-2xl h-[70vh] flex flex-col">
            <div class="styled-modal-header">
                <h3 id="dev-tool-payload-title" class="styled-title">Payload</h3>
                <button id="dev-tool-payload-close-btn" class="styled-btn-icon">
                    <svg class="w-6 h-6" fill="currentColor"><use href="#icon-close"></use></svg>
                </button>
            </div>
            <div class="styled-modal-body flex-grow overflow-auto">
                <pre id="dev-tool-payload-pre" class="styled-pre"></pre>
            </div>
        </div>
    </div>

    <!-- --- Global Components --- -->
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="styled-toast-container"></div>
    
    <!-- Full Page Spinner -->
    <div id="full-page-spinner" class="styled-modal-backdrop hidden">
        <div class="spinner"></div>
    </div>


    <!-- --- Main Application Script --- -->
    <script type="module">
        // --- Constants & Config ---

        const MODULES = [
            { Module: 'Admin', Code: 'MOD.A', Description: 'Administrative Module', ModuleType: 'Built-in' },
            { Module: 'Login', Code: 'MOD.B', Description: 'Login Module', ModuleType: 'Built-in' },
            { Module: 'Campaign Submission', Code: 'MOD.C', Description: 'Campaign Submission Module', ModuleType: 'User-defined' },
            { Module: 'Demo Client', Code: 'MAS.DemoCient', Description: 'Master Data for Demo Client', ModuleType: 'User-defined' },
            { Module: 'XPI Field Mapping', Code: 'MAS.XPICFMapping', Description: 'XPI Field Mapping', ModuleType: 'User-defined' },
        ];
        
        const USER_MODULES = MODULES.filter(m => m.ModuleType === 'User-defined');
        
        const GLOBAL_CONFIG_DEFAULTS = {
            xpiBaseUrl: 'https://xpi-api.gowrike.space/',
        };
        
        const SUGGESTED_URLS = [
            'https://api.wrikexpi.groupm.com',
            'https://xpi-api.gowrike.space/',
        ];
        
        const DEV_LOG_KEY = 'xpi_dev_logs';

        // --- Utility Functions ---

        const q = (selector) => document.querySelector(selector);
        const qA = (selector) => document.querySelectorAll(selector);

        /** Gets a value from localStorage or sessionStorage */
        const getStorage = (key, type = 'local') => {
            try {
                const storage = type === 'local' ? localStorage : sessionStorage;
                return storage.getItem(key);
            } catch (e) {
                console.error(`Error reading from ${type}Storage:`, e);
                return null;
            }
        };

        /** Sets a value in localStorage or sessionStorage */
        const setStorage = (key, value, type = 'local') => {
            try {
                const storage = type === 'local' ? localStorage : sessionStorage;
                storage.setItem(key, value);
            } catch (e) {
                console.error(`Error writing to ${type}Storage:`, e);
            }
        };

        /** Removes a value from localStorage or sessionStorage */
        const removeStorage = (key, type = 'local') => {
            try {
                const storage = type === 'local' ? localStorage : sessionStorage;
                storage.removeItem(key);
            } catch (e) {
                console.error(`Error removing from ${type}Storage:`, e);
            }
        };

        /** Gets the configured XPI Base URL */
        const getXpiBaseUrl = () => {
            return getStorage('xpiBaseUrl') || GLOBAL_CONFIG_DEFAULTS.xpiBaseUrl;
        };

        /** Gets user profile data from session */
        const getUserProfile = () => {
            const firstName = getStorage('firstName', 'session');
            const lastName = getStorage('lastName', 'session');
            const avatarUrl = getStorage('avatarUrl', 'session');
            if (firstName && lastName) {
                return { firstName, lastName, avatarUrl };
            }
            return null;
        };

        /** Gets the Bearer Token from session */
        const getBearerToken = () => {
            return getStorage('token', 'session');
        };

        /** Checks if user is authenticated */
        const isLoggedIn = () => {
            return !!getBearerToken() && !!getUserProfile();
        };

        /** Toggles a modal's visibility */
        const showModal = (modalId, show = true) => {
            const modal = q(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }
        };
        
        /** Shows a toast notification */
        const showToast = (message, type = 'success') => {
            const container = q('#toast-container');
            const toast = document.createElement('div');
            toast.className = `styled-toast ${type === 'success' ? 'styled-toast-success' : 'styled-toast-error'}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Auto-style the new toast
            applyTailwindStyles(toast);
            
            // Force reflow to trigger transition
            void toast.offsetWidth;
            
            // This needs to be applied *after* reflow
            if (type === 'success') {
                toast.classList.add('opacity-100', 'translate-y-0');
            } else {
                toast.classList.add('opacity-100', 'translate-y-0');
            }
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };
        
        /** Toggles the full-page loading spinner */
        const showSpinner = (show = true) => {
            showModal('#full-page-spinner', show);
        };
        
        /** Pretty-prints JSON */
        const jsonToPretty = (json) => {
            if (typeof json === 'string') {
                try {
                    json = JSON.parse(json);
                } catch (e) {
                    return json; // Not valid JSON, return as is
                }
            }
            return JSON.stringify(json, null, 2);
        };
        
        /** Hashes a string using SHA-256 */
        const sha256 = async (str) => {
            const textAsBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };
        
        // --- Styling Engine ---

        /**
         * Replaces placeholder classes with Tailwind classes.
         * This is the core of the specific styling requirement.
         * @param {HTMLElement} [scope] - Optional element to scope the replacement.
         */
        const applyTailwindStyles = (scope = document) => {
            const styleMap = {
                // Body & Layout
                'styled-body': 'bg-gray-900 text-gray-200 antialiased h-full',
                'styled-navbar': 'w-64 bg-gray-800 shadow-lg flex-shrink-0 h-full transition-all duration-300',
                'styled-main-content': 'flex-grow h-full overflow-y-auto',
                
                // Nav
                'styled-nav-toggle': 'text-gray-400 hover:text-white',
                'styled-nav-link': 'block p-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1 transition-colors',
                'styled-nav-link-active': 'bg-blue-600 text-white',
                'styled-user-profile': 'flex-shrink-0 p-4 bg-gray-900/50 flex items-center',
                
                // Cards & Titles
                'styled-card': 'bg-gray-800 shadow-2xl rounded-lg p-6 sm:p-8',
                'styled-title': 'text-2xl font-semibold text-white mb-4',
                
                // Forms
                'styled-label': 'block text-sm font-medium text-gray-300 mb-2',
                'styled-input': 'w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow',
                'styled-input-group': 'mb-4',

                // Buttons
                'styled-btn': 'px-4 py-2 rounded-md font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all duration-200 shadow-md inline-flex items-center justify-center',
                'styled-btn-primary': 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed',
                'styled-btn-secondary': 'bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed',
                'styled-btn-danger': 'bg-red-600 hover:bg-red-700 focus:ring-red-500',
                'styled-btn-icon': 'p-2 bg-transparent text-gray-400 hover:text-white hover:bg-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-500',
                
                // Tables
                'styled-table': 'w-full min-w-max text-left text-sm',
                'styled-thead': 'bg-gray-700/50 text-gray-300 uppercase tracking-wider',
                'styled-th': 'p-4 font-semibold',
                'styled-tbody': 'divide-y divide-gray-700',
                'styled-td': 'p-4 align-top',
                
                // Modals
                'styled-modal-backdrop': 'fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4 backdrop-blur-sm',
                'styled-modal-content': 'bg-gray-800 rounded-lg shadow-2xl w-full flex flex-col',
                'styled-modal-header': 'flex justify-between items-center p-6 border-b border-gray-700',
                'styled-modal-body': 'p-6 flex-grow overflow-y-auto',
                'styled-modal-footer': 'flex justify-end gap-3 p-6 bg-gray-800/50 border-t border-gray-700 rounded-b-lg',

                // Toasts
                'styled-toast-container': 'fixed top-4 right-4 z-50 space-y-3 w-80',
                'styled-toast': 'p-4 rounded-md shadow-lg text-white transition-all duration-300 transform opacity-0 translate-y-4',
                'styled-toast-success': 'bg-green-600',
                'styled-toast-error': 'bg-red-600',
                
                // Other
                'styled-pre': 'bg-gray-900 border border-gray-700 text-left text-sm p-4 rounded-md overflow-x-auto max-h-80',
                'styled-pre-success': 'border-green-500 text-green-300',
                'styled-pre-error': 'border-red-500 text-red-300',
                'styled-tag': 'bg-blue-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2',
                'styled-tag-remove': 'font-bold text-blue-200 hover:text-white cursor-pointer',
                'styled-dev-tool-toggle': 'fixed bottom-6 right-6 z-30 p-4 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-70s0 transition-all',
                'styled-dev-tool-log-link': 'text-blue-400 hover:underline cursor-pointer',
            };

            for (const [placeholder, tailwindClasses] of Object.entries(styleMap)) {
                // Find all elements with the placeholder class, within the scope
                const elements = scope.classList && scope.classList.contains(placeholder) 
                    ? [scope] 
                    : Array.from(scope.querySelectorAll(`.${placeholder}`));

                for (const el of elements) {
                    // Use replace to preserve other classes (like .md-load-btn)
                    // Split tailwindClasses into an array to pass to add()
                    const classesToAdd = tailwindClasses.split(' ');
                    el.classList.add(...classesToAdd);
                    el.classList.remove(placeholder);
                }
            }
        };

        // --- Developer Tool ---

        const getDevLogs = () => {
            try {
                return JSON.parse(getStorage(DEV_LOG_KEY) || '[]');
            } catch (e) {
                console.error("Error parsing dev logs:", e);
                return []; // Return empty array on parse error
            }
        };

        /** Logs an API call, redacting the Authorization header */
        const logApiCall = (timestamp, method, status, url, requestOptions, response) => {
            let logs = getDevLogs();
            
            // Clone requestOptions to redact headers
            const safeRequest = JSON.parse(JSON.stringify(requestOptions));
            if (safeRequest.headers && safeRequest.headers['Authorization']) {
                safeRequest.headers['Authorization'] = 'Bearer [REDACTED]';
            }
            if (safeRequest.headers && safeRequest.headers['authorization']) {
                safeRequest.headers['authorization'] = 'Bearer [REDACTED]';
            }
            
            logs.unshift({
                timestamp,
                method,
                status,
                url,
                request: safeRequest,
                response
            });
            
            // Keep only last 50 logs
            logs = logs.slice(0, 50); 
            
            setStorage(DEV_LOG_KEY, JSON.stringify(logs));
            // Re-render if modal is open
            if (!q('#dev-tool-modal').classList.contains('hidden')) {
                renderDevToolLogs();
            }
        };
        
        /** Renders logs into the dev tool table */
        const renderDevToolLogs = () => {
            const logs = getDevLogs();
            const tbody = q('#dev-tool-log-body');
            if (!tbody) return;
            
            if (logs.length === 0) {
                tbody.innerHTML = `<tr><td class="styled-td text-center" colspan="6">No API calls logged.</td></tr>`;
                applyTailwindStyles(tbody.firstElementChild.firstElementChild); // Style the new TD
                return;
            }
            
            tbody.innerHTML = logs.map((log, index) => `
                <tr class="hover:bg-gray-700/50">
                    <td class="styled-td">${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="styled-td">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                            log.status >= 200 && log.status < 300 ? 'bg-green-700 text-green-200' :
                            log.status >= 400 ? 'bg-red-700 text-red-200' :
                            'bg-yellow-700 text-yellow-200'
                        }">${log.status || 'N/A'}</span>
                    </td>
                    <td class="styled-td">${log.method}</td>
                    <td class="styled-td break-all" title="${log.url}">${log.url.substring(0, 50)}...</td>
                    <td class="styled-td">
                        <span class="styled-dev-tool-log-link" data-log-index="${index}" data-payload-type="request">
                            View Request
                        </span>
                    </td>
                    <td class="styled-td">
                        <span class="styled-dev-tool-log-link" data-log-index="${index}" data-payload-type="response">
                            View Response
                        </span>
                    </td>
                </tr>
            `).join('');
            
            // Re-style all new elements
            applyTailwindStyles(tbody);
        };
        
        /** Shows the payload modal for a specific log */
        const showPayloadModal = (logIndex, payloadType) => {
            const logs = getDevLogs();
            const log = logs[logIndex];
            if (!log) return;
            
            const payload = log[payloadType];
            q('#dev-tool-payload-title').textContent = `${payloadType.charAt(0).toUpperCase() + payloadType.slice(1)} Payload`;
            const pre = q('#dev-tool-payload-pre');
            pre.textContent = jsonToPretty(payload || 'N/A');
            // Re-style the <pre> tag in case it was created dynamically
            pre.className = 'styled-pre';
            applyTailwindStyles(pre); 
            
            showModal('#dev-tool-payload-modal', true);
        };

        /** Initializes the Developer Tool listeners */
        const initDevTool = () => {
            q('#dev-tool-toggle').addEventListener('click', () => {
                renderDevToolLogs();
                showModal('#dev-tool-modal', true);
            });
            
            q('#dev-tool-close-btn').addEventListener('click', () => {
                showModal('#dev-tool-modal', false);
            });
            
            q('#dev-tool-purge-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to purge all API logs?')) {
                    removeStorage(DEV_LOG_KEY);
                    renderDevToolLogs();
                    showToast('Logs purged.', 'success');
                }
            });
            
            q('#dev-tool-payload-close-btn').addEventListener('click', () => {
                showModal('#dev-tool-payload-modal', false);
            });
            
            // Event delegation for payload links
            q('#dev-tool-log-body').addEventListener('click', (e) => {
                if (e.target.classList.contains('styled-dev-tool-log-link') || e.target.closest('.styled-dev-tool-log-link')) {
                    const link = e.target.closest('.styled-dev-tool-log-link');
                    const { logIndex, payloadType } = link.dataset;
                    showPayloadModal(parseInt(logIndex), payloadType);
                }
            });
        };

        // --- API Fetch Wrapper ---
        
        /**
         * Centralized fetch function with logging and auth.
         * @param {string} url - The API endpoint (relative or absolute)
         * @param {object} options - Fetch options (method, body, etc.)
         * @param {'bearer'|'basic'|'none'} authType - Type of authentication
         * @param {string} [basicUser] - Username for Basic Auth
         * @param {string} [basicPass] - Password for Basic Auth
         */
        const apiFetch = async (url, options = {}, authType = 'bearer', basicUser = null, basicPass = null) => {
            const startTime = Date.now();
            const baseUrl = getXpiBaseUrl();
            
            // Prepend base URL if URL is relative
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = new URL(url, baseUrl).href;
            }
            
            const headers = new Headers(options.headers || {});
            
            if (authType === 'bearer') {
                const token = getBearerToken();
                if (token) {
                    headers.set('Authorization', `Bearer ${token}`);
                }
            } else if (authType === 'basic' && basicUser && basicPass) {
                headers.set('Authorization', `Basic ${btoa(basicUser + ':' + basicPass)}`);
            }
            
            if (options.body && !headers.has('Content-Type')) {
                headers.set('Content-Type', 'application/json');
            }
            
            options.headers = headers;
            
            // Prepare log data
            const logOptions = { ...options };
            // Convert headers to plain object for logging
            logOptions.headers = Object.fromEntries(headers.entries());
            if (logOptions.body) {
                try {
                    // Try to parse body for logging
                    logOptions.body = JSON.parse(logOptions.body);
                } catch (e) {
                    // leave as is if not JSON
                }
            }

            let response, responseData, status, error;
            
            try {
                response = await fetch(url, options);
                status = response.status;
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                if (!response.ok) {
                    // Throw an error to be caught below
                    const errorPayload = {
                        status: response.status,
                        statusText: response.statusText,
                        body: responseData
                    };
                    throw new Error(JSON.stringify(errorPayload));
                }
                
            } catch (e) {
                console.error('API Fetch Error:', e);
                error = e;
                // Try to parse error message if it's our custom JSON error
                try {
                    const parsedError = JSON.parse(e.message);
                    responseData = parsedError.body;
                    status = parsedError.status;
                } catch (parseErr) {
                    responseData = e.message;
                    status = status || 500; // Network error
                }
            }
            
            logApiCall(startTime, options.method || 'GET', status, url, logOptions, responseData);
            
            if (error) {
                throw responseData; // Re-throw the response body or error message
            }
            
            return responseData;
        };
        
        // --- Navigation & Routing ---
        
        /** Updates UI based on login state */
        const updateUIForLoginState = () => {
            const nav = q('#navbar');
            const profile = q('#user-profile');
            const loggedIn = isLoggedIn();
            
            if (loggedIn) {
                const user = getUserProfile();
                q('#user-name').textContent = `${user.firstName} ${user.lastName}`;
                q('#user-avatar').src = user.avatarUrl || 'https://placehold.co/40x40/667eea/e2e8f0?text=A';
                nav.classList.remove('hidden');
                profile.classList.remove('hidden');
            } else {
                nav.classList.add('hidden');
                profile.classList.add('hidden');
                // Ensure navbar is reset to full width if it was collapsed
                nav.classList.remove('-ml-64');
                q('#main-content').classList.remove('ml-0');
            }
        };

        /** Populates the navigation bar with modules */
        const buildNavbar = () => {
            const container = q('#nav-links');
            container.innerHTML = USER_MODULES.map(mod => `
                <a href="#${mod.Code}" 
                   class="styled-nav-link nav-link" 
                   data-module-code="${mod.Code}">
                   ${mod.Module}
                </a>
            `).join('');
        };
        
        /** Hides all modules and shows the target one */
        const showModule = (moduleId) => {
            qA('.module-container').forEach(mod => mod.classList.add('hidden'));
            const targetModule = q(moduleId);
            if (targetModule) {
                targetModule.classList.remove('hidden');
                return true;
            }
            return false;
        };
        
        /** Updates active nav link */
        const updateActiveNavLink = (moduleCode) => {
            qA('.nav-link').forEach(link => {
                if (link.dataset.moduleCode === moduleCode) {
                    link.classList.add('styled-nav-link-active');
                    // Style it immediately
                    applyTailwindStyles(link);
                } else {
                    link.classList.remove('styled-nav-link-active', 'bg-blue-600', 'text-white');
                }
            });
        };
        
        /** Main application router */
        const router = () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const hash = window.location.hash;
            const loggedIn = isLoggedIn();
            
            updateUIForLoginState(); // Ensure UI is correct before routing
            
            let moduleCode = '';

            if (hash === '#MOD.A') {
                showModule('#module-MOD.A');
                moduleCode = 'MOD.A';
            } else if (code) {
                showModule('#module-MOD.B');
                initLoginModule(code);
                moduleCode = 'MOD.B';
            } else if (loggedIn) {
                moduleCode = hash.substring(1) || 'MOD.C'; // Default to Campaign Submission
                if (showModule('#module-' + moduleCode)) {
                    initLazyModule(moduleCode); // Lazy-load if needed
                } else {
                    // Fallback if hash is invalid
                    moduleCode = 'MOD.C';
                    showModule('#module-MOD.C');
                    initLazyModule(moduleCode);
                }
            } else {
                // Not logged in, no code -> show login
                showModule('#module-MOD.B');
                initLoginModule(null);
                moduleCode = 'MOD.B';
            }
            
            updateActiveNavLink(moduleCode);
        };
        
        /** Calls the initializer for lazy-loaded modules */
        const initLazyModule = (moduleCode) => {
            const moduleEl = q('#module-' + moduleCode);
            if (!moduleEl || moduleEl.dataset.initialized) {
                return; // Already initialized or doesn't exist
            }
            
            console.log(`Lazily initializing module: ${moduleCode}`);
            moduleEl.dataset.initialized = 'true';
            
            switch (moduleCode) {
                case 'MOD.C':
                    initCampaignSubmission();
                    break;
                case 'MAS.DemoCient':
                    initMasterDataModule(
                        'MAS.DemoCient',
                        'demoxpiclients',
                        'Demo Clients',
                        ['id', 'value', 'note', 'fincode', 'code']
                    );
                    break;
                case 'MAS.XPICFMapping':
                    initMasterDataModule(
                        'MAS.XPICFMapping',
                        'xpicfmapping',
                        'XPI Custom Field Mappings',
                        ['id', 'value', 'CF Name']
                    );
                    break;
            }
        };
        
        // --- Module Initializers ---

        /** Initializes Admin Module */
        const initAdminModule = () => {
            const input = q('#xpiBaseUrl');
            input.value = getXpiBaseUrl();
            
            const datalist = q('#xpiBaseUrl-suggestions');
            datalist.innerHTML = SUGGESTED_URLS.map(url => `<option value="${url}"></option>`).join('');
            
            q('#admin-form').addEventListener('submit', (e) => {
                e.preventDefault();
                setStorage('xpiBaseUrl', input.value);
                showToast('Configuration saved successfully!', 'success');
            });
        };

        /** Initializes Login Module (handles both modes) */
        const initLoginModule = async (code) => {
            const authMode = q('#login-auth-mode');
            const callbackMode = q('#login-callback-mode');
            const callbackMsg = q('#login-callback-message');
            const callbackTitle = q('#login-callback-title');
            const callbackError = q('#login-callback-error');
            const callbackSpinner = q('#login-callback-spinner');
            const startOverBtn = q('#login-start-over-btn');
            
            startOverBtn.onclick = () => {
                window.location.href = window.location.origin + window.location.pathname;
            };

            if (code) {
                // --- Callback Mode ---
                authMode.classList.add('hidden');
                callbackMode.classList.remove('hidden');
                
                const clientId = getStorage('clientId', 'session');
                if (!code || !clientId) {
                    callbackTitle.textContent = 'Authentication Error';
                    callbackMsg.textContent = 'Missing code or client ID. Redirecting...';
                    callbackSpinner.classList.add('hidden');
                    callbackError.textContent = 'Error: Required authentication parameters not found.';
                    callbackError.classList.remove('hidden');
                    setTimeout(() => startOverBtn.click(), 10000);
                    return;
                }
                
                try {
                    // 1. Exchange code for token
                    callbackTitle.textContent = 'Exchanging Token...';
                    const tokenUrl = `api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                    const tokenResponse = await apiFetch(tokenUrl, {}, 'none');
                    
                    if (!tokenResponse.success || !tokenResponse.data.token) {
                        throw new Error('Failed to retrieve token: ' + jsonToPretty(tokenResponse));
                    }
                    
                    const { token, credentials } = tokenResponse.data;
                    setStorage('token', token, 'session');
                    
                    // 2. Verify credentials by fetching profile
                    callbackTitle.textContent = 'Verifying Profile...';
                    const profileUrl = 'api/v1/wrikexpi/amoeba/wrikeapi/contacts?me';
                    const profileResponse = await apiFetch(profileUrl, {}, 'basic', credentials.username, credentials.password);
                    
                    if (!profileResponse.success || !profileResponse.data || profileResponse.data.length === 0) {
                        throw new Error('Failed to verify profile: ' + jsonToPretty(profileResponse));
                    }
                    
                    // 3. Success!
                    const profile = profileResponse.data[0];
                    setStorage('firstName', profile.firstName, 'session');
                    setStorage('lastName', profile.lastName, 'session');
                    setStorage('avatarUrl', profile.avatarUrl, 'session');
                    
                    // Clean up session
                    removeStorage('clientId', 'session');
                    
                    callbackTitle.textContent = 'Login Successful!';
                    callbackMsg.textContent = `Welcome, ${profile.firstName} ${profile.lastName}! Redirecting...`;
                    callbackSpinner.classList.add('hidden');
                    
                    // Clear query params and route to app
                    window.history.replaceState({}, document.title, window.location.pathname);
                    window.location.hash = '#MOD.C'; // Default to campaign
                    router(); // Re-run router to show app
                    
                } catch (err) {
                    callbackTitle.textContent = 'Login Failed';
                    callbackMsg.textContent = 'An unexpected error occurred. Please try again.';
                    callbackSpinner.classList.add('hidden');
                    callbackError.textContent = (typeof err === 'string' ? err : jsonToPretty(err));
                    callbackError.classList.remove('hidden');
                    startOverBtn.classList.remove('hidden');
                    // Clear potentially bad token
                    removeStorage('token', 'session');
                }

            } else {
                // --- Auth Mode ---
                authMode.classList.remove('hidden');
                callbackMode.classList.add('hidden');
                
                q('#login-auth-btn').onclick = async () => {
                    try {
                        showSpinner(true);
                        const timestamp = Date.now().toString();
                        const random = Math.random().toString();
                        const hash = await sha256(timestamp + random);
                        const clientId = hash.slice(-7);
                        
                        setStorage('clientId', clientId, 'session');
                        
                        const redirectUri = window.location.origin + window.location.pathname;
                        const authUrl = new URL(getXpiBaseUrl());
                        authUrl.searchParams.set('accountId', '3128883');
                        authUrl.searchParams.set('redirectUri', redirectUri);
                        authUrl.searchParams.set('client_id', clientId);
                        
                        // Redirect browser
                        window.location.href = authUrl.href;
                    } catch (e) {
                        showSpinner(false);
                        showToast('Could not generate client ID. Please try again.', 'error');
                        console.error('SHA-256 Error:', e);
                    }
                };
            }
        };
        
        /** Initializes Campaign Submission Module */
        const initCampaignSubmission = async () => {
            const form = q('#campaign-form');
            const submitBtn = q('#campaign-submit-btn');
            const resultPre = q('#campaign-result');
            
            // --- Dropdown Population ---
            const populateDropdown = async (elementId, endpoint, valueField = 'value') => {
                const select = q(elementId);
                try {
                    const data = await apiFetch(endpoint);
                    if (data && data.value) {
                        select.innerHTML = '<option value="">Please select...</option>'; // Clear loading
                        data.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item[valueField];
                            option.textContent = item[valueField];
                            select.appendChild(option);
                        });
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } catch (error) {
                    console.error(`Failed to load ${elementId}:`, error);
                    select.innerHTML = '<option value="">Error loading data</option>';
                }
            };
            
            showSpinner(true);
            try {
                await Promise.all([
                    populateDropdown('#client', 'api/v1/wrikexpi/v1.0/value/clients-grm-mys'),
                    populateDropdown('#debtor', 'api/v1/wrikexpi/v1.0/value/debtors-grm-mys'),
                    populateDropdown('#agency', 'api/v1/wrikexpi/v1.0/value/agencies')
                ]);
                // Pre-select default values
                q('#agency').value = 'Eightbar';
                q('#client').value = 'Adidas Group';
                q('#debtor').value = 'Adidas Malaysia Sdn Bhd';

            } catch (e) {
                showToast('Failed to load initial form data. Please refresh.', 'error');
            } finally {
                showSpinner(false);
            }
            
            // --- Tagging Interface ---
            const tagInput = q('#selectedchannels-input');
            const tagContainer = q('#selectedchannels-container');
            
            const addTag = (value) => {
                value = value.trim();
                if (!value) return;
                
                // Check if tag already exists
                if (Array.from(tagContainer.children).some(tag => tag.dataset.value === value)) {
                    tagInput.value = '';
                    return;
                }
                
                const tagEl = document.createElement('span');
                tagEl.className = 'styled-tag';
                tagEl.dataset.value = value;
                tagEl.innerHTML = `${value}<button type="button" class="styled-tag-remove" data-value="${value}">&times;</button>`;
                
                applyTailwindStyles(tagEl); // Style the new tag
                
                tagContainer.appendChild(tagEl);
                tagInput.value = '';
            };
            
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTag(tagInput.value);
                }
            });
            
            tagContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('styled-tag-remove')) {
                    e.target.parentElement.remove();
                }
            });

            // --- Form Submission ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                resultPre.classList.add('hidden');
                
                try {
                    const formData = new FormData(form);
                    const payload = {
                        type: formData.get('type'),
                        space: formData.get('space'),
                        entity: formData.get('entity'),
                        varientId: parseInt(formData.get('varientId')),
                        fields: {}
                    };
                    
                    // Populate fields
                    for (const [key, value] of formData.entries()) {
                        if (!['type', 'space', 'entity', 'varientId'].includes(key)) {
                            payload.fields[key] = value;
                        }
                    }
                    
                    // Get tags
                    const selectedChannels = Array.from(tagContainer.children).map(tag => tag.dataset.value);
                    payload.fields.selectedchannels = selectedChannels;
                    
                    // Send API Call
                    const response = await apiFetch('api/v1/wrikexpi/campaign', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    
                    resultPre.textContent = jsonToPretty(response);
                    resultPre.className = 'styled-pre styled-pre-success'; // Base + success
                    applyTailwindStyles(resultPre); // Re-style
                    showToast('Campaign submitted successfully!', 'success');
                    
                } catch (error) {
                    resultPre.textContent = `Error: ${jsonToPretty(error)}`;
                    resultPre.className = 'styled-pre styled-pre-error'; // Base + error
                    applyTailwindStyles(resultPre); // Re-style
                    showToast('Submission failed. Please check errors.', 'error');
                } finally {
                    resultPre.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Campaign';
                }
            });
        };
        
        /**
         * Initializes a Master Data module by cloning and wiring up the template.
         * @param {string} moduleCode - The module's code (e.g., 'MAS.DemoCient')
         * @param {string} slug - The API slug (e.g., 'demoxpiclients')
         * @param {string} title - The display title (e.g., 'Demo Clients')
         * @param {string[]} fields - Array of field names
         */
        const initMasterDataModule = (moduleCode, slug, title, fields) => {
            const container = q('#module-' + moduleCode);
            if (!container) return;
            
            // Clone the template
            const template = q('#master-data-template').content.cloneNode(true);
            const moduleRoot = template.firstElementChild;
            moduleRoot.dataset.slug = slug; // Store slug for handlers
            
            // Customize titles and headers
            moduleRoot.querySelector('.md-title').textContent = title;
            const thead = moduleRoot.querySelector('.md-table-head');
            thead.innerHTML = `
                <tr>
                    ${fields.map(f => `<th class="styled-th">${f}</th>`).join('')}
                    <th class="styled-th text-right">Actions</th>
                </tr>
            `;
            
            // Customize modal form
            const modalFieldsContainer = moduleRoot.querySelector('.md-modal-fields');
            modalFieldsContainer.innerHTML = fields
                .filter(f => f !== 'id') // 'id' is not editable
                .map(f => `
                    <div class="styled-input-group">
                        <label for="md-field-${slug}-${f}" class="styled-label">${f}</label>
                        <input type="${f.includes('date') ? 'date' : 'text'}" 
                               id="md-field-${slug}-${f}" 
                               name="${f}" 
                               class="styled-input"
                               ${f === 'value' ? 'required' : ''}>
                    </div>
                `).join('');
            
            // Append to the DOM
            container.innerHTML = ''; // Clear any existing content
            container.appendChild(template);
            
            // --- Attach Event Listeners (scoped to this new module) ---
            const loadBtn = container.querySelector('.md-load-btn');
            const createBtn = container.querySelector('.md-create-btn');
            const modal = container.querySelector('.md-modal');
            const modalForm = container.querySelector('.md-modal-form');
            const deleteModal = container.querySelector('.md-delete-modal');
            const deleteConfirmBtn = container.querySelector('.md-delete-confirm-btn');
            const tableBody = container.querySelector('.md-table-body');
            
            // Load
            loadBtn.addEventListener('click', () => loadMasterData(container, slug, fields));
            
            // Create
            createBtn.addEventListener('click', () => openMasterDataModal(container, slug, fields, null));
            
            // Save (Create/Update)
            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveMasterData(container, slug, fields);
            });
            
            // Delete
            deleteConfirmBtn.addEventListener('click', () => deleteMasterData(container, slug, fields));

            // Table-level delegation for Edit/Delete buttons
            tableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.md-edit-btn');
                const deleteBtn = e.target.closest('.md-delete-btn');
                
                if (editBtn) {
                    const record = JSON.parse(editBtn.dataset.record);
                    openMasterDataModal(container, slug, fields, record);
                }
                if (deleteBtn) {
                    const record = JSON.parse(deleteBtn.dataset.record);
                    openDeleteModal(container, record.id, record.value);
                }
            });

            // Modal close buttons
            container.querySelectorAll('.md-modal-close, .md-delete-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    deleteModal.classList.add('hidden');
                });
            });
            
            // --- Apply styles to the newly added DOM elements ---
            applyTailwindStyles(container);
        };
        
        /** (CRUD) Loads and renders master data */
        const loadMasterData = async (container, slug, fields) => {
            const tbody = container.querySelector('.md-table-body');
            tbody.innerHTML = `<tr><td class="styled-td text-center" colspan="100"><div class="spinner mx-auto"></div></td></tr>`;
            applyTailwindStyles(tbody.firstElementChild.firstElementChild); // Style the TD
            applyTailwindStyles(tbody.querySelector('.spinner')); // Style the spinner

            try {
                const data = await apiFetch(`api/v1/wrikexpi/v1.0/record/${slug}`);
                if (!data || !data.value || data.value.length === 0) {
                     tbody.innerHTML = `<tr><td class="styled-td text-center" colspan="100">No records found.</td></tr>`;
                     applyTailwindStyles(tbody.firstElementChild.firstElementChild);
                     return;
                }
                
                tbody.innerHTML = data.value.map(record => `
                    <tr class="hover:bg-gray-700/50">
                        ${fields.map(f => `<td class="styled-td">${record[f] || 'N/A'}</td>`).join('')}
                        <td class="styled-td text-right">
                            <button class="styled-btn-icon md-edit-btn" title="Edit" data-record='${JSON.stringify(record)}'>
                                <svg class="w-5 h-5" fill="currentColor"><use href="#icon-edit"></use></svg>
                            </button>
                            <button class="styled-btn-icon text-red-400 hover:text-red-300 md-delete-btn" title="Delete" data-record='${JSON.stringify(record)}'>
                                <svg class="w-5 h-5" fill="currentColor"><use href="#icon-trash"></use></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                applyTailwindStyles(tbody); // Style all new rows
                
            } catch (error) {
                tbody.innerHTML = `<tr><td class="styled-td text-center text-red-400" colspan="100">Error loading data.</td></tr>`;
                applyTailwindStyles(tbody.firstElementChild.firstElementChild);
                showToast('Failed to load data.', 'error');
            }
        };

        /** (CRUD) Opens the modal for creating or editing */
        const openMasterDataModal = (container, slug, fields, record) => {
            const modal = container.querySelector('.md-modal');
            const form = container.querySelector('.md-modal-form');
            const title = container.querySelector('.md-modal-title');
            
            form.reset();
            form.dataset.recordId = ''; // Clear ID
            
            if (record) {
                // Edit Mode
                title.textContent = 'Edit Record';
                form.dataset.recordId = record.id;
                fields.forEach(f => {
                    const input = form.querySelector(`[name="${f}"]`);
                    if (input) {
                        input.value = record[f] || '';
                    }
                });
            } else {
                // Create Mode
                title.textContent = 'Create New Record';
            }
            
            modal.classList.remove('hidden');
        };

        /** (CRUD) Saves a new or existing record */
        const saveMasterData = async (container, slug, fields) => {
            const form = container.querySelector('.md-modal-form');
            const modal = container.querySelector('.md-modal');
            const recordId = form.dataset.recordId;
            const isEdit = !!recordId;
            
            const payload = {
                "@odata.context": `${getXpiBaseUrl()}api/v1/v1.0/${slug}`
            };
            
            if (isEdit) {
                payload.id = recordId;
            }

            // Collect all fields from form
            fields.filter(f => f !== 'id').forEach(f => {
                const input = form.querySelector(`[name="${f}"]`);
                if (input) {
                    payload[f] = input.value;
                }
            });
            
            try {
                showSpinner(true);
                const method = isEdit ? 'PATCH' : 'POST';
                const url = `api/v1/wrikexpi/v1.0/record/${slug}`;
                
                await apiFetch(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });
                
                showToast(`Record ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
                modal.classList.add('hidden');
                loadMasterData(container, slug, fields); // Refresh list
                
            } catch (error) {
                console.error('Save error:', error);
                showToast(`Error: ${jsonToPretty(error.message || error)}`, 'error');
            } finally {
                showSpinner(false);
            }
        };
        
        /** (CRUD) Opens the delete confirmation modal */
        const openDeleteModal = (container, recordId, recordValue) => {
            const deleteModal = container.querySelector('.md-delete-modal');
            container.querySelector('.md-delete-record-name').textContent = recordValue;
            container.querySelector('.md-delete-confirm-btn').dataset.deleteId = recordId;
            deleteModal.classList.remove('hidden');
        };
        
        /** (CRUD) Deletes a record */
        const deleteMasterData = async (container, slug, fields) => {
            const deleteModal = container.querySelector('.md-delete-modal');
            const recordId = container.querySelector('.md-delete-confirm-btn').dataset.deleteId;
            
            if (!recordId) return;
            
            try {
                showSpinner(true);
                await apiFetch(`api/v1/wrikexpi/v1.0/record/${slug}/${recordId}`, {
                    method: 'DELETE'
                });
                
                showToast('Record deleted successfully!', 'success');
                deleteModal.classList.add('hidden');
                loadMasterData(container, slug, fields); // Refresh list
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast(`Error deleting record: ${jsonToPretty(error.message || error)}`, 'error');
            } finally {
                showSpinner(false);
            }
        };
        

        // --- App Initialization ---

        const initApp = () => {
            // Apply Tailwind styles to all initial placeholder classes
            applyTailwindStyles();
            
            // Initialize non-lazy modules
            initAdminModule();
            initDevTool();
            
            // Build navigation
            buildNavbar();
            
            // Add global event listeners
            window.addEventListener('hashchange', router);
            
            q('#logout-link').addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                // Reset to login page
                window.history.replaceState(null, '', window.location.pathname);
                router();
            });
            
            q('#nav-toggle-btn').addEventListener('click', () => {
                const nav = q('#navbar');
                const main = q('#main-content');
                nav.classList.toggle('-ml-64');
                main.classList.toggle('ml-0');
            });
            
            // Run initial route
            router();
        };

        // Run the app
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
