<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind & Import Inter font -->
    <style type="text/tailwindcss">
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="h-full bg-gray-900 text-gray-200 antialiased">

    <!-- App Container -->
    <div class="flex h-full overflow-hidden">

        <!-- ===== Navigation Sidebar ===== -->
        <nav id="nav-bar" class="bg-gray-800 w-64 flex-col flex-shrink-0 transition-all duration-300 ease-in-out -translate-x-full md:translate-x-0 md:flex hidden">
            <!-- Nav Header & Toggle -->
            <div class="flex items-center justify-between h-16 px-4 border-b border-gray-700 flex-shrink-0">
                <span class="text-xl font-bold text-white">XPI Portal</span>
                <button id="nav-toggle-btn-sidebar" class="p-1 rounded-md md:hidden hover:bg-gray-700" title="Hide Navigation">
                    <!-- SVG: List (menu) -->
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                    </svg>
                </button>
            </div>
            
            <!-- Nav Links -->
            <div id="nav-links-container" class="flex-1 overflow-y-auto py-4">
                <!-- User-defined modules will be injected here -->
            </div>

            <!-- User Profile (Bottom) -->
            <div id="user-profile-display" class="p-4 border-t border-gray-700 hidden">
                <div class="flex items-center space-x-3">
                    <img id="user-avatar" src="https://placehold.co/40x40/6b7280/ffffff?text=X" alt="User Avatar" class="w-10 h-10 rounded-full bg-gray-600">
                    <div>
                        <div id="user-name" class="font-semibold text-sm text-white">Not Logged In</div>
                        <a href="#" id="logout-link" class="text-xs text-red-400 hover:text-red-300">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ===== Main Content Area ===== -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Top bar with Nav Toggle (for mobile/hidden state) -->
            <div class="flex items-center h-16 px-4 bg-gray-800 border-b border-gray-700 md:hidden flex-shrink-0">
                <button id="nav-toggle-btn-main" class="p-1 rounded-md hover:bg-gray-700" title="Show Navigation">
                    <!-- SVG: List (menu) -->
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                    </svg>
                </button>
                <span class="text-xl font-bold text-white ml-4 md:hidden">XPI Portal</span>
            </div>

            <!-- Module Content -->
            <div id="module-container" class="flex-1 overflow-y-auto p-4 md:p-8">
                <!-- Modules will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <!-- ===== Module Templates (Hidden) ===== -->
    
    <!-- Template: Login Module -->
    <template id="login-module-template">
        <div data-module-id="MOD.B" class="max-w-md mx-auto bg-gray-800 rounded-lg shadow-xl p-8 mt-10">
            <h2 class="text-3xl font-bold text-center text-white mb-6">XPI Portal Login</h2>
            
            <!-- Mode 1: Login Button -->
            <div id="login-mode-auth">
                <p class="text-center text-gray-400 mb-6">Please log in to access the portal.</p>
                <button id="login-auth-button" class="styled-btn-primary w-full">Login & Authenticate</button>
            </div>

            <!-- Mode 2: Callback/Loading -->
            <div id="login-mode-callback" class="hidden">
                <div class="flex flex-col items-center justify-center">
                    <div class="loader w-12 h-12 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin mb-4"></div>
                    <p class="text-lg text-gray-300">Authenticating, please wait...</p>
                </div>
            </div>

            <!-- Error/Result Display -->
            <div id="login-result-container" class="mt-6 hidden">
                <p id="login-result-message" class_="text-center mb-4"></p>
                <pre id="login-result-json" class="bg-gray-900 text-sm p-4 rounded-md overflow-auto max-h-60"></pre>
                <button id="login-start-over-button" class="styled-btn-secondary w-full mt-4 hidden">Start Over</button>
            </div>
        </div>
    </template>

    <!-- Template: Admin Module -->
    <template id="admin-module-template">
        <div data-module-id="MOD.A" class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold text-white mb-8">Admin: Global Configuration</h2>
            <div class="bg-gray-800 rounded-lg shadow-xl p-8">
                <form id="admin-config-form">
                    <div class="mb-6">
                        <label for="config-xpiBaseUrl" class="block text-sm font-medium text-gray-300 mb-2">XPI Base URL</label>
                        <input type="url" id="config-xpiBaseUrl" list="xpiBaseUrl-suggestions" class="styled-input w-full" placeholder="https://xpi-api.example.com/">
                        <datalist id="xpiBaseUrl-suggestions">
                            <option value="https://api.wrikexpi.groupm.com"></option>
                            <option value="https://xpi-api.gowrike.space/"></option>
                        </datalist>
                        <p class="text-xs text-gray-500 mt-2">Base URL for all XPI API calls.</p>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="styled-btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Template: Campaign Submission Module -->
    <template id="campaign-submission-module-template">
        <div data-module-id="MOD.C" class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-bold text-white mb-8">Campaign Submission</h2>
            
            <!-- Module Loader -->
            <div id="campaign-loader" class="flex flex-col items-center justify-center p-10 bg-gray-800 rounded-lg shadow-xl">
                <div class="loader w-12 h-12 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin mb-4"></div>
                <p class="text-lg text-gray-300">Loading campaign data...</p>
                <p id="campaign-loader-error" class="text-red-400 mt-2 hidden"></p>
            </div>

            <!-- Form -->
            <form id="campaign-form" class="hidden bg-gray-800 rounded-lg shadow-xl p-8">
                <!-- Hidden Fields -->
                <input type="hidden" name="type" value="Campaign Request">
                <input type="hidden" name="space" value="GRM-MYS-GMN">
                <input type="hidden" name="entity" value="Campaign">
                <input type="hidden" name="varientId" value="1">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Dynamic Fields -->
                    <div>
                        <label for="campaign-campaignname" class="styled-label">Campaign Name</label>
                        <input type="text" id="campaign-campaignname" name="campaignname" class="styled-input" value="World Pinball Day 7000">
                    </div>
                    <div>
                        <label for="campaign-client" class="styled-label">Client</label>
                        <select id="campaign-client" name="client" class="styled-input">
                            <option value="Adidas Group">Adidas Group</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label for="campaign-debtor" class="styled-label">Debtor</label>
                        <select id="campaign-debtor" name="debtor" class="styled-input">
                             <option value="Adidas Malaysia Sdn Bhd">Adidas Malaysia Sdn Bhd</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="campaign-agency" class="styled-label">Agency</label>
                        <select id="campaign-agency" name="agency" class="styled-input">
                            <option value="Eightbar">Eightbar</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label for="campaign-brand" class="styled-label">Brand</label>
                        <input type="text" id="campaign-brand" name="brand" class="styled-input" value="World Pinball">
                    </div>
                    <div>
                        <label for="campaign-requestedstartdate" class="styled-label">Requested Start Date</label>
                        <input type="date" id="campaign-requestedstartdate" name="requestedstartdate" class="styled-input" value="2026-07-01">
                    </div>
                    <div>
                        <label for="campaign-campaignstartdate" class="styled-label">Campaign Start Date</label>
                        <input type="date" id="campaign-campaignstartdate" name="campaignstartdate" class="styled-input" value="2026-08-29">
                    </div>
                    <div>
                        <label for="campaign-campaignenddate" class="styled-label">Campaign End Date</label>
                        <input type="date" id="campaign-campaignenddate" name="campaignenddate" class="styled-input" value="2026-10-29">
                    </div>
                    <div>
                        <label for="campaign-currency" class="styled-label">Currency</label>
                        <input type="text" id="campaign-currency" name="currency" class="styled-input" value="SGD">
                    </div>
                    <div>
                        <label for="campaign-pod" class="styled-label">Pod</label>
                        <input type="text" id="campaign-pod" name="pod" class="styled-input" value="Pod 1A">
                    </div>
                    <div>
                        <label for="campaign-campaignobjective" class="styled-label">Campaign Objective</label>
                        <input type="text" id="campaign-campaignobjective" name="campaignobjective" class="styled-input" value="Upper Funnel / Awareness">
                    </div>
                    <div>
                        <label for="campaign-requestormarket" class="styled-label">Requestor Market</label>
                        <input type="text" id="campaign-requestormarket" name="requestormarket" class="styled-input" value="Singapore">
                    </div>
                     <div>
                        <label for="campaign-optin" class="styled-label">Opt-in</label>
                        <select id="campaign-optin" name="optin" class="styled-input">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div>
                        <label for="campaign-porequired" class="styled-label">PO Required</label>
                        <select id="campaign-porequired" name="porequired" class="styled-input">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div>
                        <label for="campaign-overallbudget" class="styled-label">Overall Budget</label>
                        <input type="number" id="campaign-overallbudget" name="overallbudget" class="styled-input" value="100">
                    </div>

                    <!-- Tagging Interface for Selected Channels -->
                    <div class="md:col-span-2">
                        <label for="campaign-channels-input" class="styled-label">Selected Channels</label>
                        <div class="styled-input flex flex-wrap gap-2 p-2">
                            <div id="campaign-channels-container" class="flex flex-wrap gap-2">
                                <!-- Default Tag -->
                                <span class="channel-tag flex items-center bg-blue-600 text-white text-sm font-medium px-3 py-1 rounded-full">
                                    Twitter
                                    <button type="button" class="ml-2 text-blue-200 hover:text-white">&times;</button>
                                </span>
                            </div>
                            <input type="text" id="campaign-channels-input" class="bg-transparent flex-1 focus:outline-none min-w-[100px]" placeholder="Type channel & press Enter...">
                        </div>
                    </div>
                </div>

                <!-- Submission -->
                <div class="mt-8 flex justify-end">
                    <button type="submit" id="campaign-submit-btn" class="styled-btn-primary">
                        Submit Campaign
                    </button>
                </div>

                <!-- Result Display -->
                <div id="campaign-result-container" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold mb-2">Submission Result:</h3>
                    <pre id="campaign-result-json" class="bg-gray-900 text-sm p-4 rounded-md overflow-auto max-h-80"></pre>
                </div>
            </form>
        </div>
    </template>

    <!-- Template: Master Data Management Module -->
    <template id="master-data-module-template">
        <div data-module-id="" class="max-w-7xl mx-auto"> <!-- module-id set by JS -->
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-4xl font-bold text-white module-title">Master Data</h2>
                <div class="space-x-2">
                    <button class="styled-btn-secondary md-load-btn">
                        <!-- SVG: Arrow Clockwise (reload) -->
                        <svg class="w-5 h-5 inline-block -mt-1" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                        </svg>
                        Load Data
                    </button>
                    <button class="styled-btn-primary md-create-btn">
                        <!-- SVG: Plus -->
                        <svg class="w-5 h-5 inline-block -mt-1" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                        </svg>
                        Create New
                    </button>
                </div>
            </div>

            <!-- Loader/Error Display -->
            <div class="md-loader-container text-center p-10 bg-gray-800 rounded-lg shadow-xl hidden">
                <div class="loader w-12 h-12 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-lg text-gray-300">Loading data...</p>
            </div>
            <div class="md-error-container p-6 bg-red-800 border border-red-600 rounded-lg text-red-200 hidden"></div>

            <!-- Data Table -->
            <div class="md-table-container bg-gray-800 rounded-lg shadow-xl overflow-hidden hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <!-- Headers dynamically inserted by JS -->
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <!-- Rows dynamically inserted by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>


    <!-- ===== Global UI Components ===== -->

    <!-- Full Page Loader -->
    <div id="full-page-loader" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[99] hidden">
        <div class="loader w-16 h-16 border-8 border-t-blue-500 border-gray-600 rounded-full animate-spin"></div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-3">
        <!-- Toasts are dynamically added here -->
    </div>

    <!-- Generic Modal (for Master Data CRUD) -->
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative m-4 max-h-[90vh] flex flex-col">
            <h3 id="generic-modal-title" class="text-2xl font-bold text-white mb-6">Modal Title</h3>
            
            <!-- Close Button -->
            <button id="generic-modal-close" class="absolute top-4 right-4 p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <!-- SVG: X -->
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </button>

            <!-- Modal Content: Form -->
            <form id="generic-modal-form" class="flex-1 overflow-y-auto pr-2 -mr-2">
                <!-- Form fields will be dynamically inserted here -->
            </form>

            <!-- Modal Content: Delete Confirmation -->
            <div id="generic-modal-delete-confirm" class="hidden">
                <p class="text-lg text-gray-300">Are you sure you want to delete this record?</p>
                <p id="generic-modal-delete-item" class="text-xl font-semibold text-white my-4 p-4 bg-gray-700 rounded-md"></p>
                <p class="text-sm text-red-400">This action cannot be undone.</p>
            </div>

            <!-- Modal Footer -->
            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-end space-x-3">
                <button id="generic-modal-btn-cancel" class="styled-btn-secondary">Cancel</button>
                <button id="generic-modal-btn-save" class="styled-btn-primary">Save Changes</button>
                <button id="generic-modal-btn-delete" class="styled-btn-danger hidden">Delete Record</button>
            </div>
        </div>
    </div>


    <!-- ===== Developer Tool ===== -->
    <button id="dev-tool-toggle" class="fixed bottom-4 right-4 p-3 rounded-full bg-blue-600 text-white hover:bg-blue-500 shadow-lg z-50" title="Toggle Developer Tool">
        <!-- SVG: Braces (dev tool icon) -->
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 2.5A1.5 1.5 0 0 1 2 1h12a1.5 1.5 0 0 1 1.5 1.5v11A1.5 1.5 0 0 1 14 15H2a1.5 1.5 0 0 1-1.5-1.5zM2 2a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5v-11a.5.5 0 0 0-.5-.5z"/>
            <path d="M6.854 4.854a.5.5 0 0 0 0 .708L4.707 7.707l2.147 2.147a.5.5 0 0 0 .708.708l-3-3a.5.5 0 0 0 0-.708l3-3a.5.5 0 0 0 .708 0m2.292 0a.5.5 0 0 1 0 .708L11.293 7.707l-2.147 2.147a.5.5 0 0 1-.708.708l3-3a.5.5 0 0 1 0-.708l-3-3a.5.5 0 0 1-.708 0"/>
        </svg>
    </button>

    <!-- Dev Tool Modal -->
    <div id="dev-tool-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-[90vw] h-[90vh] max-w-7xl flex flex-col p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-2xl font-bold text-white">Developer Tool: API Log</h3>
                <div class="space-x-2">
                    <button id="dev-tool-purge" class="p-2 rounded-md text-gray-400 hover:bg-red-800 hover:text-red-200" title="Purge All Logs">
                        <!-- SVG: Trash -->
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                        </svg>
                    </button>
                    <button id="dev-tool-close" class="p-2 rounded-md text-gray-400 hover:bg-gray-700 hover:text-white" title="Close">
                        <!-- SVG: X -->
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Log Table -->
            <div class="flex-1 overflow-auto rounded-md border border-gray-700">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Timestamp</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Method</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">URL</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Request</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Response</th>
                        </tr>
                    </thead>
                    <tbody id="dev-tool-log-body" class="divide-y divide-gray-700">
                        <!-- Logs dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dev Tool Payload Viewer Modal -->
    <div id="payload-viewer-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[70] hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-[70vw] h-[80vh] max-w-4xl flex flex-col p-6">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="payload-viewer-title" class="text-2xl font-bold text-white">Payload</h3>
                <button id="payload-viewer-close" class="p-2 rounded-md text-gray-400 hover:bg-gray-700 hover:text-white" title="Close">
                    <!-- SVG: X -->
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                </button>
            </div>
            <pre id="payload-viewer-content" class="flex-1 bg-gray-900 text-sm p-4 rounded-md overflow-auto"></pre>
        </div>
    </div>


    <!-- ===== JavaScript ===== -->
    <script>
        /**
         * XPI Portal Application
         * Main application script.
         */
        document.addEventListener('DOMContentLoaded', () => {

            // --- Core Application State ---

            const XPIApp = {
                // Global Configuration (from localStorage)
                config: {
                    xpiBaseUrl: 'https://xpi-api.gowrike.space/'
                },
                // Session Data (from sessionStorage)
                session: {
                    token: null,
                    clientId: null,
                    userProfile: {
                        firstName: '',
                        lastName: '',
                        avatarUrl: ''
                    }
                },
                // Module Definitions
                moduleConfig: [
                    { code: 'MOD.A', name: 'Admin', type: 'Built-in', icon: null },
                    { code: 'MOD.B', name: 'Login', type: 'Built-in', icon: null },
                    { code: 'MOD.C', name: 'Campaign Submission', type: 'User-defined', icon: 'campaign' },
                    { code: 'MAS.DemoCient', name: 'Demo Client', type: 'User-defined', icon: 'data' },
                    { code: 'MAS.XPICFMapping', name: 'XPI Field Mapping', type: 'User-defined', icon: 'data' }
                ],
                // Master Data Module specific configurations
                masterDataConfigs: {
                    'MAS.DemoCient': {
                        slug: 'demoxpiclients',
                        fields: ['id', 'value', 'note', 'fincode', 'code'],
                        odataContext: 'https://api.wrikexpi.groupm.com/api/v1/v1.0/demoxpiclients' // Guessing, but required by spec
                    },
                    'MAS.XPICFMapping': {
                        slug: 'xpicfmapping',
                        fields: ['id', 'value', 'CF Name'],
                        odataContext: 'https://api.wrikexpi.groupm.com/api/v1/v1.0/xpicfmapping' // Guessing
                    }
                },
                // Developer Tool Logs (from localStorage)
                devLogs: [],
                // Tracks which lazy-loaded modules have been initialized
                initializedModules: new Set(),
                // Tracks active API calls for Master Data loaders
                activeMasterDataFetches: {}
            };

            // --- UI Element Selectors (cached) ---
            const $ui = {
                navBar: document.getElementById('nav-bar'),
                navToggleSidebar: document.getElementById('nav-toggle-btn-sidebar'),
                navToggleMain: document.getElementById('nav-toggle-btn-main'),
                navLinksContainer: document.getElementById('nav-links-container'),
                userProfileDisplay: document.getElementById('user-profile-display'),
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                logoutLink: document.getElementById('logout-link'),
                moduleContainer: document.getElementById('module-container'),
                fullPageLoader: document.getElementById('full-page-loader'),
                toastContainer: document.getElementById('toast-container'),
                devToolToggle: document.getElementById('dev-tool-toggle'),
                devToolModal: document.getElementById('dev-tool-modal'),
                devToolClose: document.getElementById('dev-tool-close'),
                devToolPurge: document.getElementById('dev-tool-purge'),
                devToolLogBody: document.getElementById('dev-tool-log-body'),
                payloadViewerModal: document.getElementById('payload-viewer-modal'),
                payloadViewerTitle: document.getElementById('payload-viewer-title'),
                payloadViewerContent: document.getElementById('payload-viewer-content'),
                payloadViewerClose: document.getElementById('payload-viewer-close'),
                genericModal: {
                    el: document.getElementById('generic-modal'),
                    title: document.getElementById('generic-modal-title'),
                    closeBtn: document.getElementById('generic-modal-close'),
                    form: document.getElementById('generic-modal-form'),
                    deleteConfirm: document.getElementById('generic-modal-delete-confirm'),
                    deleteItem: document.getElementById('generic-modal-delete-item'),
                    cancelBtn: document.getElementById('generic-modal-btn-cancel'),
                    saveBtn: document.getElementById('generic-modal-btn-save'),
                    deleteBtn: document.getElementById('generic-modal-btn-delete'),
                }
            };


            // --- Tailwind Placeholder Class Replacer ---

            /**
             * Defines the Tailwind strings for placeholder classes.
             * This centralization makes styling consistent and easy to update.
             */
            const tailwindStyleMap = {
                'styled-input': 'block w-full bg-gray-700 border border-gray-600 text-gray-200 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-600 disabled:opacity-70',
                'styled-label': 'block text-sm font-medium text-gray-300 mb-2',
                'styled-btn-primary': 'inline-flex justify-center items-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-semibold text-sm text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed',
                'styled-btn-secondary': 'inline-flex justify-center items-center px-4 py-2 bg-gray-600 border border-transparent rounded-md font-semibold text-sm text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-900 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed',
                'styled-btn-danger': 'inline-flex justify-center items-center px-4 py-2 bg-red-600 border border-transparent rounded-md font-semibold text-sm text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-900 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed',
                'styled-btn-link': 'text-blue-400 hover:text-blue-300 hover:underline text-sm'
            };

            /**
             * Replaces placeholder classes (e.g., 'styled-input') with full Tailwind class strings.
             * This MUST run before any module cloning to style templates correctly.
             * It preserves any other classes on the element.
             */
            function applyTailwindStyles() {
                Object.keys(tailwindStyleMap).forEach(placeholder => {
                    const elements = document.querySelectorAll(`.${placeholder}`);
                    const replacementString = tailwindStyleMap[placeholder];
                    
                    elements.forEach(el => {
                        // Use a regex to replace the placeholder, ensuring it's a standalone class
                        const regex = new RegExp(`(^|\\s)${placeholder}(\\s|$)`, 'g');
                        el.className = el.className.replace(regex, `$1${replacementString}$2`);
                    });
                });
            }


            // --- Core App Logic (Init, Config, Session) ---

            /**
             * Main initialization function.
             */
            function init() {
                // 1. Apply Tailwind styles FIRST
                applyTailwindStyles();
                
                // 2. Load config & session
                loadConfig();
                loadSession();
                loadDevLogs();

                // 3. Build static UI
                buildNavigation();
                updateUserProfileUI();

                // 4. Register global event listeners
                registerGlobalEventListeners();

                // 5. Initial routing
                handleRouting();

                // 6. Listen for route changes
                window.addEventListener('hashchange', handleRouting);
            }

            /**
             * Loads configuration from localStorage.
             */
            function loadConfig() {
                const storedConfig = localStorage.getItem('XPIApp_config');
                if (storedConfig) {
                    try {
                        XPIApp.config = { ...XPIApp.config, ...JSON.parse(storedConfig) };
                    } catch (e) {
                        console.error("Failed to parse stored config:", e);
                        localStorage.removeItem('XPIApp_config');
                    }
                }
            }

            /**
             * Saves configuration to localStorage.
             */
            function saveConfig() {
                localStorage.setItem('XPIApp_config', JSON.stringify(XPIApp.config));
                showToast('Configuration saved!', 'success');
            }

            /**
             * Loads session data from sessionStorage.
             */
            function loadSession() {
                const token = sessionStorage.getItem('XPIApp_token');
                const clientId = sessionStorage.getItem('XPIApp_clientId');
                const userProfile = sessionStorage.getItem('XPIApp_userProfile');

                if (token) XPIApp.session.token = token;
                if (clientId) XPIApp.session.clientId = clientId;
                if (userProfile) {
                    try {
                        XPIApp.session.userProfile = JSON.parse(userProfile);
                    } catch (e) {
                        console.error("Failed to parse user profile:", e);
                        sessionStorage.removeItem('XPIApp_userProfile');
                    }
                }
            }

            /**
             * Clears all session data (on logout).
             */
            function clearSession() {
                XPIApp.session.token = null;
                XPIApp.session.clientId = null;
                XPIApp.session.userProfile = { firstName: '', lastName: '', avatarUrl: '' };

                sessionStorage.removeItem('XPIApp_token');
                sessionStorage.removeItem('XPIApp_clientId');
                sessionStorage.removeItem('XPIApp_userProfile');
            }


            // --- UI & Utility Functions ---

            /**
             * Toggles the visibility of the main navigation bar.
             */
            function toggleNav() {
                $ui.navBar.classList.toggle('hidden');
                $ui.navBar.classList.toggle('md:flex');
                $ui.navBar.classList.toggle('-translate-x-full');
                $ui.navBar.classList.toggle('md:translate-x-0');
            }

            /**
             * Populates the navigation bar with links from moduleConfig.
             */
            function buildNavigation() {
                const userModules = XPIApp.moduleConfig.filter(m => m.type === 'User-defined');
                $ui.navLinksContainer.innerHTML = userModules.map(m => `
                    <a href="#${m.code}" 
                       class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white flex items-center px-4 py-3 text-sm font-medium"
                       data-module-id="${m.code}">
                        <!-- You can add SVGs here based on m.icon -->
                        <span class="truncate">${m.name}</span>
                    </a>
                `).join('');
            }

            /**
             * Updates the user profile display with session data.
             */
            function updateUserProfileUI() {
                if (XPIApp.session.token && XPIApp.session.userProfile.firstName) {
                    $ui.userProfileDisplay.classList.remove('hidden');
                    $ui.userName.textContent = `${XPIApp.session.userProfile.firstName} ${XPIApp.session.userProfile.lastName}`;
                    $ui.userAvatar.src = XPIApp.session.userProfile.avatarUrl || 'https://placehold.co/40x40/6b7280/ffffff?text=X';
                    $ui.userAvatar.onerror = () => { $ui.userAvatar.src = 'https://placehold.co/40x40/6b7280/ffffff?text=X' };
                } else {
                    $ui.userProfileDisplay.classList.add('hidden');
                    $ui.userName.textContent = 'Not Logged In';
                    $ui.userAvatar.src = 'https://placehold.co/40x40/6b7280/ffffff?text=X';
                }
            }
            
            /**
             * Shows or hides the full-page loader.
             * @param {boolean} show - True to show, false to hide.
             */
            function showLoader(show) {
                if (show) {
                    $ui.fullPageLoader.classList.remove('hidden');
                } else {
                    $ui.fullPageLoader.classList.add('hidden');
                }
            }

            /**
             * Displays a toast notification.
             * @param {string} message - The message to display.
             * @param {'success' | 'error' | 'info'} type - The type of toast.
             */
            function showToast(message, type = 'info') {
                const colors = {
                    success: 'bg-green-600 border-green-700',
                    error: 'bg-red-600 border-red-700',
                    info: 'bg-blue-600 border-blue-700'
                };
                const toast = document.createElement('div');
                toast.className = `p-4 rounded-lg shadow-lg text-white border-l-4 ${colors[type]} transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
                toast.textContent = message;
                
                $ui.toastContainer.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 5000);
            }

            /**
             * Clones a template and appends it to the module container.
             * @param {string} templateId - The ID of the <template> element.
             * @returns {HTMLElement} The cloned and appended element.
             */
            function cloneTemplate(templateId) {
                const template = document.getElementById(templateId);
                if (!template) {
                    console.error(`Template with id "${templateId}" not found.`);
                    return null;
                }
                const clone = template.content.firstElementChild.cloneNode(true);
                $ui.moduleContainer.appendChild(clone);
                return clone;
            }

            /**
             * Generates a SHA-256 hash.
             * @param {string} message - The string to hash.
             * @returns {Promise<string>} A hex-encoded hash string.
             */
            async function sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            /**
             * Formats a JSON object string for display.
             * @param {any} data - The data to format.
             * @returns {string} A pretty-printed JSON string or the original data as a string.
             */
            function formatJsonForDisplay(data) {
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        return data; // Not JSON, return as-is
                    }
                }
                if (typeof data === 'object' && data !== null) {
                    return JSON.stringify(data, null, 2);
                }
                return String(data);
            }


            // --- Global Event Listeners ---

            /**
             * Registers all non-module-specific event listeners.
             */
            function registerGlobalEventListeners() {
                // Nav Toggles
                $ui.navToggleSidebar.addEventListener('click', toggleNav);
                $ui.navToggleMain.addEventListener('click', toggleNav);

                // Logout
                $ui.logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearSession();
                    updateUserProfileUI();
                    XPIApp.initializedModules.clear(); // Clear lazy-loaded modules
                    location.hash = '#MOD.B'; // Redirect to login
                });

                // Dev Tool
                $ui.devToolToggle.addEventListener('click', DevTool.toggle);
                $ui.devToolClose.addEventListener('click', DevTool.hide);
                $ui.devToolPurge.addEventListener('click', DevTool.purgeLogs);

                // Payload Viewer
                $ui.payloadViewerClose.addEventListener('click', DevTool.hidePayloadViewer);

                // Generic Modal
                $ui.genericModal.closeBtn.addEventListener('click', () => Modal.hide());
                $ui.genericModal.cancelBtn.addEventListener('click', () => Modal.hide());
            }

            
            // --- Developer Tool Module ---

            const DevTool = {
                isOpen: false,
                
                toggle() {
                    if (this.isOpen) {
                        this.hide();
                    } else {
                        this.show();
                    }
                },
                
                show() {
                    this.isOpen = true;
                    this.renderLogs();
                    $ui.devToolModal.classList.remove('hidden');
                },
                
                hide() {
                    this.isOpen = false;
                    $ui.devToolModal.classList.add('hidden');
                },
                
                renderLogs() {
                    $ui.devToolLogBody.innerHTML = ''; // Clear existing
                    if (this.devLogs.length === 0) {
                        $ui.devToolLogBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No API calls logged.</td></tr>';
                        return;
                    }

                    // Show in reverse chronological order
                    [...XPIApp.devLogs].reverse().forEach((log, index) => {
                        // Handle potential errors in log entries
                        try {
                            const timestamp = new Date(log.timestamp).toLocaleString();
                            const statusColor = log.status >= 400 ? 'text-red-400' : (log.status >= 300 ? 'text-yellow-400' : (log.status >= 200 ? 'text-green-400' : 'text-gray-400'));
                            
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-700';
                            row.innerHTML = `
                                <td class="px-4 py-3 text-sm text-gray-300 whitespace-nowrap">${timestamp}</td>
                                <td class="px-4 py-3 text-sm font-medium ${statusColor}">${log.status || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-gray-300 whitespace-nowrap">${log.method || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-gray-300 max-w-xs truncate" title="${log.url || ''}">${log.url || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm"></td>
                                <td class="px-4 py-3 text-sm"></td>
                            `;
                            
                            // Add Request payload button
                            const reqBtn = document.createElement('button');
                            reqBtn.className = 'styled-btn-link';
                            reqBtn.textContent = 'View';
                            reqBtn.disabled = !log.requestPayload;
                            if (log.requestPayload) {
                                reqBtn.onclick = () => this.showPayloadViewer('Request Payload', log.requestPayload);
                            }
                            row.children[4].appendChild(reqBtn);

                            // Add Response payload button
                            const resBtn = document.createElement('button');
                            resBtn.className = 'styled-btn-link';
                            resBtn.textContent = 'View';
                            resBtn.disabled = !log.responsePayload;
                            if (log.responsePayload) {
                                resBtn.onclick = () => this.showPayloadViewer('Response Payload', log.responsePayload);
                            }
                            row.children[5].appendChild(resBtn);
                            
                            $ui.devToolLogBody.appendChild(row);
                        
                        } catch (e) {
                            console.error("Failed to render log entry:", e, log);
                            const errorRow = document.createElement('tr');
                            errorRow.innerHTML = `<td colspan="6" class="p-4 text-center text-red-400">Failed to render log entry. See console.</td>`;
                            $ui.devToolLogBody.appendChild(errorRow);
                        }
                    });
                },
                
                purgeLogs() {
                    XPIApp.devLogs = [];
                    localStorage.removeItem('XPIApp_devLogs');
                    this.renderLogs();
                    showToast('Developer logs purged!', 'info');
                },

                showPayloadViewer(title, payload) {
                    $ui.payloadViewerTitle.textContent = title;
                    $ui.payloadViewerContent.textContent = formatJsonForDisplay(payload);
                    $ui.payloadViewerModal.classList.remove('hidden');
                },

                hidePayloadViewer() {
                    $ui.payloadViewerModal.classList.add('hidden');
                }
            };

            /**
             * Loads logs from localStorage.
             */
            function loadDevLogs() {
                const storedLogs = localStorage.getItem('XPIApp_devLogs');
                if (storedLogs) {
                    try {
                        XPIApp.devLogs = JSON.parse(storedLogs);
                    } catch (e) {
                        console.error("Failed to parse dev logs:", e);
                        localStorage.removeItem('XPIApp_devLogs');
                    }
                }
            }

            /**
             * Saves logs to localStorage.
             */
            function saveDevLogs() {
                // Limit log size to prevent localStorage overflow (e.g., last 100)
                const maxLogs = 100;
                if (XPIApp.devLogs.length > maxLogs) {
                    XPIApp.devLogs = XPIApp.devLogs.slice(XPIApp.devLogs.length - maxLogs);
                }
                localStorage.setItem('XPIApp_devLogs', JSON.stringify(XPIApp.devLogs));
            }


            // --- API Fetch Wrapper (with Logging) ---

            /**
             * Centralized fetch wrapper that logs requests and responses.
             * @param {string} url - The URL to fetch.
             * @param {object} options - The fetch options (method, headers, body).
             * @returns {Promise<Response>} The fetch Response object.
             */
            async function apiFetch(url, options = {}) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    method: options.method || 'GET',
                    url: url,
                    status: null,
                    requestPayload: null,
                    responsePayload: null
                };

                // Scrub Authorization header and log request
                if (options.headers) {
                    const headersCopy = { ...options.headers };
                    if (headersCopy['Authorization']) {
                        headersCopy['Authorization'] = 'Bearer [REDACTED]';
                    }
                    if (headersCopy['authorization']) {
                         headersCopy['authorization'] = 'Basic [REDACTED]';
                    }
                    // We don't log headers, but we scrubbed them if we did.
                }
                
                // CRITICAL: Scrub Authorization from the *options* passed to logRequest
                const loggedOptions = JSON.parse(JSON.stringify(options)); // Deep copy
                if (loggedOptions.headers) {
                     if (loggedOptions.headers['Authorization']) {
                        loggedOptions.headers['Authorization'] = 'Bearer [REDACTED]';
                    }
                    if (loggedOptions.headers['authorization']) {
                         loggedOptions.headers['authorization'] = 'Basic [REDACTED]';
                    }
                }

                if (loggedOptions.body) {
                    logEntry.requestPayload = loggedOptions.body;
                }

                let response;
                let responseData;

                try {
                    response = await fetch(url, options);
                    logEntry.status = response.status;

                    // Try to clone the response to read the body, but fall back if it fails
                    let responseToParse = response;
                    try {
                        responseToParse = response.clone();
                    } catch(e) {
                        console.warn("Could not clone response for logging.");
                    }
                    
                    const contentType = responseToParse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await responseToParse.json();
                    } else {
                        responseData = await responseToParse.text();
                    }
                    logEntry.responsePayload = responseData;

                } catch (error) {
                    console.error("API Fetch Error:", error);
                    logEntry.status = 'FETCH_ERROR';
                    logEntry.responsePayload = error.message;
                    
                    // Log and save, then re-throw
                    XPIApp.devLogs.push(logEntry);
                    saveDevLogs();
                    if (DevTool.isOpen) DevTool.renderLogs();
                    
                    throw error; // Re-throw the network error
                }
                
                // Log and save
                XPIApp.devLogs.push(logEntry);
                saveDevLogs();
                if (DevTool.isOpen) DevTool.renderLogs();

                return response; // Return the original response
            }

            
            // --- Routing Logic ---

            /**
             * Handles page routing based on hash and query parameters.
             */
            function handleRouting() {
                const hash = location.hash.substring(1); // Remove #
                const params = new URLSearchParams(location.search);

                if (hash === 'admin') {
                    showModule('MOD.A');
                } else if (params.has('code')) {
                    showModule('MOD.B');
                    // The Login module init will handle the callback
                } else if (XPIApp.session.token) {
                    // Logged in
                    const targetModule = hash || 'MOD.C'; // Default to Campaign Submission
                    showModule(targetModule);
                } else {
                    // Not logged in
                    showModule('MOD.B');
                }
                
                // Update nav link active state
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.moduleId === hash) {
                        link.classList.add('bg-gray-700', 'text-white');
                    } else {
                        link.classList.remove('bg-gray-700', 'text-white');
                    }
                });
            }

            /**
             * Hides all modules and shows the one specified by ID.
             * Handles lazy-loading of modules.
             * @param {string} moduleId - The module code (e.g., 'MOD.A').
             */
            function showModule(moduleId) {
                // Hide all existing modules
                $ui.moduleContainer.querySelectorAll('[data-module-id]').forEach(m => {
                    m.classList.add('hidden');
                });

                let moduleEl = $ui.moduleContainer.querySelector(`[data-module-id="${moduleId}"]`);

                if (moduleEl) {
                    // Module already exists, just show it
                    moduleEl.classList.remove('hidden');
                } else {
                    // Module needs to be created (and possibly lazy-loaded)
                    if (!XPIApp.initializedModules.has(moduleId)) {
                        lazyLoadModule(moduleId);
                    }
                    // The lazyLoadModule function will create and show the element
                }
            }

            /**
             * Initializes a module for the first time.
             * @param {string} moduleId - The module code.
             */
            function lazyLoadModule(moduleId) {
                const moduleConfig = XPIApp.moduleConfig.find(m => m.code === moduleId);
                if (!moduleConfig) {
                    console.error(`Module config not found for ${moduleId}`);
                    showModule('MOD.B'); // Fallback to login
                    return;
                }

                let moduleEl;
                switch (moduleId) {
                    case 'MOD.A':
                        moduleEl = cloneTemplate('admin-module-template');
                        AdminModule.init(moduleEl);
                        break;
                    case 'MOD.B':
                        moduleEl = cloneTemplate('login-module-template');
                        LoginModule.init(moduleEl);
                        break;
                    case 'MOD.C':
                        moduleEl = cloneTemplate('campaign-submission-module-template');
                        CampaignSubmissionModule.init(moduleEl);
                        break;
                    case 'MAS.DemoCient':
                    case 'MAS.XPICFMapping':
                        moduleEl = cloneTemplate('master-data-module-template');
                        MasterDataModule.initInstance(moduleEl, moduleId, XPIApp.masterDataConfigs[moduleId], moduleConfig.name);
                        break;
                    default:
                        console.error(`No template handler for module ${moduleId}`);
                        return;
                }

                if (moduleEl) {
                    XPIApp.initializedModules.add(moduleId);
                    // showModule(moduleId) will have already hidden others, so just ensure this one is visible
                    moduleEl.classList.remove('hidden');
                }
            }
            
            
            // --- Module: Admin ---
            
            const AdminModule = {
                init(moduleEl) {
                    const form = moduleEl.querySelector('#admin-config-form');
                    const urlInput = moduleEl.querySelector('#config-xpiBaseUrl');
                    
                    // Load current config into form
                    urlInput.value = XPIApp.config.xpiBaseUrl;
                    
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        XPIApp.config.xpiBaseUrl = urlInput.value;
                        saveConfig();
                    });
                }
            };
            

            // --- Module: Login ---
            
            const LoginModule = {
                init(moduleEl) {
                    this.elements = {
                        authMode: moduleEl.querySelector('#login-mode-auth'),
                        callbackMode: moduleEl.querySelector('#login-mode-callback'),
                        authButton: moduleEl.querySelector('#login-auth-button'),
                        resultContainer: moduleEl.querySelector('#login-result-container'),
                        resultMessage: moduleEl.querySelector('#login-result-message'),
                        resultJson: moduleEl.querySelector('#login-result-json'),
                        startOverButton: moduleEl.querySelector('#login-start-over-button'),
                    };

                    this.elements.authButton.addEventListener('click', () => this.handleLoginClick());
                    this.elements.startOverButton.addEventListener('click', () => {
                        history.pushState(null, '', location.pathname); // Clear query params
                        location.hash = '#MOD.B';
                        location.reload(); // Easiest way to reset state
                    });

                    // Check which mode to be in
                    const params = new URLSearchParams(location.search);
                    if (params.has('code')) {
                        this.elements.authMode.classList.add('hidden');
                        this.elements.callbackMode.classList.remove('hidden');
                        this.handleCallback(params.get('code'));
                    } else {
                        this.elements.authMode.classList.remove('hidden');
                        this.elements.callbackMode.classList.add('hidden');
                    }
                },
                
                showResult(message, json, isError = false) {
                    this.elements.resultContainer.classList.remove('hidden');
                    this.elements.resultMessage.textContent = message;
                    this.elements.resultMessage.className = isError ? 'text-center mb-4 text-red-400' : 'text-center mb-4 text-green-400';
                    
                    if(json) {
                        this.elements.resultJson.textContent = formatJsonForDisplay(json);
                        this.elements.resultJson.classList.remove('hidden');
                    } else {
                        this.elements.resultJson.classList.add('hidden');
                    }
                    
                    if(isError) {
                        this.elements.startOverButton.classList.remove('hidden');
                        this.elements.callbackMode.classList.add('hidden');
                    }
                },

                async handleLoginClick() {
                    showLoader(true);
                    try {
                        const timestamp = new Date().toISOString();
                        const random = Math.random().toString();
                        const rawId = `${timestamp}${random}`;
                        const hash = await sha256(rawId);
                        const clientId = hash.slice(-7); // Last 7 chars

                        sessionStorage.setItem('XPIApp_clientId', clientId);
                        XPIApp.session.clientId = clientId;
                        
                        const redirectUri = location.origin + location.pathname;
                        const authUrl = `${XPIApp.config.xpiBaseUrl}?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${clientId}`;
                        
                        // Redirect
                        location.href = authUrl;
                        
                    } catch (e) {
                        console.error("Failed to generate clientId or redirect:", e);
                        this.showResult('Failed to initiate login. Please try again.', e.message, true);
                        showLoader(false);
                    }
                },
                
                async handleCallback(code) {
                    const clientId = sessionStorage.getItem('XPIApp_clientId');
                    
                    if (!clientId || !code) {
                        this.showResult('Login error: Missing authentication code or client ID. Redirecting...', null, true);
                        setTimeout(() => {
                            this.elements.startOverButton.click();
                        }, 10000);
                        return;
                    }

                    try {
                        // 1. Exchange code for token
                        const tokenUrl = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                        const tokenResponse = await apiFetch(tokenUrl, { method: 'GET' });
                        const tokenData = await tokenResponse.json();

                        if (!tokenResponse.ok || !tokenData.success || !tokenData.data) {
                            throw new Error(tokenData.message || 'Failed to exchange token.', { cause: tokenData });
                        }
                        
                        const { token, credentials } = tokenData.data;
                        if (!token || !credentials || !credentials.username || !credentials.password) {
                             throw new Error('Incomplete token data received.', { cause: tokenData });
                        }

                        // Store token immediately
                        sessionStorage.setItem('XPIApp_token', token);
                        XPIApp.session.token = token;

                        // 2. Verify with profile check (Basic Auth)
                        const profileUrl = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`;
                        const basicAuth = btoa(`${credentials.username}:${credentials.password}`);
                        
                        const profileResponse = await apiFetch(profileUrl, {
                            method: 'GET',
                            headers: {
                                'authorization': `Basic ${basicAuth}`
                            }
                        });
                        const profileData = await profileResponse.json();

                        if (!profileResponse.ok || !profileData.success || !profileData.data || profileData.data.length === 0) {
                            throw new Error(profileData.message || 'Failed to verify user profile.', { cause: profileData });
                        }
                        
                        const profile = profileData.data[0];
                        XPIApp.session.userProfile = {
                            firstName: profile.firstName,
                            lastName: profile.lastName,
                            avatarUrl: profile.avatarUrl
                        };
                        sessionStorage.setItem('XPIApp_userProfile', JSON.stringify(XPIApp.session.userProfile));

                        // 3. Success!
                        this.showResult(`${profile.firstName} ${profile.lastName} login successfully. Redirecting...`, null, false);
                        updateUserProfileUI();
                        
                        // Clear query params and redirect
                        setTimeout(() => {
                            history.pushState(null, '', location.pathname);
                            location.hash = '#MOD.C'; // Go to default logged-in module
                        }, 2000);
                        
                    } catch (error) {
                        console.error("Callback Error:", error);
                        const errorJson = error.cause || error.message;
                        this.showResult(`Login failed: ${error.message}. Please try again.`, errorJson, true);
                    }
                }
            };
            
            
            // --- Module: Campaign Submission ---
            
            const CampaignSubmissionModule = {
                init(moduleEl) {
                    this.elements = {
                        loader: moduleEl.querySelector('#campaign-loader'),
                        loaderError: moduleEl.querySelector('#campaign-loader-error'),
                        form: moduleEl.querySelector('#campaign-form'),
                        clientSelect: moduleEl.querySelector('#campaign-client'),
                        debtorSelect: moduleEl.querySelector('#campaign-debtor'),
                        agencySelect: moduleEl.querySelector('#campaign-agency'),
                        channelsInput: moduleEl.querySelector('#campaign-channels-input'),
                        channelsContainer: moduleEl.querySelector('#campaign-channels-container'),
                        submitBtn: moduleEl.querySelector('#campaign-submit-btn'),
                        resultContainer: moduleEl.querySelector('#campaign-result-container'),
                        resultJson: moduleEl.querySelector('#campaign-result-json'),
                    };
                    
                    this.loadDropdowns();
                    this.attachFormListeners();
                },
                
                async loadDropdowns() {
                    const token = XPIApp.session.token;
                    if (!token) {
                        this.elements.loaderError.textContent = 'Authentication token not found. Please log in again.';
                        this.elements.loaderError.classList.remove('hidden');
                        return;
                    }
                    
                    const headers = { 'Authorization': `Bearer ${token}` };
                    
                    const loadSelect = async (url, selectEl, defaultValue) => {
                        const response = await apiFetch(url, { headers });
                        if (!response.ok) {
                            throw new Error(`Failed to load data for ${selectEl.name}`);
                        }
                        const data = await response.json();
                        // Clear all but default
                        selectEl.innerHTML = '';
                        if(defaultValue) {
                            const defaultOpt = document.createElement('option');
                            defaultOpt.value = defaultValue;
                            defaultOpt.textContent = defaultValue;
                            selectEl.appendChild(defaultOpt);
                        }
                        data.value.forEach(item => {
                            if (item.value !== defaultValue) {
                                const option = document.createElement('option');
                                option.value = item.value;
                                option.textContent = item.value;
                                selectEl.appendChild(option);
                            }
                        });
                    };

                    try {
                        const baseUrl = XPIApp.config.xpiBaseUrl;
                        await Promise.all([
                            loadSelect(`${baseUrl}/api/v1/wrikexpi/v1.0/value/clients-grm-mys`, this.elements.clientSelect, "Adidas Group"),
                            loadSelect(`${baseUrl}/api/v1/wrikexpi/v1.0/value/debtors-grm-mys`, this.elements.debtorSelect, "Adidas Malaysia Sdn Bhd"),
                            loadSelect(`${baseUrl}/api/v1/wrikexpi/v1.0/value/agencies`, this.elements.agencySelect, "Eightbar")
                        ]);
                        
                        this.elements.loader.classList.add('hidden');
                        this.elements.form.classList.remove('hidden');
                        
                    } catch (e) {
                        console.error("Failed to load campaign dropdowns:", e);
                        this.elements.loaderError.textContent = `Error loading dropdowns: ${e.message}. You may be logged out.`;
                        this.elements.loaderError.classList.remove('hidden');
                    }
                },
                
                attachFormListeners() {
                    // Form Submission
                    this.elements.form.addEventListener('submit', (e) => this.handleSubmit(e));
                    
                    // Tagging Interface
                    this.elements.channelsInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            this.addTag(this.elements.channelsInput.value);
                            this.elements.channelsInput.value = '';
                        }
                    });
                    
                    this.elements.channelsContainer.addEventListener('click', (e) => {
                        if (e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') {
                            const tagEl = (e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement).closest('.channel-tag');
                            if (tagEl) {
                                tagEl.remove();
                            }
                        }
                    });
                },
                
                addTag(value) {
                    const tagValue = value.trim();
                    if (tagValue) {
                        const tag = document.createElement('span');
                        tag.className = 'channel-tag flex items-center bg-blue-600 text-white text-sm font-medium px-3 py-1 rounded-full';
                        tag.innerHTML = `
                            ${tagValue}
                            <button type="button" class="ml-2 text-blue-200 hover:text-white">&times;</button>
                        `;
                        this.elements.channelsContainer.appendChild(tag);
                    }
                },
                
                getTags() {
                    const tags = [];
                    this.elements.channelsContainer.querySelectorAll('.channel-tag').forEach(tagEl => {
                        tags.push(tagEl.firstChild.textContent.trim());
                    });
                    return tags;
                },
                
                async handleSubmit(e) {
                    e.preventDefault();
                    
                    const btn = this.elements.submitBtn;
                    btn.disabled = true;
                    btn.textContent = 'Submitting...';
                    
                    this.elements.resultContainer.classList.add('hidden');
                    
                    const token = XPIApp.session.token;
                    if (!token) {
                        this.showResult('Error: Not authenticated. Please log in.', true);
                        btn.disabled = false;
                        btn.textContent = 'Submit Campaign';
                        return;
                    }
                    
                    try {
                        const formData = new FormData(this.elements.form);
                        const payload = {
                            fields: {}
                        };
                        
                        // Get all form data
                        formData.forEach((value, key) => {
                             // Top-level fields
                            if (['type', 'space', 'entity', 'varientId'].includes(key)) {
                                payload[key] = isNaN(value) ? value : Number(value);
                            } else {
                                // `fields` object
                                payload.fields[key] = isNaN(value) ? value : Number(value);
                            }
                        });
                        
                        // Handle `selectedchannels` array
                        payload.fields.selectedchannels = this.getTags();

                        const url = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/campaign`;
                        const response = await apiFetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        const responseData = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(responseData.message || `HTTP ${response.status} ${response.statusText}`, { cause: responseData });
                        }
                        
                        this.showResult(responseData, false);
                        showToast('Campaign submitted successfully!', 'success');
                        
                    } catch (error) {
                        console.error('Campaign submission failed:', error);
                        this.showResult(error.cause || error.message, true);
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'Submit Campaign';
                    }
                },
                
                showResult(data, isError) {
                    this.elements.resultContainer.classList.remove('hidden');
                    const pre = this.elements.resultJson;
                    pre.textContent = formatJsonForDisplay(data);
                    
                    if (isError) {
                        pre.className = 'bg-gray-900 text-sm p-4 rounded-md overflow-auto max-h-80 text-red-400';
                    } else {
                        pre.className = 'bg-gray-900 text-sm p-4 rounded-md overflow-auto max-h-80 text-green-400';
                    }
                }
            };


            // --- Module: Master Data ---
            
            const MasterDataModule = {
                /**
                 * Initializes a new instance of the Master Data module.
                 * @param {HTMLElement} moduleEl - The cloned template element.
                 * @param {string} moduleId - The module code (e.g., 'MAS.DemoCient').
                 * @param {object} config - The specific config from `masterDataConfigs`.
                 * @param {string} title - The display name of the module.
                 */
                initInstance(moduleEl, moduleId, config, title) {
                    moduleEl.dataset.moduleId = moduleId;
                    moduleEl.querySelector('.module-title').textContent = `${title} Management`;
                    
                    const ui = {
                        loader: moduleEl.querySelector('.md-loader-container'),
                        error: moduleEl.querySelector('.md-error-container'),
                        tableContainer: moduleEl.querySelector('.md-table-container'),
                        table: moduleEl.querySelector('table'),
                        tableHead: moduleEl.querySelector('thead'),
                        tableBody: moduleEl.querySelector('tbody'),
                        loadBtn: moduleEl.querySelector('.md-load-btn'),
                        createBtn: moduleEl.querySelector('.md-create-btn'),
                    };
                    
                    // Attach event listeners
                    ui.loadBtn.addEventListener('click', () => this.loadData(ui, config));
                    ui.createBtn.addEventListener('click', () => this.openCreateModal(ui, config));
                    
                    // Initial load
                    this.loadData(ui, config);
                },
                
                async loadData(ui, config) {
                    const { slug } = config;
                    const token = XPIApp.session.token;

                    // Prevent concurrent loads
                    if (XPIApp.activeMasterDataFetches[slug]) return;
                    XPIApp.activeMasterDataFetches[slug] = true;

                    ui.loader.classList.remove('hidden');
                    ui.error.classList.add('hidden');
                    ui.tableContainer.classList.add('hidden');
                    ui.loadBtn.disabled = true;

                    try {
                        if (!token) throw new Error("Not authenticated. Please log in.");
                        
                        const url = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/record/${slug}`;
                        const response = await apiFetch(url, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.message || `HTTP ${response.status}`, { cause: data });
                        }
                        
                        this.renderTable(ui, config, data.value);
                        
                    } catch (e) {
                        console.error(`Failed to load master data ${slug}:`, e);
                        ui.error.textContent = `Error: ${e.message}. ${e.cause ? formatJsonForDisplay(e.cause) : ''}`;
                        ui.error.classList.remove('hidden');
                    } finally {
                        ui.loader.classList.add('hidden');
                        ui.loadBtn.disabled = false;
                        delete XPIApp.activeMasterDataFetches[slug];
                    }
                },
                
                renderTable(ui, config, data) {
                    const { fields } = config;
                    
                    // Render headers
                    ui.tableHead.innerHTML = `
                        <tr>
                            ${fields.map(f => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">${f}</th>`).join('')}
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    `;
                    
                    // Render body
                    ui.tableBody.innerHTML = ''; // Clear
                    if (data.length === 0) {
                        ui.tableBody.innerHTML = `<tr><td colspan="${fields.length + 1}" class="px-6 py-4 text-center text-gray-500">No records found.</td></tr>`;
                    } else {
                        data.forEach(record => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-700';
                            
                            let rowHtml = '';
                            fields.forEach(field => {
                                const value = record[field] || 'N/A';
                                rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${value}</td>`;
                            });
                            
                            // Actions
                            rowHtml += `
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    <button class="styled-btn-link edit-btn" data-id="${record.id}">Edit</button>
                                    <button class="styled-btn-link text-red-400 hover:text-red-300 delete-btn" data-id="${record.id}">Delete</button>
                                </td>
                            `;
                            row.innerHTML = rowHtml;
                            
                            // Attach event listeners for this row
                            row.querySelector('.edit-btn').addEventListener('click', () => this.openEditModal(ui, config, record));
                            row.querySelector('.delete-btn').addEventListener('click', () => this.openDeleteModal(ui, config, record));
                            
                            ui.tableBody.appendChild(row);
                        });
                    }
                    
                    ui.tableContainer.classList.remove('hidden');
                },

                buildModalForm(fields, record = null) {
                    let formHtml = '';
                    fields.forEach(field => {
                        const isReadOnly = (field === 'id');
                        const isRequired = (field === 'value');
                        const value = record ? (record[field] || '') : '';

                        formHtml += `
                            <div class="mb-4">
                                <label for="modal-field-${field}" class="styled-label">${field} ${isRequired ? '<span class="text-red-400">*</span>' : ''}</label>
                                <input type="text" id="modal-field-${field}" name="${field}"
                                       class="styled-input" 
                                       value="${value}" 
                                       ${isReadOnly ? 'readonly' : ''}
                                       ${isRequired ? 'required' : ''}
                                >
                            </div>
                        `;
                    });
                    return formHtml;
                },
                
                openCreateModal(ui, config) {
                    const formHtml = this.buildModalForm(config.fields);
                    
                    Modal.show({
                        title: 'Create New Record',
                        content: formHtml,
                        saveText: 'Create',
                        onSave: (form) => this.handleSave(ui, config, form, null), // null id for create
                    });
                },
                
                openEditModal(ui, config, record) {
                    const formHtml = this.buildModalForm(config.fields, record);
                    
                    Modal.show({
                        title: `Edit Record: ${record.id}`,
                        content: formHtml,
                        saveText: 'Save Changes',
                        onSave: (form) => this.handleSave(ui, config, form, record.id),
                    });
                },

                openDeleteModal(ui, config, record) {
                    Modal.show({
                        title: 'Delete Record',
                        mode: 'delete',
                        deleteItem: `${record.value || record.id}`,
                        deleteText: 'Delete Record',
                        onDelete: () => this.handleDelete(ui, config, record.id),
                    });
                },

                async handleSave(ui, config, form, recordId) {
                    const { slug, fields, odataContext } = config;
                    const token = XPIApp.session.token;
                    
                    const payload = {
                        "@odata.context": odataContext,
                    };
                    
                    let formIsValid = true;
                    fields.forEach(field => {
                        const input = form.querySelector(`[name="${field}"]`);
                        if(input) {
                            if(field !== 'id' || recordId) { // only include id on update
                                payload[field] = input.value;
                            }
                            if(input.required && !input.value) {
                                formIsValid = false;
                            }
                        }
                    });

                    if (!formIsValid) {
                        showToast('Please fill in all required fields.', 'error');
                        return false; // Prevent modal from closing
                    }

                    const isCreate = !recordId;
                    const url = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/record/${slug}`;
                    const method = isCreate ? 'POST' : 'PATCH';
                    
                    try {
                        const response = await apiFetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        const responseData = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(responseData.message || `HTTP ${response.status}`, { cause: responseData });
                        }
                        
                        showToast(`Record ${isCreate ? 'created' : 'updated'} successfully!`, 'success');
                        this.loadData(ui, config); // Refresh data
                        return true; // Close modal
                        
                    } catch (e) {
                        console.error('Failed to save record:', e);
                        showToast(`Error: ${e.message}`, 'error');
                        return false; // Keep modal open
                    }
                },
                
                async handleDelete(ui, config, recordId) {
                    const { slug } = config;
                    const token = XPIApp.session.token;
                    const url = `${XPIApp.config.xpiBaseUrl}/api/v1/wrikexpi/v1.0/record/${slug}/${recordId}`;

                    try {
                        const response = await apiFetch(url, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        // Delete doesn't always return JSON, check status
                        if (!response.ok) {
                            let errorData;
                            try { errorData = await response.json(); } catch(e) { /* no json */ }
                            throw new Error(errorData?.message || `HTTP ${response.status}`, { cause: errorData });
                        }
                        
                        showToast('Record deleted successfully!', 'success');
                        this.loadData(ui, config); // Refresh data
                        return true; // Close modal
                        
                    } catch (e) {
                        console.error('Failed to delete record:', e);
                        showToast(`Error: ${e.message}`, 'error');
                        return false; // Keep modal open
                    }
                }
            };
            

            // --- Generic Modal Controller ---
            
            const Modal = {
                onSaveCallback: null,
                onDeleteCallback: null,

                show({ title, content, mode = 'form', deleteItem = '', saveText = 'Save', deleteText = 'Delete', onSave, onDelete }) {
                    this.onSaveCallback = onSave || null;
                    this.onDeleteCallback = onDelete || null;
                    
                    $ui.genericModal.title.textContent = title;
                    
                    if (mode === 'form') {
                        $ui.genericModal.form.innerHTML = content;
                        $ui.genericModal.form.classList.remove('hidden');
                        $ui.genericModal.deleteConfirm.classList.add('hidden');
                        
                        $ui.genericModal.saveBtn.textContent = saveText;
                        $ui.genericModal.saveBtn.classList.remove('hidden');
                        $ui.genericModal.deleteBtn.classList.add('hidden');
                        
                        // Detach old listeners, attach new one
                        $ui.genericModal.saveBtn.replaceWith($ui.genericModal.saveBtn.cloneNode(true));
                        $ui.genericModal.saveBtn = document.getElementById('generic-modal-btn-save'); // Re-select
                        $ui.genericModal.saveBtn.addEventListener('click', this.handleSave.bind(this));

                    } else if (mode === 'delete') {
                        $ui.genericModal.form.classList.add('hidden');
                        $ui.genericModal.deleteConfirm.classList.remove('hidden');
                        $ui.genericModal.deleteItem.textContent = deleteItem;
                        
                        $ui.genericModal.saveBtn.classList.add('hidden');
                        $ui.genericModal.deleteBtn.textContent = deleteText;
                        $ui.genericModal.deleteBtn.classList.remove('hidden');
                        
                        // Detach old listeners, attach new one
                        $ui.genericModal.deleteBtn.replaceWith($ui.genericModal.deleteBtn.cloneNode(true));
                        $ui.genericModal.deleteBtn = document.getElementById('generic-modal-btn-delete'); // Re-select
                        $ui.genericModal.deleteBtn.addEventListener('click', this.handleDelete.bind(this));
                    }
                    
                    $ui.genericModal.el.classList.remove('hidden');
                },
                
                hide() {
                    $ui.genericModal.el.classList.add('hidden');
                    $ui.genericModal.form.innerHTML = '';
                    this.onSaveCallback = null;
                    this.onDeleteCallback = null;
                },
                
                async handleSave() {
                    if (typeof this.onSaveCallback === 'function') {
                        $ui.genericModal.saveBtn.disabled = true;
                        const success = await this.onSaveCallback($ui.genericModal.form);
                        $ui.genericModal.saveBtn.disabled = false;
                        if (success) {
                            this.hide();
                        }
                    }
                },
                
                async handleDelete() {
                    if (typeof this.onDeleteCallback === 'function') {
                        $ui.genericModal.deleteBtn.disabled = true;
                        const success = await this.onDeleteCallback();
                        $ui.genericModal.deleteBtn.disabled = false;
                        if (success) {
                            this.hide();
                        }
                    }
                }
            };
            

            // --- Start the App ---
            init();

        });
    </script>
</body>
</html>
