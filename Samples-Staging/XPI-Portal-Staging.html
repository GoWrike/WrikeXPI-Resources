<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* bg-gray-300 */
        }
        
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }

        /* Form elements dark theme */
        .form-input {
            @apply w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-200 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500;
        }
        .form-select {
            @apply w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-gray-200 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500;
        }
        .form-label {
            @apply block mb-2 text-sm font-medium text-gray-300;
        }
        .btn {
            @apply px-4 py-2 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition duration-150 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-600 text-gray-100 hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .btn-icon {
            @apply p-2 rounded-full text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500;
        }
        
        /* Page transition spinner */
        #page-loader {
            @apply fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75;
        }
        .spinner {
            @apply w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin;
        }

        /* Toast notifications */
        #toast-container {
            @apply fixed top-5 right-5 z-50 w-full max-w-sm;
        }
        .toast {
            @apply w-full p-4 mb-4 rounded-lg shadow-lg text-white flex items-center;
        }
        .toast-success { @apply bg-green-600; }
        .toast-error { @apply bg-red-600; }
        .toast-info { @apply bg-blue-600; }

        /* Modal styles */
        .modal {
            @apply fixed inset-0 z-40 bg-gray-900 bg-opacity-75 flex items-center justify-center;
        }
        .modal-content {
            @apply bg-gray-800 rounded-lg shadow-xl max-h-[90vh] flex flex-col;
        }
        .modal-header {
            @apply p-5 border-b border-gray-700 flex justify-between items-center;
        }
        .modal-title {
            @apply text-xl font-semibold text-white;
        }
        .modal-body {
            @apply p-6 overflow-y-auto;
        }
        .modal-footer {
            @apply p-5 border-t border-gray-700 bg-gray-800 rounded-b-lg flex justify-end space-x-3;
        }
    </style>
</head>
<body class="h-full bg-gray-900 overflow-hidden">

    <!-- Global Page Loader -->
    <div id="page-loader" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Main App Layout -->
    <div class="flex h-full">
        
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="hidden md:flex md:flex-col md:w-64 bg-gray-800 shadow-lg transition-all duration-300 ease-in-out">
            <div class="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
                <!-- Sidebar Header -->
                <div class="flex items-center justify-between px-4">
                    <span class="text-2xl font-bold text-white">XPI Portal</span>
                    <button id="sidebar-toggle-btn" class="btn-icon md:hidden">
                        <!-- Close icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- Navigation Links -->
                <div class="mt-5 flex-1 px-2 space-y-1" id="nav-links">
                    <!-- User-defined modules will be injected here -->
                </div>
            </div>
            
            <!-- User Profile Section -->
            <div id="user-profile" class="flex-shrink-0 p-4 border-t border-gray-700">
                <div class="flex items-center">
                    <img id="user-avatar" class="h-10 w-10 rounded-full" src="https://placehold.co/40x40/555/FFF?text=X" alt="User Avatar">
                    <div class="ml-3">
                        <p id="user-name" class="text-sm font-medium text-white">Guest User</p>
                        <a href="#" id="logout-link" class="text-xs font-medium text-blue-400 hover:text-blue-300">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto relative">
            <!-- Mobile Header -->
            <div class="md:hidden sticky top-0 bg-gray-800 z-10 shadow-md">
                <div class="flex items-center justify-between px-4 py-3">
                     <span class="text-2xl font-bold text-white">XPI Portal</span>
                    <button id="mobile-menu-btn" class="btn-icon">
                        <!-- Menu icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Module Container -->
            <div class="p-4 md:p-8" id="module-container">

                <!-- ===== MODULE: Login (MOD.B) ===== -->
                <div id="module-login" class="module hidden max-w-lg mx-auto">
                    <!-- Mode 1: Authentication -->
                    <div id="login-auth-mode">
                        <div class="bg-gray-800 shadow-xl rounded-lg p-8 text-center">
                            <h2 class="text-2xl font-bold text-white mb-6">Welcome to XPI Portal</h2>
                            <p class="text-gray-400 mb-8">Please login to continue.</p>
                            <button id="login-auth-btn" class="btn btn-primary w-full text-lg">
                                Login & Authenticate
                            </button>
                        </div>
                    </div>
                    <!-- Mode 2: OAuth Callback -->
                    <div id="login-callback-mode">
                        <div class="bg-gray-800 shadow-xl rounded-lg p-8">
                            <div id="login-callback-loading" class="text-center">
                                <div class="spinner mx-auto mb-4"></div>
                                <h3 class="text-xl font-semibold text-white">Authenticating...</h3>
                                <p class="text-gray-400">Please wait while we verify your credentials.</p>
                            </div>
                            <div id="login-callback-error" class="hidden">
                                <h3 class="text-xl font-semibold text-red-500 mb-4">Authentication Failed</h3>
                                <p id="login-error-message" class="text-gray-300 mb-4"></p>
                                <pre id="login-error-details" class="bg-gray-900 text-red-400 rounded-md p-4 max-h-60 overflow-auto text-sm"></pre>
                                <button id="login-start-over-btn" class="btn btn-secondary w-full mt-6">Start Over</button>
                            </div>
                            <div id="login-callback-success" class="hidden text-center">
                                <h3 class="text-xl font-semibold text-green-500 mb-4">Login Successful!</h3>
                                <p id="login-success-message" class="text-gray-300 mb-4"></p>
                                <p class="text-gray-400">Redirecting you to the portal...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== MODULE: Admin (MOD.A) ===== -->
                <div id="module-admin" class="module hidden max-w-2xl mx-auto">
                    <div class="bg-gray-800 shadow-xl rounded-lg">
                        <div class="p-6 border-b border-gray-700">
                            <h2 class="text-2xl font-bold text-white">Admin Configuration</h2>
                        </div>
                        <div class="p-6">
                            <form id="admin-form">
                                <div>
                                    <label for="admin-xpiBaseUrl" class="form-label">XPI Base URL</label>
                                    <input type="url" id="admin-xpiBaseUrl" class="form-input" required>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ===== MODULE: Campaign Submission (MOD.C) ===== -->
                <div id="module-campaign-submission" class="module hidden max-w-4xl mx-auto">
                    <div class="bg-gray-800 shadow-xl rounded-lg">
                        <div class="p-6 border-b border-gray-700">
                            <h2 class="text-2xl font-bold text-white">Campaign Submission</h2>
                        </div>
                        <form id="campaign-form" class_="p-6">
                            <!-- Hidden Fields -->
                            <input type="hidden" id="campaign-type" value="Campaign Request">
                            <input type="hidden" id="campaign-space" value="GRM-MYS-GMN">
                            <input type="hidden" id="campaign-entity" value="Campaign">
                            <input type="hidden" id="campaign-varientId" value="1">
                            
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Editable Fields -->
                                <div>
                                    <label for="campaign-campaignname" class="form-label">Campaign Name</label>
                                    <input type="text" id="campaign-campaignname" class="form-input" value="World Pinball Day 7000">
                                </div>
                                <div>
                                    <label for="campaign-requestedstartdate" class="form-label">Requested Start Date</label>
                                    <input type="date" id="campaign-requestedstartdate" class="form-input" value="2026-07-01">
                                </div>
                                <div>
                                    <label for="campaign-campaignstartdate" class="form-label">Campaign Start Date</label>
                                    <input type="date" id="campaign-campaignstartdate" class="form-input" value="2026-08-29">
                                </div>
                                <div>
                                    <label for="campaign-campaignenddate" class="form-label">Campaign End Date</label>
                                    <input type="date" id="campaign-campaignenddate" class="form-input" value="2026-10-29">
                                </div>
                                
                                <div>
                                    <label for="campaign-client" class="form-label">Client</label>
                                    <select id="campaign-client" class="form-select">
                                        <option value="">Loading clients...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="campaign-debtor" class="form-label">Debtor</label>
                                    <select id="campaign-debtor" class="form-select">
                                        <option value="">Loading debtors...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="campaign-agency" class="form-label">Agency</label>
                                    <select id="campaign-agency" class="form-select">
                                        <option value="">Loading agencies...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="campaign-brand" class="form-label">Brand</label>
                                    <input type="text" id="campaign-brand" class="form-input" value="World Pinball">
                                </div>
                                <div>
                                    <label for="campaign-currency" class="form-label">Currency</label>
                                    <input type="text" id="campaign-currency" class="form-input" value="SGD">
                                </div>
                                <div>
                                    <label for="campaign-pod" class="form-label">Pod</label>
                                    <input type="text" id="campaign-pod" class="form-input" value="Pod 1A">
                                </div>
                                <div>
                                    <label for="campaign-campaignobjective" class="form-label">Campaign Objective</label>
                                    <input type="text" id="campaign-campaignobjective" class="form-input" value="Upper Funnel / Awareness">
                                </div>
                                <div>
                                    <label for="campaign-requestormarket" class="form-label">Requestor Market</label>
                                    <input type="text" id="campaign-requestormarket" class="form-input" value="Singapore">
                                </div>
                                <div>
                                    <label for="campaign-optin" class="form-label">Opt-in</label>
                                    <select id="campaign-optin" class="form-select">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="campaign-porequired" class="form-label">PO Required</label>
                                    <select id="campaign-porequired" class="form-select">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="campaign-overallbudget" class="form-label">Overall Budget</label>
                                    <input type="number" id="campaign-overallbudget" class="form-input" value="100">
                                </div>
                                <div>
                                    <label for="campaign-selectedchannels" class="form-label">Selected Channels (comma-separated)</label>
                                    <input type="text" id="campaign-selectedchannels" class="form-input" value="Twitter">
                                </div>
                            </div>
                            
                            <div class="p-6 border-t border-gray-700">
                                <button type="submit" id="campaign-submit-btn" class="btn btn-primary">
                                    Submit Campaign
                                </button>
                            </div>
                        </form>
                        
                        <!-- Result Section -->
                        <div id="campaign-result" class="hidden p-6">
                            <h3 class="text-lg font-medium text-white mb-2">Submission Result</h3>
                            <pre id="campaign-result-pre" class="bg-gray-900 rounded-md p-4 max-h-96 overflow-auto text-sm"></pre>
                        </div>
                    </div>
                </div>

                <!-- ===== MODULE: Master Data (Template) ===== -->
                <!-- This will be used for Demo Client and XPI Field Mapping -->
                <div id="module-master-data" class="module hidden">
                    <div class="bg-gray-800 shadow-xl rounded-lg">
                        <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                            <h2 id="master-data-title" class="text-2xl font-bold text-white">Master Data</h2>
                            <div class="space-x-2">
                                <button id="master-data-load-btn" class="btn btn-secondary">
                                    <span class="flex items-center">
                                        <!-- Refresh Icon -->
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15"></path></svg>
                                        Load Data
                                    </span>
                                </button>
                                <button id="master-data-create-btn" class="btn btn-primary">
                                    Create New
                                </button>
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="p-6">
                            <div id="master-data-loader" class="text-center py-10 hidden">
                                <div class="spinner mx-auto"></div>
                                <p class="mt-2 text-gray-400">Loading records...</p>
                            </div>
                            <div id="master-data-table-container" class="overflow-x-auto rounded-lg border border-gray-700">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700">
                                        <tr id="master-data-table-head">
                                            <!-- Headers generated by JS -->
                                        </tr>
                                    </thead>
                                    <tbody id="master-data-table-body" class="divide-y divide-gray-700">
                                        <!-- Rows generated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- /#module-container -->

            <!-- Developer Tool Toggle Button -->
            <button id="dev-tool-toggle" class="fixed bottom-5 right-5 btn-icon bg-gray-700 text-blue-300 hover:bg-gray-600 focus:ring-blue-500 z-30 shadow-lg">
                <!-- Hat Icon -->
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm6.34 15.29c-.74-1.88-2.3-3.39-4.29-4.04 1.35-.78 2.29-2.2 2.29-3.88 0-2.38-1.92-4.3-4.3-4.3S7.7 7.99 7.7 10.37c0 1.68.94 3.1 2.29 3.88-1.99.65-3.55 2.16-4.29 4.04A7.96 7.96 0 0 1 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8c0 2.05-.78 3.9-2.05 5.29H18.34zM12 11.37c-1.8 0-3.3-1.4-3.3-3s1.5-3 3.3-3 3.3 1.4 3.3 3-1.5 3-3.3 3z"/></svg>
            </button>

        </main> <!-- /#main-content -->
    </div> <!-- /#app-layout -->


    <!-- ===== MODALS ===== -->

    <!-- Master Data Create/Edit Modal -->
    <div id="master-data-modal" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <form id="master-data-form">
                <input type="hidden" id="master-data-id">
                <input type="hidden" id="master-data-slug">
                
                <div class="modal-header">
                    <h3 id="master-data-modal-title" class="modal-title">Record</h3>
                    <button type="button" class="btn-icon modal-close-btn">
                        <!-- Close icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="modal-body">
                    <!-- Generic form fields based on API spec -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="master-data-value" class="form-label">Value <span class="text-red-500">*</span></label>
                            <input type="text" id="master-data-value" class="form-input" required>
                        </div>
                         <div>
                            <label for="master-data-code" class="form-label">Code</label>
                            <input type="text" id="master-data-code" class="form-input">
                        </div>
                        <div>
                            <label for="master-data-fincode" class="form-label">FinCode</label>
                            <input type="text" id="master-data-fincode" class="form-input">
                        </div>
                        <div>
                            <label for="master-data-guid" class="form-label">GUID</label>
                            <input type="text" id="master-data-guid" class="form-input">
                        </div>
                        <div class="md:col-span-2">
                            <label for="master-data-note" class="form-label">Note</label>
                            <textarea id="master-data-note" class="form-input" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" id="master-data-save-btn" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Master Data Delete Confirm Modal -->
    <div id="delete-confirm-modal" class="modal hidden">
        <div class="modal-content w-full max-w-md">
            <input type="hidden" id="delete-confirm-id">
            <input type="hidden" id="delete-confirm-slug">
            
            <div class="modal-header">
                <h3 class="modal-title">Confirm Deletion</h3>
            </div>
            
            <div class="modal-body">
                <p class="text-gray-300">Are you sure you want to delete this record? This action cannot be undone.</p>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                <button type="button" id="delete-confirm-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Developer Tool Modal -->
    <div id="dev-tool-modal" class="modal hidden">
        <div class="modal-content w-[80vw] h-[80vh]">
            <div class="modal-header">
                <h3 class="modal-title">Developer Tool: API Logs</h3>
                <div>
                    <button id="dev-tool-purge-btn" class="btn-icon" title="Purge Logs">
                        <!-- Rubbish Bin Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                    <button type="button" class="btn-icon modal-close-btn ml-2" title="Close">
                        <!-- Close icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="overflow-auto h-full">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Timestamp</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Method</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">URL</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Request</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Response</th>
                            </tr>
                        </thead>
                        <tbody id="dev-tool-log-body" class="divide-y divide-gray-700">
                            <!-- Logs will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payload Viewer Modal -->
    <div id="payload-viewer-modal" class="modal hidden" style="z-index: 50;"> <!-- Higher z-index -->
        <div class="modal-content w-full max-w-3xl">
            <div class="modal-header">
                <h3 id="payload-viewer-title" class="modal-title">Payload</h3>
                <button type="button" class="btn-icon modal-close-btn">
                    <!-- Close icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="modal-body">
                <pre id="payload-viewer-pre" class="bg-gray-900 text-gray-200 rounded-md p-4 max-h-[60vh] overflow-auto text-sm"></pre>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script type="module">
        // --- CONSTANTS & CONFIG ---
        
        const MODULE_CONFIG = [
            { code: "MOD.A", name: "Admin", type: "Built-in", hash: "#admin" },
            { code: "MOD.B", name: "Login", type: "Built-in", hash: "#login" },
            { code: "MOD.C", name: "Campaign Submission", type: "User-defined", hash: "#campaign-submission" },
            { code: "MAS.DemoCient", name: "Demo Client", type: "User-defined", hash: "#demo-client", slug: "demoxpiclients" },
            { code: "MAS.XPICFMapping", name: "XPI Field Mapping", type: "User-defined", hash: "#xpi-field-mapping", slug: "xpicfmapping" },
        ];
        
        const DEFAULT_CONFIG = {
            xpiBaseUrl: "https://api.wrikexpi.groupm.com"
        };
        
        // --- DOM ELEMENT REFERENCES ---
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const dom = {
            pageLoader: $("#page-loader"),
            sidebar: $("#sidebar"),
            mobileMenuBtn: $("#mobile-menu-btn"),
            sidebarToggleBtn: $("#sidebar-toggle-btn"),
            navLinks: $("#nav-links"),
            userProfile: $("#user-profile"),
            userAvatar: $("#user-avatar"),
            userName: $("#user-name"),
            logoutLink: $("#logout-link"),
            moduleContainer: $("#module-container"),
            toastContainer: $("#toast-container"),
            devToolToggle: $("#dev-tool-toggle"),
            // Modals
            devToolModal: {
                modal: $("#dev-tool-modal"),
                logBody: $("#dev-tool-log-body"),
                purgeBtn: $("#dev-tool-purge-btn"),
            },
            payloadViewerModal: {
                modal: $("#payload-viewer-modal"),
                title: $("#payload-viewer-title"),
                pre: $("#payload-viewer-pre"),
            },
            masterDataModal: {
                modal: $("#master-data-modal"),
                form: $("#master-data-form"),
                title: $("#master-data-modal-title"),
                id: $("#master-data-id"),
                slug: $("#master-data-slug"),
                value: $("#master-data-value"),
                code: $("#master-data-code"),
                fincode: $("#master-data-fincode"),
                guid: $("#master-data-guid"),
                note: $("#master-data-note"),
                saveBtn: $("#master-data-save-btn"),
            },
            deleteConfirmModal: {
                modal: $("#delete-confirm-modal"),
                id: $("#delete-confirm-id"),
                slug: $("#delete-confirm-slug"),
                confirmBtn: $("#delete-confirm-btn"),
            },
            // Modules
            modules: {
                login: {
                    el: $("#module-login"),
                    authMode: $("#login-auth-mode"),
                    callbackMode: $("#login-callback-mode"),
                    authBtn: $("#login-auth-btn"),
                    loading: $("#login-callback-loading"),
                    error: $("#login-callback-error"),
                    errorMessage: $("#login-error-message"),
                    errorDetails: $("#login-error-details"),
                    startOverBtn: $("#login-start-over-btn"),
                    success: $("#login-callback-success"),
                    successMessage: $("#login-success-message"),
                },
                admin: {
                    el: $("#module-admin"),
                    form: $("#admin-form"),
                    xpiBaseUrl: $("#admin-xpiBaseUrl"),
                },
                campaign: {
                    el: $("#module-campaign-submission"),
                    form: $("#campaign-form"),
                    submitBtn: $("#campaign-submit-btn"),
                    result: $("#campaign-result"),
                    resultPre: $("#campaign-result-pre"),
                    // Dropdowns
                    client: $("#campaign-client"),
                    debtor: $("#campaign-debtor"),
                    agency: $("#campaign-agency"),
                },
                masterData: {
                    el: $("#module-master-data"),
                    title: $("#master-data-title"),
                    loadBtn: $("#master-data-load-btn"),
                    createBtn: $("#master-data-create-btn"),
                    loader: $("#master-data-loader"),
                    tableContainer: $("#master-data-table-container"),
                    tableHead: $("#master-data-table-head"),
                    tableBody: $("#master-data-table-body"),
                },
            }
        };

        // --- STATE & STORAGE UTILITIES ---

        const storage = {
            get: (key) => localStorage.getItem(key),
            set: (key, value) => localStorage.setItem(key, value),
            remove: (key) => localStorage.removeItem(key),
            
            getJson: (key) => {
                try {
                    return JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    return null;
                }
            },
            setJson: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            
            getConfig: (key) => storage.get(key) || DEFAULT_CONFIG[key],
            getCredentials: () => ({
                username: storage.get("username"),
                password: storage.get("password"),
            }),
            getToken: () => storage.get("token"),
            getAuthHeaders: () => ({
                basic: () => {
                    const { username, password } = storage.getCredentials();
                    return username && password ? `Basic ${btoa(`${username}:${password}`)}` : null;
                },
                bearer: () => {
                    const token = storage.getToken();
                    return token ? `Bearer ${token}` : null;
                },
            }),
            isLoggedIn: () => !!storage.getToken() && !!storage.get("username"),
            
            clearCredentials: () => {
                storage.remove("token");
                storage.remove("username");
                storage.remove("password");
                storage.remove("firstName");
                storage.remove("lastName");
                storage.remove("avatarUrl");
                storage.remove("clientId");
            }
        };

        // --- CORE UTILITIES ---

        const showLoader = (show = true) => {
            dom.pageLoader.classList.toggle("hidden", !show);
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} animate-pulse`; // Start with pulse
            toast.innerHTML = `<p>${message}</p>`;
            dom.toastContainer.appendChild(toast);
            
            // Reflow to animate in
            setTimeout(() => toast.classList.remove("animate-pulse"), 10); 
            
            setTimeout(() => {
                toast.classList.add("opacity-0", "transition-opacity", "duration-500");
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };
        
        const logApiCall = async (url, options, response, responseData, error) => {
            const logs = storage.getJson("apiLogs") || [];
            const logEntry = {
                id: crypto.randomUUID(),
                timestamp: new Date().toISOString(),
                method: options.method || "GET",
                url: url,
                status: response ? response.status : (error ? "Network Error" : "Unknown"),
                request: options.body || null,
                response: responseData || (error ? { error: error.message } : null),
            };
            logs.unshift(logEntry); // Add to top
            storage.setJson("apiLogs", logs.slice(0, 100)); // Keep max 100 logs
        };

        const makeApiRequest = async (url, options = {}, authType = 'bearer') => {
            const fullUrl = url.startsWith('http') ? url : `${storage.getConfig("xpiBaseUrl")}${url}`;
            const headers = { ...options.headers };
            
            if (authType === 'bearer') {
                const auth = storage.getAuthHeaders().bearer();
                if (auth) headers['Authorization'] = auth;
            } else if (authType === 'basic') {
                const auth = storage.getAuthHeaders().basic();
                if (auth) headers['Authorization'] = auth;
            }
            
            const fetchOptions = { ...options, headers };
            
            let response, responseData, error;
            
            try {
                response = await fetch(fullUrl, fetchOptions);
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }
                
                if (!response.ok) {
                    error = new Error(responseData.message || responseData.error || response.statusText);
                    throw error;
                }
                
                await logApiCall(fullUrl, fetchOptions, response, responseData, null);
                return { ok: true, data: responseData };
                
            } catch (err) {
                error = err;
                await logApiCall(fullUrl, fetchOptions, response, responseData, error);
                
                // Construct a helpful error object
                const errorPayload = {
                    message: error.message,
                    status: response ? response.status : "Network Error",
                    ...(typeof responseData === 'object' ? responseData : { details: responseData })
                };
                
                return { ok: false, error: errorPayload, status: errorPayload.status };
            }
        };

        const showModule = (moduleId) => {
            $$(".module").forEach(m => m.classList.add("hidden"));
            const moduleEl = $(`#module-${moduleId}`);
            if (moduleEl) {
                moduleEl.classList.remove("hidden");
            } else {
                console.error(`Module #${moduleId} not found.`);
            }
        };
        
        const openModal = (modal) => modal.classList.remove('hidden');
        const closeModal = (modal) => modal.classList.add('hidden');
        
        // --- UI & NAVIGATION ---

        const updateNav = () => {
            dom.navLinks.innerHTML = '';
            MODULE_CONFIG
                .filter(m => m.type === 'User-defined')
                .forEach(m => {
                    const isActive = location.hash === m.hash;
                    dom.navLinks.innerHTML += `
                        <a href="${m.hash}" class="${isActive ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'} group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            ${m.name}
                        </a>`;
                });
        };
        
        const updateUserProfile = () => {
            if (storage.isLoggedIn()) {
                dom.userProfile.classList.remove("hidden");
                dom.userName.textContent = `${storage.get("firstName")} ${storage.get("lastName")}`;
                dom.userAvatar.src = storage.get("avatarUrl") || `https://placehold.co/40x40/555/FFF?text=${storage.get("firstName")?.[0] || 'U'}`;
            } else {
                dom.userProfile.classList.add("hidden");
            }
        };
        
        const updateLayout = () => {
            if (storage.isLoggedIn()) {
                dom.sidebar.classList.remove("hidden");
                updateUserProfile();
                updateNav();
            } else {
                dom.sidebar.classList.add("hidden");
            }
        };
        
        const handleLogout = () => {
            storage.clearCredentials();
            updateLayout();
            location.hash = "#login";
        };
        
        // --- MODULE LOGIC ---

        // ----- Login Module (MOD.B) -----
        const initLoginModule = async (code) => {
            const { authMode, callbackMode, authBtn, loading, error, errorMessage, errorDetails, startOverBtn, success, successMessage } = dom.modules.login;
            
            if (!code) {
                // Mode 1: Authentication
                authMode.classList.remove("hidden");
                callbackMode.classList.add("hidden");
                
                authBtn.onclick = async () => {
                    showLoader();
                    try {
                        const timestamp = Date.now().toString();
                        const random = Math.random().toString();
                        const data = new TextEncoder().encode(timestamp + random);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        const clientId = hashHex.slice(-7);
                        
                        storage.set("clientId", clientId);
                        
                        const redirectUri = `${location.origin}${location.pathname}`;
                        const xpiBaseUrl = storage.getConfig("xpiBaseUrl");
                        const authUrl = `${xpiBaseUrl}/?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${clientId}`;
                        
                        window.location.href = authUrl;
                    } catch (err) {
                        showLoader(false);
                        showToast(`Error generating client ID: ${err.message}`, 'error');
                    }
                };
                
            } else {
                // Mode 2: OAuth Callback
                authMode.classList.add("hidden");
                callbackMode.classList.remove("hidden");
                loading.classList.remove("hidden");
                error.classList.add("hidden");
                success.classList.add("hidden");

                const clientId = storage.get("clientId");
                
                if (!clientId || !code) {
                    loading.classList.add("hidden");
                    error.classList.remove("hidden");
                    errorMessage.textContent = "Error: Missing 'code' or 'clientId'. Cannot proceed with authentication.";
                    errorDetails.textContent = "Please try the login process again.";
                    setTimeout(() => { location.href = location.pathname; }, 10000);
                    return;
                }
                
                // 1. Exchange code for token
                const tokenUrl = `/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                const tokenRes = await makeApiRequest(tokenUrl, { method: 'GET' }, 'none');
                
                if (!tokenRes.ok || !tokenRes.data.success) {
                    loading.classList.add("hidden");
                    error.classList.remove("hidden");
                    errorMessage.textContent = "An error occurred during token exchange.";
                    errorDetails.textContent = JSON.stringify(tokenRes.error || tokenRes.data, null, 2);
                    return;
                }
                
                // Store credentials
                const { token, credentials } = tokenRes.data.data;
                storage.set("token", token);
                storage.set("username", credentials.username);
                storage.set("password", credentials.password);

                // 2. Verify credentials by fetching profile
                const profileRes = await makeApiRequest('/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me', { method: 'GET' }, 'basic');

                if (!profileRes.ok || !profileRes.data.success || !profileRes.data.data.length) {
                    loading.classList.add("hidden");
                    error.classList.remove("hidden");
                    errorMessage.textContent = "Login failed. We were unable to verify your account.";
                    errorDetails.textContent = JSON.stringify(profileRes.error || profileRes.data, null, 2);
                    storage.clearCredentials(); // Clear bad credentials
                    return;
                }

                // Success!
                const profile = profileRes.data.data[0];
                storage.set("firstName", profile.firstName);
                storage.set("lastName", profile.lastName);
                storage.set("avatarUrl", profile.avatarUrl);
                
                loading.classList.add("hidden");
                success.classList.remove("hidden");
                successMessage.textContent = `${profile.firstName} ${profile.lastName} login successfully.`;

                // Update UI and redirect
                updateLayout();
                setTimeout(() => {
                    location.href = `${location.pathname}#campaign-submission`;
                }, 2000);
            }
        };

        // ----- Admin Module (MOD.A) -----
        const initAdminModule = () => {
            const { form, xpiBaseUrl } = dom.modules.admin;
            xpiBaseUrl.value = storage.getConfig("xpiBaseUrl");
            
            form.onsubmit = (e) => {
                e.preventDefault();
                storage.set("xpiBaseUrl", xpiBaseUrl.value);
                showToast("Configuration saved successfully!", "success");
            };
        };
        
        // ----- Campaign Submission Module (MOD.C) -----
        const loadCampaignDropdown = async (selectEl, url, valueField = "value") => {
            selectEl.innerHTML = `<option value="">Loading...</option>`;
            const res = await makeApiRequest(url, { method: 'GET' }, 'basic');
            if (res.ok && res.data.value) {
                selectEl.innerHTML = `<option value="">-- Select an option --</option>`;
                res.data.value.forEach(item => {
                    selectEl.innerHTML += `<option value="${item[valueField]}">${item[valueField]}</option>`;
                });
            } else {
                selectEl.innerHTML = `<option value="">Failed to load</option>`;
                showToast(`Failed to load data for ${selectEl.id}`, 'error');
            }
        };
        
        const initCampaignModule = () => {
            const { form, submitBtn, result, resultPre, client, debtor, agency } = dom.modules.campaign;
            
            // Load dropdowns
            loadCampaignDropdown(client, '/api/v1/wrikexpi/v1.0/value/clients-grm-mys');
            loadCampaignDropdown(debtor, '/api/v1/wrikexpi/v1.0/value/debtors-grm-mys');
            loadCampaignDropdown(agency, '/api/v1/wrikexpi/v1.0/value/agencies');

            form.onsubmit = async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting...";
                result.classList.add("hidden");
                
                try {
                    const formData = new FormData(form);
                    const fields = {};
                    
                    // Collect all form inputs
                    for (const el of form.elements) {
                        if (el.id && el.id.startsWith("campaign-")) {
                            const key = el.id.replace("campaign-", "");
                            if (el.type === 'hidden' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                                if (!['type', 'space', 'entity', 'varientId'].includes(key)) {
                                    fields[key] = el.value;
                                }
                            }
                        }
                    }

                    // Handle specific field types
                    fields.selectedchannels = fields.selectedchannels.split(',')
                        .map(s => s.trim())
                        .filter(Boolean);
                    fields.overallbudget = parseFloat(fields.overallbudget);

                    const payload = {
                        type: $("#campaign-type").value,
                        space: $("#campaign-space").value,
                        entity: $("#campaign-entity").value,
                        varientId: parseInt($("#campaign-varientId").value),
                        fields: fields
                    };

                    const res = await makeApiRequest('/api/v1/wrikexpi/campaign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }, 'bearer');

                    // Show result
                    result.classList.remove("hidden");
                    resultPre.textContent = JSON.stringify(res.data || res.error, null, 2);
                    
                    if (res.ok) {
                        resultPre.classList.remove("text-red-400");
                        resultPre.classList.add("text-green-400");
                        showToast("Campaign submitted successfully!", "success");
                        form.reset(); // Reset form on success
                        // Re-load dropdowns as reset clears them
                        loadCampaignDropdown(client, '/api/v1/wrikexpi/v1.0/value/clients-grm-mys');
                        loadCampaignDropdown(debtor, '/api/v1/wrikexpi/v1.0/value/debtors-grm-mys');
                        loadCampaignDropdown(agency, '/api/v1/wrikexpi/v1.0/value/agencies');
                    } else {
                        resultPre.classList.remove("text-green-400");
                        resultPre.classList.add("text-red-400");
                        showToast(`Error: ${res.error.message}`, "error");
                    }
                    
                } catch (err) {
                    result.classList.remove("hidden");
                    resultPre.classList.remove("text-green-400");
                    resultPre.classList.add("text-red-400");
                    resultPre.textContent = `Something went wrong. ${err.message}`;
                    showToast(`Submission failed: ${err.message}`, "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Campaign";
                }
            };
        };

        // ----- Master Data Module (Template) -----
        let currentMasterDataSlug = null;

        const renderMasterDataTable = (data, slug) => {
            const { tableHead, tableBody } = dom.modules.masterData;
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td class="p-4 text-center text-gray-400" colspan="99">No records found.</td></tr>`;
                return;
            }

            // Get all unique keys as headers
            const headers = new Set(['id', 'value']); // Prioritize id and value
            data.forEach(item => Object.keys(item).forEach(key => headers.add(key)));
            const headerOrder = Array.from(headers);
            
            // Add Actions header
            headerOrder.push('Actions');
            
            // Render header
            let headHtml = '<tr>';
            headerOrder.forEach(key => {
                headHtml += `<th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">${key}</th>`;
            });
            headHtml += '</tr>';
            tableHead.innerHTML = headHtml;

            // Render body
            let bodyHtml = '';
            data.forEach(item => {
                bodyHtml += '<tr>';
                headerOrder.forEach(key => {
                    if (key === 'Actions') {
                        bodyHtml += `
                            <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">
                                <button class="btn btn-secondary btn-sm master-data-edit-btn" data-record='${JSON.stringify(item)}'>Edit</button>
                                <button class="btn btn-danger btn-sm master-data-delete-btn" data-id="${item.id}">Delete</button>
                            </td>`;
                    } else {
                        const value = item[key] !== null && item[key] !== undefined ? item[key] : 'N/A';
                        bodyHtml += `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${value}</td>`;
                    }
                });
                bodyHtml += '</tr>';
            });
            tableBody.innerHTML = bodyHtml;
        };

        const loadMasterData = async (slug) => {
            const { loader, tableContainer, tableBody } = dom.modules.masterData;
            loader.classList.remove("hidden");
            tableContainer.classList.add("hidden");
            tableBody.innerHTML = '';

            const res = await makeApiRequest(`/api/v1/wrikexpi/v1.0/record/${slug}`, { method: 'GET' }, 'bearer');
            
            loader.classList.add("hidden");
            tableContainer.classList.remove("hidden");

            if (res.ok) {
                renderMasterDataTable(res.data.value, slug);
            } else {
                tableBody.innerHTML = `<tr><td class="p-4 text-center text-red-500" colspan="99">Error loading data: ${res.error.message}</td></tr>`;
                showToast(`Error loading data: ${res.error.message}`, 'error');
            }
        };

        const openMasterDataModal = (record = null) => {
            const { modal, form, title, id, value, code, fincode, guid, note } = dom.masterDataModal;
            form.reset();
            
            if (record) {
                // Edit mode
                title.textContent = `Edit Record (ID: ${record.id})`;
                id.value = record.id;
                value.value = record.value || '';
                code.value = record.code || '';
                fincode.value = record.fincode || '';
                guid.value = record.guid || '';
                note.value = record.note || '';
            } else {
                // Create mode
                title.textContent = "Create New Record";
                id.value = '';
            }
            openModal(modal);
        };
        
        const saveMasterData = async () => {
            const { modal, id, slug, value, code, fincode, guid, note, saveBtn } = dom.masterDataModal;
            const recordId = id.value;
            const isEdit = !!recordId;
            const dataSlug = currentMasterDataSlug;
            
            if (!value.value) {
                showToast("The 'value' field is mandatory.", 'error');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = "Saving...";

            const odataContext = `${storage.getConfig("xpiBaseUrl")}/api/v1/v1.0/${dataSlug}`;
            
            const payload = {
                "@odata.context": odataContext,
                value: value.value,
                code: code.value || null,
                fincode: fincode.value || null,
                guid: guid.value || null,
                note: note.value || null,
            };

            let res;
            if (isEdit) {
                payload.id = recordId;
                res = await makeApiRequest(`/api/v1/wrikexpi/v1.0/record/${dataSlug}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 'bearer');
            } else {
                res = await makeApiRequest(`/api/v1/wrikexpi/v1.0/record/${dataSlug}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 'bearer');
            }

            saveBtn.disabled = false;
            saveBtn.textContent = "Save Changes";

            if (res.ok) {
                showToast(`Record ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
                closeModal(modal);
                loadMasterData(dataSlug); // Refresh table
            } else {
                showToast(`Error: ${res.error.message}`, 'error');
            }
        };

        const openDeleteConfirm = (id) => {
            const { modal, id: modalId, slug } = dom.deleteConfirmModal;
            modalId.value = id;
            openModal(modal);
        };

        const deleteMasterData = async () => {
            const { modal, id, confirmBtn } = dom.deleteConfirmModal;
            const recordId = id.value;
            const dataSlug = currentMasterDataSlug;

            confirmBtn.disabled = true;
            confirmBtn.textContent = "Deleting...";

            const res = await makeApiRequest(`/api/v1/wrikexpi/v1.0/record/${dataSlug}/${recordId}`, {
                method: 'DELETE'
            }, 'bearer');

            confirmBtn.disabled = false;
            confirmBtn.textContent = "Delete";

            if (res.ok) {
                showToast("Record deleted successfully!", 'success');
                closeModal(modal);
                loadMasterData(dataSlug); // Refresh table
            } else {
                showToast(`Error: ${res.error.message}`, 'error');
            }
        };
        
        const initMasterDataModule = (slug, title) => {
            currentMasterDataSlug = slug;
            const { el, title: titleEl, loadBtn, createBtn, tableBody } = dom.modules.masterData;
            
            titleEl.textContent = title;
            showModule('master-data');
            
            // Clear table on module switch
            tableBody.innerHTML = '<tr><td class="p-4 text-center text-gray-400" colspan="99">Click "Load Data" to begin.</td></tr>';
            
            // Attach event listeners (only once)
            if (!loadBtn.dataset.listener) {
                loadBtn.dataset.listener = 'true';
                loadBtn.onclick = () => loadMasterData(currentMasterDataSlug);
                createBtn.onclick = () => openMasterDataModal(null);
                
                // Event delegation for table buttons
                el.onclick = (e) => {
                    if (e.target.matches('.master-data-edit-btn')) {
                        const record = JSON.parse(e.target.dataset.record);
                        openMasterDataModal(record);
                    }
                    if (e.target.matches('.master-data-delete-btn')) {
                        openDeleteConfirm(e.target.dataset.id);
                    }
                };
                
                dom.masterDataModal.form.onsubmit = (e) => {
                    e.preventDefault();
                    saveMasterData();
                };

                dom.deleteConfirmModal.confirmBtn.onclick = deleteMasterData;
            }
            
            // Automatically load data for convenience
            loadMasterData(slug);
        };

        // ----- Developer Tool -----
        const openPayloadViewer = (title, payload) => {
            const { modal, title: titleEl, pre } = dom.payloadViewerModal;
            titleEl.textContent = title;
            try {
                pre.textContent = JSON.stringify(JSON.parse(payload), null, 2);
            } catch (e) {
                pre.textContent = payload || "No Data";
            }
            openModal(modal);
        };
        
        const renderDevTool = () => {
            const { logBody } = dom.devToolModal;
            const logs = storage.getJson("apiLogs") || [];
            logBody.innerHTML = '';
            
            if (logs.length === 0) {
                logBody.innerHTML = `<tr><td class="p-4 text-center text-gray-400" colspan="6">No API calls logged.</td></tr>`;
                return;
            }
            
            logs.forEach(log => {
                const statusColor = log.status >= 400 ? 'text-red-400' : (log.status >= 200 && log.status < 300 ? 'text-green-400' : 'text-yellow-400');
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-700";
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${statusColor}">${log.status}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${log.method}</td>
                    <td class="px-4 py-3 text-sm text-gray-300 truncate" style="max-width: 20vw;" title="${log.url}">${log.url}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm"><a href="#" class="text-blue-400 hover:underline" data-payload-type="Request" data-log-id="${log.id}">View</a></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm"><a href="#" class="text-blue-400 hover:underline" data-payload-type="Response" data-log-id="${log.id}">View</a></td>
                `;
                
                row.querySelectorAll('a[data-log-id]').forEach(link => {
                    link.onclick = (e) => {
                        e.preventDefault();
                        const type = e.target.dataset.payloadType;
                        const logData = logs.find(l => l.id === log.id);
                        const payload = type === 'Request' ? logData.request : logData.response;
                        openPayloadViewer(`${type} Payload for ${log.method}`, payload);
                    };
                });
                
                logBody.appendChild(row);
            });
        };
        
        const initDevTool = () => {
            dom.devToolToggle.onclick = () => {
                renderDevTool();
                openModal(dom.devToolModal.modal);
            };
            dom.devToolModal.purgeBtn.onclick = () => {
                storage.setJson("apiLogs", []);
                renderDevTool();
                showToast("API logs purged!", "info");
            };
        };

        // --- ROUTING & INITIALIZATION ---

        const handleRouting = () => {
            const hash = location.hash || '#';
            const params = new URLSearchParams(location.search);
            const code = params.get('code');
            
            if (!storage.isLoggedIn() && !code && hash !== '#admin') {
                location.hash = '#login';
            }
            
            // Clear search params after reading code
            if (code) {
                history.replaceState(null, '', location.pathname + '#login');
            }
            
            updateNav(); // Highlight active link
            
            // Built-in routes
            if (hash === '#admin') {
                showModule('admin');
                initAdminModule();
                return;
            }
            if (hash === '#login' || code) {
                showModule('login');
                initLoginModule(code); // Pass code if present
                return;
            }
            
            // Authenticated routes
            if (!storage.isLoggedIn()) {
                return; // Guard clause
            }
            
            const moduleDef = MODULE_CONFIG.find(m => m.hash === hash);
            
            if (moduleDef && moduleDef.type === 'User-defined') {
                if (moduleDef.slug) {
                    // This is a master data module
                    initMasterDataModule(moduleDef.slug, moduleDef.name);
                } else if (moduleDef.hash === '#campaign-submission') {
                    showModule('campaign-submission');
                    initCampaignModule();
                }
            } else {
                // Default to campaign submission if logged in and no valid hash
                location.hash = '#campaign-submission';
            }
        };

        const initializeApp = () => {
            // Set default config if not present
            if (!storage.get("xpiBaseUrl")) {
                storage.set("xpiBaseUrl", DEFAULT_CONFIG.xpiBaseUrl);
            }
            
            // Attach global event listeners
            dom.logoutLink.onclick = (e) => { e.preventDefault(); handleLogout(); };
            dom.mobileMenuBtn.onclick = () => dom.sidebar.classList.toggle("hidden");
            dom.sidebarToggleBtn.onclick = () => dom.sidebar.classList.toggle("hidden");
            
            // Attach modal close listeners
            $$(".modal-close-btn").forEach(btn => {
                btn.onclick = () => closeModal(btn.closest(".modal"));
            });
            
            // Close payload viewer modal
            dom.payloadViewerModal.modal.querySelector('.modal-close-btn').onclick = ()_ => {
                closeModal(dom.payloadViewerModal.modal);
            };

            // Init Dev Tool
            initDevTool();

            // Handle routing on load and hash change
            window.addEventListener('hashchange', handleRouting);
            
            // Initial setup
            updateLayout();
            handleRouting();
        };

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>

