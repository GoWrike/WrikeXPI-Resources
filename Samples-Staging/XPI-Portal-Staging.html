<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Tailwind & Load Inter Font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    zIndex: {
                        '60': '60',
                        '70': '70',
                    }
                },
            },
        }
    </script>
    
    <!-- 3. Base Styles & Loader -->
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        
        /* Simple loader for initial page loads and callbacks */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide scrollbar for webkit */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Styling for the tag input */
        .tag-container .tag {
            display: inline-flex;
            align-items: center;
            background-color: #374151; /* bg-gray-700 */
            color: #D1D5DB; /* text-gray-300 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* rounded-full */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        .tag-container .tag-close {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body class="styled-body font-sans">

    <!-- App Wrapper -->
    <div class="flex w-screen h-screen">

        <!-- ===== 1. Navigation Sidebar ===== -->
        <nav id="app-sidebar" class="styled-sidebar flex-col flex-shrink-0 h-full styled-transition" data-visible="false">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-4 border-b styled-border-color">
                <span class="text-xl font-semibold">XPI Portal</span>
                <button id="sidebar-toggle-btn" class="styled-icon-btn">
                    <span data-icon="menu"></span>
                </button>
            </div>

            <!-- Nav Links -->
            <div id="nav-links-container" class="flex-1 overflow-y-auto py-4 space-y-2">
                <!-- User-defined modules will be injected here by JS -->
            </div>

            <!-- User Profile (Bottom) -->
            <div class="p-4 border-t styled-border-color mt-auto">
                <div class="flex items-center">
                    <img id="user-avatar" src="https://placehold.co/40x40/555/FFF?text=?" alt="User Avatar" class="w-10 h-10 rounded-full mr-3">
                    <div>
                        <div id="user-name" class="font-semibold">Not Logged In</div>
                        <a id="logout-link" href="#" class="text-sm text-blue-400 hover:underline">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ===== 2. Main Content Area ===== -->
        <main id="main-content" class="flex-1 h-full overflow-y-auto styled-transition">
            <div class="container mx-auto p-4 md:p-8">

                <!-- Module: Loading (for login callback) -->
                <div id="module-loading" class="module-container hidden">
                    <div class="styled-card max-w-md mx-auto p-8 text-center">
                        <div class="loader mx-auto mb-4"></div>
                        <h2 class="styled-card-title">Processing Login...</h2>
                        <p>Please wait while we verify your authentication.</p>
                        <div id="loading-error-container" class="hidden mt-4">
                            <p id="loading-error-message" class="styled-text-error"></p>
                            <pre id="loading-error-details" class="styled-pre mt-2"></pre>
                            <button id="loading-start-over-btn" class="styled-btn-secondary mt-4">Start Over</button>
                        </div>
                    </div>
                </div>

                <!-- Module: Login (Auth Mode) -->
                <div id="module-login" class="module-container hidden">
                    <div class="styled-card max-w-md mx-auto">
                        <h2 class="styled-card-title mb-6 text-center">XPI Portal Login</h2>
                        <button id="login-auth-btn" class="styled-btn-primary w-full">
                            Login & Authenticate with Wrike
                        </button>
                    </div>
                </div>

                <!-- Module: Admin -->
                <div id="module-admin" class="module-container hidden">
                    <div class="styled-card max-w-lg mx-auto">
                        <h2 class="styled-card-title mb-6">Global Configuration</h2>
                        <form id="admin-config-form">
                            <div class="mb-4">
                                <label for="config-xpiBaseUrl" class="styled-label">XPI Base URL</label>
                                <input list="xpiBaseUrl-suggestions" id="config-xpiBaseUrl" name="xpiBaseUrl" type="text" class="styled-input w-full">
                                <datalist id="xpiBaseUrl-suggestions">
                                    <option value="https://api.wrikexpi.groupm.com"></option>
                                    <option value="https://xpi-api.gowrike.space/"></option>
                                </datalist>
                            </div>
                            <button type="submit" class="styled-btn-primary">Save Configuration</button>
                        </form>
                    </div>
                </div>

                <!-- Module: Campaign Submission (MOD.C) -->
                <div id="module-MOD.C" class="module-container hidden">
                    <form id="campaign-form" class="styled-card max-w-4xl mx-auto">
                        <h2 class="styled-card-title mb-6">Campaign Submission</h2>
                        
                        <!-- Hidden Fields -->
                        <input type="hidden" name="type" value="Campaign Request">
                        <input type="hidden" name="space" value="GRM-MYS-GMN">
                        <input type="hidden" name="entity" value="Campaign">
                        <input type="hidden" name="varientId" value="1">

                        <!-- Form Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <!-- Left Column -->
                            <div>
                                <label for="campaign-campaignname" class="styled-label">Campaign Name</label>
                                <input type="text" id="campaign-campaignname" name="campaignname" value="World Pinball Day 7000" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-client" class="styled-label">Client</label>
                                <select id="campaign-client" name="client" class="styled-input w-full">
                                    <option value="Adidas Group">Adidas Group</option>
                                    <!-- Options loaded by JS -->
                                </select>
                            </div>
                             <div>
                                <label for="campaign-brand" class="styled-label">Brand</label>
                                <input type="text" id="campaign-brand" name="brand" value="World Pinball" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-debtor" class="styled-label">Debtor</label>
                                <select id="campaign-debtor" name="debtor" class="styled-input w-full">
                                    <option value="Adidas Malaysia Sdn Bhd">Adidas Malaysia Sdn Bhd</option>
                                    <!-- Options loaded by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="campaign-agency" class="styled-label">Agency</label>
                                <select id="campaign-agency" name="agency" class="styled-input w-full">
                                    <option value="Eightbar">Eightbar</option>
                                    <!-- Options loaded by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="campaign-pod" class="styled-label">Pod</label>
                                <input type="text" id="campaign-pod" name="pod" value="Pod 1A" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-currency" class="styled-label">Currency</label>
                                <input type="text" id="campaign-currency" name="currency" value="SGD" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-overallbudget" class="styled-label">Overall Budget</label>
                                <input type="number" id="campaign-overallbudget" name="overallbudget" value="100" class="styled-input w-full">
                            </div>

                            <!-- Right Column -->
                            <div>
                                <label for="campaign-requestedstartdate" class="styled-label">Requested Start Date</label>
                                <input type="date" id="campaign-requestedstartdate" name="requestedstartdate" value="2026-07-01" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-campaignstartdate" class="styled-label">Campaign Start Date</label>
                                <input type="date" id="campaign-campaignstartdate" name="campaignstartdate" value="2026-08-29" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-campaignenddate" class="styled-label">Campaign End Date</label>
                                <input type="date" id="campaign-campaignenddate" name="campaignenddate" value="2026-10-29" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-campaignobjective" class="styled-label">Campaign Objective</label>
                                <input type="text" id="campaign-campaignobjective" name="campaignobjective" value="Upper Funnel / Awareness" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-requestormarket" class="styled-label">Requestor Market</label>
                                <input type="text" id="campaign-requestormarket" name="requestormarket" value="Singapore" class="styled-input w-full">
                            </div>
                            <div>
                                <label for="campaign-optin" class="styled-label">Opt-in</label>
                                <select id="campaign-optin" name="optin" class="styled-input w-full">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div>
                                <label for="campaign-porequired" class="styled-label">PO Required</label>
                                <select id="campaign-porequired" name="porequired" class="styled-input w-full">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>

                            <!-- Spanning full width -->
                            <div class="md:col-span-2">
                                <label for="campaign-selectedchannels-input" class="styled-label">Selected Channels (press Enter or comma to add)</label>
                                <div class="styled-input w-full p-2 flex flex-wrap items-center tag-container">
                                    <div id="campaign-selectedchannels-tags" class="flex flex-wrap">
                                        <!-- Tags will be injected here -->
                                    </div>
                                    <input type="text" id="campaign-selectedchannels-input" placeholder="Type a channel..." class="bg-transparent flex-1 focus:outline-none min-w-[100px]">
                                </div>
                            </div>
                        </div>

                        <!-- Submission -->
                        <div class="mt-8 text-right">
                            <button type="submit" id="campaign-submit-btn" class="styled-btn-primary">
                                Submit Campaign
                            </button>
                        </div>
                    </form>
                    
                    <!-- Result Display -->
                    <pre id="campaign-result" class="styled-pre max-w-4xl mx-auto mt-6 hidden"></pre>
                </div>

                <!-- Module: Master Data Template (for D & E) -->
                <!-- This will be a reusable structure, cloned and configured by JS -->
                <div id="mdm-template" class="hidden">
                    <div class="styled-card max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="styled-card-title mdm-title">Master Data</h2>
                            <div class="space-x-2">
                                <button class="styled-btn-secondary mdm-load-btn">
                                    <span data-icon="reload" class="inline-block w-4 h-4 mr-1"></span>
                                    Load
                                </button>
                                <button class="styled-btn-primary mdm-create-btn">
                                    <span data-icon="plus" class="inline-block w-4 h-4 mr-1"></span>
                                    Create New
                                </button>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div class="w-full overflow-x-auto">
                            <table class="styled-table w-full min-w-[600px]">
                                <thead class="mdm-thead">
                                    <!-- Header row injected by JS -->
                                </thead>
                                <tbody class="mdm-tbody">
                                    <!-- Data rows injected by JS -->
                                    <tr>
                                        <td colspan="100%" class="text-center p-4">Click "Load" to fetch data.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mdm-loader loader mx-auto my-4 hidden"></div>
                    </div>
                </div>

                <!-- Module: Demo Client (MAS.DemoCient) -->
                <div id="module-MAS.DemoCient" class="module-container hidden">
                    <!-- MDM Template will be injected here -->
                </div>

                <!-- Module: XPI Field Mapping (MAS.XPICFMapping) -->
                <div id="module-MAS.XPICFMapping" class="module-container hidden">
                    <!-- MDM Template will be injected here -->
                </div>

            </div>
        </main>
    </div>

    <!-- ===== 3. Modals & Overlays ===== -->

    <!-- Generic Modal for MDM Create/Edit -->
    <div id="mdm-modal" class="styled-modal-overlay hidden">
        <div class="styled-modal-card max-w-lg w-full">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h3 id="mdm-modal-title" class="styled-card-title">Modal Title</h3>
                <button id="mdm-modal-close-btn" class="styled-icon-btn">
                    <span data-icon="close"></span>
                </button>
            </div>
            <!-- Form -->
            <form id="mdm-modal-form">
                <input type="hidden" id="mdm-form-id" name="id">
                <div id="mdm-form-fields" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Form fields injected by JS -->
                </div>
                <div class="mt-6 text-right">
                    <button type="submit" id="mdm-form-save-btn" class="styled-btn-primary">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Generic Modal for MDM Delete Confirmation -->
    <div id="mdm-delete-modal" class="styled-modal-overlay hidden">
        <div class="styled-modal-card max-w-md w-full">
            <h3 class="styled-card-title mb-4">Confirm Deletion</h3>
            <p id="mdm-delete-message">Are you sure you want to delete this record?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="mdm-delete-cancel-btn" class="styled-btn-secondary">Cancel</button>
                <button id="mdm-delete-confirm-btn" class="styled-btn-danger">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Developer Tool Toggle Button -->
    <button id="dev-tool-toggle" class="fixed bottom-6 right-6 styled-btn-primary p-3 rounded-full shadow-lg z-30">
        <span data-icon="hat"></span>
    </button>

    <!-- Developer Tool Modal -->
    <div id="dev-tool-modal" class="styled-modal-overlay hidden">
        <div class="styled-modal-card w-[80%] h-[80%] max-w-none max-h-none flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="styled-card-title">Developer Tool: API Logs</h3>
                <div>
                    <button id="dev-tool-purge-btn" class="styled-icon-btn mr-2" title="Clear Logs">
                        <span data-icon="trash"></span>
                    </button>
                    <button id="dev-tool-close-btn" class="styled-icon-btn" title="Close">
                        <span data-icon="close"></span>
                    </button>
                </div>
            </div>
            <!-- Log Table -->
            <div class="flex-1 overflow-auto no-scrollbar">
                <table class="styled-table w-full min-w-[800px]">
                    <thead>
                        <tr>
                            <th class="w-1/6">Timestamp</th>
                            <th class="w-16">Status</th>
                            <th class="w-16">Method</th>
                            <th>URL</th>
                            <th class="w-24">Request</th>
                            <th class="w-24">Response</th>
                        </tr>
                    </thead>
                    <tbody id="dev-tool-log-body">
                        <!-- Logs injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Developer Tool Payload Viewer Modal -->
    <div id="dev-payload-modal" class="styled-modal-overlay hidden z-60">
        <div class="styled-modal-card w-[70%] h-[70%] max-w-none max-h-none flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="dev-payload-title" class="styled-card-title">Payload</h3>
                <button id="dev-payload-close-btn" class="styled-icon-btn">
                    <span data-icon="close"></span>
                </button>
            </div>
            <!-- Payload -->
            <div class="flex-1 overflow-auto no-scrollbar">
                <pre id="dev-payload-content" class="styled-pre w-full h-full"></pre>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-6 right-6 space-y-3 z-70">
        <!-- Toasts injected by JS -->
    </div>


    <!-- ===== 4. JavaScript Application ===== -->
    <script type="module">
        /**
         * XPI Portal Application
         * All logic is contained within this module.
         */

        // ---------------------------------------------------------------------
        // A. CONSTANTS & CONFIGURATION
        // ---------------------------------------------------------------------

        const MODULE_CONFIG = [
            { code: "MOD.A", name: "Admin", type: "Built-in" },
            { code: "MOD.B", name: "Login", type: "Built-in" },
            { code: "MOD.C", name: "Campaign Submission", type: "User-defined" },
            { code: "MAS.DemoCient", name: "Demo Client", type: "User-defined" },
            { code: "MAS.XPICFMapping", name: "XPI Field Mapping", type: "User-defined" }
        ];

        const GLOBAL_CONFIG_DEFAULTS = {
            xpiBaseUrl: 'https://xpi-api.gowrike.space/'
        };
        
        /**
         * Icon definitions (Bootstrap Icons)
         * Using data-icon="name" in HTML will replace the span with the SVG.
         */
        const ICONS = {
            'menu': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>',
            'close': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>',
            'trash': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.528ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Zm3.5 0a.5.5 0 0 1 .5.47l-.5 8.5a.5.5 0 0 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47Z"/></svg>',
            'hat': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-mortarboard-fill" viewBox="0 0 16 16"><path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3.5a.5.5 0 0 0 .372 0L15.5 6.464a.5.5 0 0 0 .025-.917l-7.5-3.5Z"/><path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Zm-.068 1.873.22-.748L8 11.123l3.672-1.465.22.748L8 12.596 4.108 10.905Z"/></svg>',
            'reload': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>',
            'plus': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/></svg>',
            'edit': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>',
            'delete': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg>',
        };
        
        /**
         * Style Guide for dynamic class replacement.
         * This is the core of the dynamic styling requirement.
         */
        const STYLE_GUIDE = {
            'styled-body': 'bg-gray-900 text-gray-200',
            'styled-sidebar': 'w-64 bg-gray-800 border-r border-gray-700',
            'styled-border-color': 'border-gray-700',
            'styled-transition': 'transition-all duration-300 ease-in-out',
            'styled-card': 'bg-gray-800 shadow-xl rounded-lg p-6 md:p-8',
            'styled-card-title': 'text-2xl font-semibold text-white mb-1',
            'styled-label': 'block text-sm font-medium text-gray-400 mb-2',
            'styled-input': 'bg-gray-700 border border-gray-600 text-gray-200 rounded-md w-full p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500',
            'styled-btn-primary': 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed',
            'styled-btn-secondary': 'bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed',
            'styled-btn-danger': 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed',
            'styled-icon-btn': 'text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-full transition duration-200',
            'styled-pre': 'bg-gray-900 border border-gray-700 text-gray-300 text-sm rounded-md p-4 overflow-auto max-h-60',
            'styled-text-error': 'text-red-400 font-medium',
            'styled-text-success': 'text-green-400 font-medium',
            'styled-table': 'w-full text-left border-collapse',
            'styled-modal-overlay': 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-40',
            'styled-modal-card': 'bg-gray-800 shadow-xl rounded-lg p-6 z-50',
            'styled-toast-success': 'bg-green-600 text-white p-4 rounded-md shadow-lg',
            'styled-toast-error': 'bg-red-600 text-white p-4 rounded-md shadow-lg',
        };
        
        // MDM Module configurations
        const MDM_CONFIG = {
            'MAS.DemoCient': {
                moduleId: 'MAS.DemoCient',
                slug: 'demoxpiclients',
                title: 'Demo Clients',
                fields: ['id', 'value', 'note', 'fincode', 'code'],
                fieldLabels: {
                    id: 'ID',
                    value: 'Value',
                    note: 'Note',
                    fincode: 'Fin Code',
                    code: 'Code'
                },
                readOnlyFields: ['id'],
                requiredFields: ['value']
            },
            'MAS.XPICFMapping': {
                moduleId: 'MAS.XPICFMapping',
                slug: 'xpicfmapping',
                title: 'XPI Custom Field Mappings',
                fields: ['id', 'value', 'cfName'], // Assuming 'cfName' is the key
                fieldLabels: {
                    id: 'ID',
                    value: 'Value',
                    cfName: 'CF Name'
                },
                readOnlyFields: ['id'],
                requiredFields: ['value']
            }
        };


        // ---------------------------------------------------------------------
        // B. CORE APPLICATION STATE & UTILITIES
        // ---------------------------------------------------------------------

        /**
         * Global state for MDM modules to avoid stale closures.
         * Stores the currently active record for edit/delete.
         */
        const mdmState = {
            activeRecord: null,
            isEditMode: false,
            activeModuleId: null
        };

        /**
         * Replaces placeholder class strings with full Tailwind classes.
         * Preserves other classes on the element.
         */
        function initTailwindPlaceholders() {
            for (const [placeholder, classString] of Object.entries(STYLE_GUIDE)) {
                const elements = document.querySelectorAll(`.${placeholder}`);
                elements.forEach(el => {
                    // Use replace to only swap the placeholder, keeping other classes
                    el.className = el.className.replace(placeholder, classString);
                });
            }
            
            // Special handling for table headers/rows in the template
            const tableHead = document.querySelector('#mdm-template .styled-table thead');
            if (tableHead) tableHead.className = 'bg-gray-700';
            
            const tableBody = document.querySelector('#mdm-template .styled-table tbody');
            if (tableBody) tableBody.className = 'divide-y divide-gray-700';

            // Find all th/td in the template and apply styles
            document.querySelectorAll('#mdm-template .styled-table th').forEach(th => {
                th.className = 'p-3 font-semibold text-left';
            });
            document.querySelectorAll('#mdm-template .styled-table td').forEach(td => {
                td.className = 'p-3';
            });
        }
        
        /**
         * Injects SVG icons into elements with [data-icon] attribute.
         */
        function initSvgIcons() {
            document.querySelectorAll('[data-icon]').forEach(el => {
                const iconName = el.getAttribute('data-icon');
                if (ICONS[iconName]) {
                    el.innerHTML = ICONS[iconName];
                }
            });
        }
        
        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {'success' | 'error'} type - The type of toast.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const styleClass = type === 'success' ? 'styled-toast-success' : 'styled-toast-error';
            
            toast.className = `${STYLE_GUIDE[styleClass]} opacity-0 transform translate-x-10 transition-all duration-300`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-10');
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Hides all module containers and shows the one with the specified ID.
         * @param {string} moduleCode - The module code (e.g., 'login', 'MOD.C').
         */
        function showModule(moduleCode) {
            document.querySelectorAll('.module-container').forEach(mod => {
                mod.classList.add('hidden');
            });
            
            const moduleEl = document.getElementById(`module-${moduleCode}`);
            if (moduleEl) {
                moduleEl.classList.remove('hidden');
            } else {
                console.error(`Module container not found: #module-${moduleCode}`);
                // Fallback to login if all else fails
                if (!sessionStorage.getItem('token')) {
                    document.getElementById('module-login').classList.remove('hidden');
                }
            }
            
            // Update active nav link
            document.querySelectorAll('#nav-links-container a').forEach(a => {
                if (a.hash === `#${moduleCode}`) {
                    a.classList.add('bg-gray-700', 'text-white');
                    a.classList.remove('text-gray-400', 'hover:bg-gray-700');
                } else {
                    a.classList.remove('bg-gray-700', 'text-white');
                    a.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            });
        }

        /**
         * Gets a value from Global Config (localStorage).
         * @param {string} key - The config key.
         * @returns {string} The config value.
         */
        function getGlobalConfig(key) {
            return localStorage.getItem(key) || GLOBAL_CONFIG_DEFAULTS[key];
        }

        /**
         * Sets a value in Global Config (localStorage).
         * @param {string} key - The config key.
         * @param {string} value - The config value.
         */
        function setGlobalConfig(key, value) {
            localStorage.setItem(key, value);
        }
        
        /**
         * Initializes default global config if not set.
         */
        function initGlobalConfig() {
            if (!localStorage.getItem('xpiBaseUrl')) {
                localStorage.setItem('xpiBaseUrl', GLOBAL_CONFIG_DEFAULTS.xpiBaseUrl);
            }
        }
        
        /**
         * Hashes a string using SHA-256.
         * @param {string} string - The string to hash.
         * @returns {Promise<string>} The hex-encoded hash.
         */
        async function sha256(string) {
            const utf8 = new TextEncoder().encode(string);
            const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // ---------------------------------------------------------------------
        // C. API & DEVELOPER TOOL
        // ---------------------------------------------------------------------

        /**
         * Logs an API call to localStorage for the dev tool.
         * Scrubs Authorization header.
         * @param {object} request - Request details { method, url, headers, body }.
         * @param {object} response - Response details { status, body }.
         */
        async function logApiCall(request, response) {
            let logs = [];
            try {
                logs = JSON.parse(localStorage.getItem('apiLogs') || '[]');
            } catch (e) {
                console.error("Failed to parse apiLogs, resetting.", e);
                logs = [];
            }
            
            // Deep copy and scrub headers
            const loggedRequest = JSON.parse(JSON.stringify(request));
            if (loggedRequest.headers && loggedRequest.headers['Authorization']) {
                loggedRequest.headers['Authorization'] = 'Bearer [REDACTED]';
            }
            
            const logEntry = {
                id: crypto.randomUUID(),
                timestamp: new Date().toISOString(),
                method: loggedRequest.method,
                url: loggedRequest.url,
                status: response.status,
                request: loggedRequest,
                response: response
            };

            logs.unshift(logEntry); // Add to start (chronological)
            localStorage.setItem('apiLogs', JSON.stringify(logs.slice(0, 100))); // Limit logs
        }
        
        /**
         * Secure fetch wrapper.
         * Handles auth, logging, and base URL.
         * @param {string} url - The API endpoint (e.g., '/token/exchange').
         * @param {object} options - Fetch options.
         * @param {'bearer' | 'basic' | 'none'} authType - Type of authentication.
         * @param {string} [username] - For basic auth.
         * @param {string} [password] - For basic auth.
         * @returns {Promise<Response>} The fetch Response object.
         */
        async function secureFetch(url, options = {}, authType = 'none', username = '', password = '') {
            const xpiBaseUrl = getGlobalConfig('xpiBaseUrl').replace(/\/$/, ''); // Remove trailing slash
            const fullUrl = url.startsWith('http') ? url : `${xpiBaseUrl}${url}`;
            
            const headers = new Headers(options.headers || {});
            headers.set('Content-Type', 'application/json');

            if (authType === 'bearer') {
                const token = sessionStorage.getItem('token');
                if (token) {
                    headers.set('Authorization', `Bearer ${token}`);
                }
            } else if (authType === 'basic' && username && password) {
                headers.set('Authorization', `Basic ${btoa(`${username}:${password}`)}`);
            }
            
            const requestDetails = {
                method: options.method || 'GET',
                url: fullUrl,
                headers: Object.fromEntries(headers.entries()),
                body: options.body ? JSON.parse(options.body) : null
            };
            
            let response;
            let responseBody;
            let responseStatus;

            try {
                response = await fetch(fullUrl, { ...options, headers });
                responseStatus = response.status;
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseBody = await response.json();
                } else {
                    responseBody = await response.text();
                }

                // Clone response to log and return
                const responseToReturn = new Response(JSON.stringify(responseBody), {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                });
                
                // Log the call
                await logApiCall(requestDetails, { status: responseStatus, body: responseBody });
                
                return responseToReturn;

            } catch (error) {
                console.error('Fetch Error:', error);
                const errorResponse = {
                    status: 0,
                    body: { error: 'Network Error', message: error.message }
                };
                await logApiCall(requestDetails, errorResponse);
                
                // Return a response-like object for consistency
                return new Response(JSON.stringify(errorResponse.body), {
                    status: errorResponse.status,
                    statusText: 'Network Error'
                });
            }
        }
        
        /**
         * Initializes the Developer Tool functionality.
         */
        function initDevTool() {
            const toggleBtn = document.getElementById('dev-tool-toggle');
            const modal = document.getElementById('dev-tool-modal');
            const closeBtn = document.getElementById('dev-tool-close-btn');
            const purgeBtn = document.getElementById('dev-tool-purge-btn');
            const logBody = document.getElementById('dev-tool-log-body');
            
            const payloadModal = document.getElementById('dev-payload-modal');
            const payloadTitle = document.getElementById('dev-payload-title');
            const payloadContent = document.getElementById('dev-payload-content');
            const payloadCloseBtn = document.getElementById('dev-payload-close-btn');

            const showDevModal = (visible) => {
                if (visible) {
                    loadDevLogs();
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            };

            const showPayloadModal = (title, payload) => {
                payloadTitle.textContent = title;
                try {
                    payloadContent.textContent = JSON.stringify(payload, null, 2);
                } catch (e) {
                    payloadContent.textContent = "Failed to stringify payload:\n\n" + payload;
                }
                payloadModal.classList.remove('hidden');
            };

            toggleBtn.addEventListener('click', () => showDevModal(true));
            closeBtn.addEventListener('click', () => showDevModal(false));
            payloadCloseBtn.addEventListener('click', () => payloadModal.classList.add('hidden'));
            
            purgeBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to purge all API logs?')) {
                    localStorage.removeItem('apiLogs');
                    loadDevLogs();
                }
            });

            function loadDevLogs() {
                logBody.innerHTML = ''; // Clear existing
                let logs = [];
                try {
                    logs = JSON.parse(localStorage.getItem('apiLogs') || '[]');
                } catch (e) {
                    logBody.innerHTML = `<tr><td colspan="6" class="p-4 text-red-400">Error loading logs. They may be corrupt.</td></tr>`;
                    return;
                }
                
                if (logs.length === 0) {
                    logBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">No API calls logged.</td></tr>`;
                    return;
                }
                
                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-700 hover:bg-gray-700';
                    
                    const statusClass = log.status >= 400 ? 'text-red-400' : log.status >= 300 ? 'text-yellow-400' : 'text-green-400';
                    
                    tr.innerHTML = `
                        <td class="p-2 text-xs">${new Date(log.timestamp).toLocaleTimeString()}</td>
                        <td class="p-2 font-semibold ${statusClass}">${log.status}</td>
                        <td class="p-2">${log.method}</td>
                        <td class="p-2 text-xs break-all">${log.url.replace(getGlobalConfig('xpiBaseUrl'), '.../')}</td>
                        <td class="p-2"><button class="styled-btn-secondary !py-1 !px-2 text-xs" data-log-id="${log.id}" data-type="request">View</button></td>
                        <td class="p-2"><button class="styled-btn-secondary !py-1 !px-2 text-xs" data-log-id="${log.id}" data-type="response">View</button></td>
                    `;
                    
                    // Replace placeholder classes
                    tr.querySelectorAll('.styled-btn-secondary').forEach(btn => {
                        btn.className = btn.className.replace('styled-btn-secondary', STYLE_GUIDE['styled-btn-secondary']);
                    });
                    
                    logBody.appendChild(tr);
                });
            }

            // Event delegation for payload buttons
            logBody.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.logId) {
                    const logId = e.target.dataset.logId;
                    const type = e.target.dataset.type;
                    const logs = JSON.parse(localStorage.getItem('apiLogs') || '[]');
                    const log = logs.find(l => l.id === logId);
                    
                    if (log) {
                        showPayloadModal(`${type.charAt(0).toUpperCase() + type.slice(1)} Payload`, log[type]);
                    }
                }
            });
        }

        // ---------------------------------------------------------------------
        // D. NAVIGATION & ROUTING
        // ---------------------------------------------------------------------
        
        /**
         * Initializes sidebar, nav links, and user profile.
         */
        function initNavigation() {
            const sidebar = document.getElementById('app-sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const linksContainer = document.getElementById('nav-links-container');
            const logoutLink = document.getElementById('logout-link');

            // Toggle sidebar
            toggleBtn.addEventListener('click', () => {
                const isVisible = sidebar.dataset.visible === 'true';
                if (isVisible) {
                    sidebar.dataset.visible = 'false';
                    sidebar.classList.add('-translate-x-full');
                    mainContent.classList.remove('md:ml-64');
                } else {
                    sidebar.dataset.visible = 'true';
                    sidebar.classList.remove('-translate-x-full');
                    mainContent.classList.add('md:ml-64');
                }
            });

            // Populate nav links
            linksContainer.innerHTML = '';
            MODULE_CONFIG
                .filter(mod => mod.type === 'User-defined')
                .forEach(mod => {
                    const a = document.createElement('a');
                    a.href = `#${mod.code}`;
                    a.className = 'block py-2.5 px-4 rounded text-gray-400 hover:bg-gray-700 hover:text-white transition duration-200';
                    a.textContent = mod.name;
                    linksContainer.appendChild(a);
                });
            
            // Logout
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                location.href = location.origin + location.pathname; // Redirect to base
            });
        }
        
        /**
         * Updates UI elements based on login state (token, user info).
         */
        function updateLoginStateUI() {
            const token = sessionStorage.getItem('token');
            const sidebar = document.getElementById('app-sidebar');
            const mainContent = document.getElementById('main-content');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const logoutLink = document.getElementById('logout-link');

            if (token) {
                // Logged In
                const firstName = sessionStorage.getItem('firstName');
                const lastName = sessionStorage.getItem('lastName');
                const avatarUrl = sessionStorage.getItem('avatarUrl');

                userName.textContent = `${firstName || 'User'} ${lastName || ''}`;
                userAvatar.src = avatarUrl || 'https://placehold.co/40x40/555/FFF?text=?';
                logoutLink.classList.remove('hidden');

                sidebar.classList.remove('hidden', '-translate-x-full');
                sidebar.dataset.visible = 'true';
                mainContent.classList.add('md:ml-64'); // Adjust main content for sidebar
                
            } else {
                // Logged Out
                userName.textContent = 'Not Logged In';
                userAvatar.src = 'https://placehold.co/40x40/555/FFF?text=?';
                logoutLink.classList.add('hidden');
                
                sidebar.classList.add('hidden', '-translate-x-full');
                sidebar.dataset.visible = 'false';
                mainContent.classList.remove('md:ml-64');
            }
        }
        
        /**
         * Main application router.
         * Decides which module to show based on URL and login state.
         */
        function mainRouter() {
            updateLoginStateUI(); // Update nav/profile on every route change
            
            const hash = location.hash;
            const params = new URLSearchParams(location.search);
            const token = sessionStorage.getItem('token');
            
            if (hash === '#admin') {
                showModule('admin');
            } else if (params.has('code')) {
                showModule('loading');
                handleLoginCallback(params.get('code'));
            } else if (token) {
                // Logged in
                const moduleCode = hash.substring(1);
                if (MODULE_CONFIG.some(m => m.code === moduleCode && m.type === 'User-defined')) {
                    showModule(moduleCode);
                    const moduleEl = document.querySelector(`#module-${moduleCode}`);

                    // Check if it's an MDM module that needs lazy init
                    if (moduleCode.startsWith('MAS.') && moduleEl && !moduleEl.dataset.initialized) {
                        initMdmModule(MDM_CONFIG[moduleCode]);
                    }
                    
                    // Check if it's the Campaign module that needs lazy init
                    if (moduleCode === 'MOD.C' && moduleEl && !moduleEl.dataset.initialized) {
                        initCampaignModule();
                        moduleEl.dataset.initialized = true; // Mark as initialized
                    }
                } else {
                    // Default to Campaign Submission
                    location.hash = 'MOD.C';
                }
            } else {
                // Not logged in
                showModule('login');
                initLoginAuthMode();
            }
        }

        // ---------------------------------------------------------------------
        // E. MODULE: LOGIN (MOD.B)
        // ---------------------------------------------------------------------
        
        /**
         * Wires up the "Login" button for OAuth redirect.
         */
        function initLoginAuthMode() {
            const loginBtn = document.getElementById('login-auth-btn');
            if (loginBtn.dataset.wired) return; // Prevent re-wiring
            
            loginBtn.addEventListener('click', async () => {
                try {
                    const timestamp = Date.now().toString();
                    const random = Math.random().toString();
                    const hash = await sha256(timestamp + random);
                    const clientId = hash.slice(-7);
                    
                    sessionStorage.setItem('clientId', clientId);
                    
                    const redirectUri = location.origin + location.pathname;
                    const xpiBaseUrl = getGlobalConfig('xpiBaseUrl');
                    const authUrl = `${xpiBaseUrl}?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${clientId}`;
                    
                    location.href = authUrl;
                } catch (error) {
                    console.error("Failed to generate clientId:", error);
                    showToast("Failed to initiate login. Please try again.", "error");
                }
            });
            loginBtn.dataset.wired = true;
        }

        /**
         * Handles the OAuth callback.
         * @param {string} code - The 'code' from the URL query parameter.
         */
        async function handleLoginCallback(code) {
            const clientId = sessionStorage.getItem('clientId');
            const errorContainer = document.getElementById('loading-error-container');
            const errorMessage = document.getElementById('loading-error-message');
            const errorDetails = document.getElementById('loading-error-details');
            const startOverBtn = document.getElementById('loading-start-over-btn');

            startOverBtn.onclick = () => location.href = location.origin + location.pathname;

            const showError = (message, details = null) => {
                errorMessage.textContent = message;
                if (details) {
                    errorDetails.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
                    errorDetails.classList.remove('hidden');
                } else {
                    errorDetails.classList.add('hidden');
                }
                errorContainer.classList.remove('hidden');
                document.querySelector('#module-loading .loader').classList.add('hidden');
            };

            // 1. Validation
            if (!code || !clientId) {
                showError('Login failed: Missing code or client ID. Redirecting...');
                setTimeout(() => startOverBtn.click(), 10000);
                return;
            }

            try {
                // 2. Exchange code for token
                const tokenUrl = `/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;
                const tokenResponse = await secureFetch(tokenUrl, { method: 'GET' }, 'none');
                const tokenData = await tokenResponse.json();

                if (!tokenResponse.ok || !tokenData.success) {
                    showError('Login failed: Could not exchange token.', tokenData);
                    return;
                }

                const { token, credentials } = tokenData.data;
                sessionStorage.setItem('token', token);

                // 3. Verify credentials by fetching profile
                const profileUrl = '/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me';
                const profileResponse = await secureFetch(
                    profileUrl, 
                    { method: 'GET' }, 
                    'basic', 
                    credentials.username, 
                    credentials.password 
                    // Credentials are used here and then discarded, not stored.
                );
                const profileData = await profileResponse.json();
                
                if (!profileResponse.ok || !profileData.success || !profileData.data[0]) {
                    sessionStorage.removeItem('token'); // Clear invalid token
                    showError('Login failed: We are unable to verify your account. Please try again.', profileData);
                    return;
                }

                // 4. Success! Store user info
                const user = profileData.data[0];
                sessionStorage.setItem('firstName', user.firstName);
                sessionStorage.setItem('lastName', user.lastName);
                sessionStorage.setItem('avatarUrl', user.avatarUrl);
                
                // Show success and redirect
                document.querySelector('#module-loading .loader').classList.add('hidden');
                errorMessage.textContent = `Welcome, ${user.firstName} ${user.lastName}! Login successful.`;
                errorMessage.className = 'styled-text-success';
                errorDetails.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                
                setTimeout(() => {
                    location.href = location.origin + location.pathname; // Redirect to base to trigger mainRouter
                }, 2000);

            } catch (error) {
                console.error("Login Callback Error:", error);
                showError('An unexpected technical error occurred.', error.message);
            }
        }
        
        // ---------------------------------------------------------------------
        // F. MODULE: ADMIN (MOD.A)
        // ---------------------------------------------------------------------
        
        /**
         * Initializes the Admin module form.
         */
        function initAdminModule() {
            const form = document.getElementById('admin-config-form');
            const urlInput = document.getElementById('config-xpiBaseUrl');
            
            // Load current config
            urlInput.value = getGlobalConfig('xpiBaseUrl');
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                setGlobalConfig('xpiBaseUrl', urlInput.value);
                showToast('Configuration saved successfully!', 'success');
            });
        }
        
        // ---------------------------------------------------------------------
        // G. MODULE: CAMPAIGN SUBMISSION (MOD.C)
        // ---------------------------------------------------------------------
        
        /**
         * Initializes the Campaign Submission module.
         */
        function initCampaignModule() {
            const form = document.getElementById('campaign-form');
            const submitBtn = document.getElementById('campaign-submit-btn');
            const resultPre = document.getElementById('campaign-result');
            const tagInput = document.getElementById('campaign-selectedchannels-input');
            const tagContainer = document.getElementById('campaign-selectedchannels-tags');

            let tags = ['Twitter']; // Default value

            // --- Tag Input Logic ---
            function updateTagsUI() {
                tagContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.innerHTML = `${tag} <span class="tag-close" data-tag="${tag}">&times;</span>`;
                    tagContainer.appendChild(tagEl);
                });
            }

            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const tag = e.target.value.trim();
                    if (tag && !tags.includes(tag)) {
                        tags.push(tag);
                        updateTagsUI();
                    }
                    e.target.value = '';
                }
            });

            tagContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-close')) {
                    const tag = e.target.dataset.tag;
                    tags = tags.filter(t => t !== tag);
                    updateTagsUI();
                }
            });
            updateTagsUI(); // Initial render

            // --- Dropdown Loading ---
            async function loadDropdown(endpoint, selectId, valueKey = 'value') {
                const select = document.getElementById(selectId);
                try {
                    const response = await secureFetch(`/api/v1/wrikexpi/v1.0/value/${endpoint}`, { method: 'GET' }, 'bearer');
                    if (!response.ok) throw new Error(`Failed to load ${endpoint}`);
                    
                    const data = await response.json();
                    if (data && data.value) {
                        // Clear existing options (except the default one from HTML)
                        const defaultOption = select.querySelector('option');
                        select.innerHTML = '';
                        if(defaultOption) select.appendChild(defaultOption);

                        data.value.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item[valueKey];
                            option.textContent = item[valueKey];
                            // Prevent duplicates
                            if (option.value !== defaultOption?.value) {
                                select.appendChild(option);
                            }
                        });
                    }
                } catch (error) {
                    console.error(`Error loading dropdown ${selectId}:`, error);
                    showToast(`Failed to load ${endpoint} data`, 'error');
                }
            }

            loadDropdown('clients-grm-mys', 'campaign-client');
            loadDropdown('debtors-grm-mys', 'campaign-debtor');
            loadDropdown('agencies', 'campaign-agency');

            // --- Form Submission ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                resultPre.classList.add('hidden');
                resultPre.className = 'styled-pre max-w-4xl mx-auto mt-6 hidden'; // Reset styles
                
                const formData = new FormData(form);
                const payload = {
                    fields: {}
                };

                formData.forEach((value, key) => {
                    if (['type', 'space', 'entity', 'varientId'].includes(key)) {
                        payload[key] = key === 'varientId' ? parseInt(value) : value;
                    } else {
                        payload.fields[key] = value;
                    }
                });
                
                // Add tags
                payload.fields.selectedchannels = tags;
                
                try {
                    const response = await secureFetch('/api/v1/wrikexpi/campaign', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    }, 'bearer');
                    
                    const responseData = await response.json();
                    
                    resultPre.textContent = JSON.stringify(responseData, null, 2);
                    if (response.ok) {
                        resultPre.classList.add(STYLE_GUIDE['styled-text-success'].split(' ').join(' '));
                    } else {
                        resultPre.classList.add(STYLE_GUIDE['styled-text-error'].split(' ').join(' '));
                    }

                } catch (error) {
                    resultPre.textContent = `Network Error: ${error.message}`;
                    resultPre.classList.add(STYLE_GUIDE['styled-text-error'].split(' ').join(' '));
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Campaign';
                    resultPre.classList.remove('hidden');
                }
            });
        }
        
        // ---------------------------------------------------------------------
        // H. MODULE: MASTER DATA MANAGEMENT (MDM) FACTORY
        // ---------------------------------------------------------------------

        /**
         * Factory function to initialize an MDM module.
         * @param {object} config - The configuration object from MDM_CONFIG.
         */
        function initMdmModule(config) {
            const container = document.getElementById(`module-${config.moduleId}`);
            if (container.dataset.initialized) return; // Already initialized

            // 1. Clone template
            const template = document.getElementById('mdm-template').firstElementChild.cloneNode(true);
            container.innerHTML = ''; // Clear
            container.appendChild(template);
            
            // 2. Get elements from the *cloned* template
            const titleEl = template.querySelector('.mdm-title');
            const loadBtn = template.querySelector('.mdm-load-btn');
            const createBtn = template.querySelector('.mdm-create-btn');
            const tableHead = template.querySelector('.mdm-thead');
            const tableBody = template.querySelector('.mdm-tbody');
            const loader = template.querySelector('.mdm-loader');
            
            // 3. Get Modal elements (these are global)
            const modal = document.getElementById('mdm-modal');
            const modalTitle = document.getElementById('mdm-modal-title');
            const modalForm = document.getElementById('mdm-modal-form');
            const modalFormFields = document.getElementById('mdm-form-fields');
            const modalSaveBtn = document.getElementById('mdm-form-save-btn');
            const modalCloseBtn = document.getElementById('mdm-modal-close-btn');
            const hiddenIdInput = document.getElementById('mdm-form-id');
            
            const deleteModal = document.getElementById('mdm-delete-modal');
            const deleteMessage = document.getElementById('mdm-delete-message');
            const deleteConfirmBtn = document.getElementById('mdm-delete-confirm-btn');
            const deleteCancelBtn = document.getElementById('mdm-delete-cancel-btn');

            // 4. Configure UI
            titleEl.textContent = config.title;

            // Create table header
            const trHead = document.createElement('tr');
            config.fields.forEach(fieldKey => {
                const th = document.createElement('th');
                th.className = 'p-3 font-semibold text-left'; // Apply style
                th.textContent = config.fieldLabels[fieldKey] || fieldKey;
                trHead.appendChild(th);
            });
            const thActions = document.createElement('th');
            thActions.className = 'p-3 font-semibold text-right';
            thActions.textContent = 'Actions';
            trHead.appendChild(thActions);
            tableHead.innerHTML = ''; // Clear
            tableHead.appendChild(trHead);

            // --- Helper Functions (bound to this module) ---

            const showMdmModal = (visible) => {
                if (visible) {
                    mdmState.activeModuleId = config.moduleId; // Track active modal
                    modal.classList.remove('hidden');
                } else {
                    if (mdmState.activeModuleId === config.moduleId) {
                        modal.classList.add('hidden');
                        mdmState.activeModuleId = null;
                        mdmState.activeRecord = null;
                    }
                }
            };
            
            const showDeleteModal = (visible) => {
                if (visible) {
                    mdmState.activeModuleId = config.moduleId;
                    deleteModal.classList.remove('hidden');
                } else {
                    if (mdmState.activeModuleId === config.moduleId) {
                        deleteModal.classList.add('hidden');
                        mdmState.activeModuleId = null;
                        mdmState.activeRecord = null;
                    }
                }
            };

            const populateForm = (record = {}) => {
                modalFormFields.innerHTML = '';
                hiddenIdInput.value = record.id || '';
                
                config.fields.forEach(fieldKey => {
                    // Don't create an input for 'id' if it's readOnly
                    if (fieldKey === 'id' && config.readOnlyFields.includes('id')) {
                        return;
                    }
                    
                    const div = document.createElement('div');
                    const label = document.createElement('label');
                    label.className = STYLE_GUIDE['styled-label'];
                    label.textContent = config.fieldLabels[fieldKey] || fieldKey;
                    label.htmlFor = `mdm-form-${fieldKey}`;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `mdm-form-${fieldKey}`;
                    input.name = fieldKey;
                    input.className = STYLE_GUIDE['styled-input'] + ' w-full';
                    input.value = record[fieldKey] || '';
                    
                    if (config.readOnlyFields.includes(fieldKey)) {
                        input.readOnly = true;
                        input.classList.add('opacity-70', 'bg-gray-600');
                    }
                    if (config.requiredFields.includes(fieldKey)) {
                        input.required = true;
                    }

                    div.appendChild(label);
                    div.appendChild(input);
                    modalFormFields.appendChild(div);
                });
            };

            const loadData = async () => {
                loader.classList.remove('hidden');
                tableBody.innerHTML = '';
                try {
                    const url = `/api/v1/wrikexpi/v1.0/record/${config.slug}`;
                    const response = await secureFetch(url, { method: 'GET' }, 'bearer');
                    if (!response.ok) throw new Error('Failed to fetch data');
                    
                    const data = await response.json();
                    
                    if (!data.value || data.value.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="${config.fields.length + 1}" class="text-center p-4">No records found.</td></tr>`;
                        return;
                    }
                    
                    data.value.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-700 hover:bg-gray-700';
                        
                        // Add data cells
                        config.fields.forEach(fieldKey => {
                            const td = document.createElement('td');
                            td.className = 'p-3';
                            td.textContent = record[fieldKey] || 'N/A';
                            tr.appendChild(td);
                        });
                        
                        // Add actions cell
                        const tdActions = document.createElement('td');
                        tdActions.className = 'p-3 text-right space-x-2';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'styled-icon-btn !p-1';
                        editBtn.innerHTML = ICONS['edit'];
                        editBtn.title = 'Edit';
                        editBtn.dataset.record = JSON.stringify(record);
                        editBtn.dataset.action = 'edit';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'styled-icon-btn !p-1 !text-red-400 hover:!text-red-300';
                        deleteBtn.innerHTML = ICONS['delete'];
                        deleteBtn.title = 'Delete';
                        deleteBtn.dataset.record = JSON.stringify(record);
                        deleteBtn.dataset.action = 'delete';

                        // Apply styles
                        editBtn.className = editBtn.className.replace('styled-icon-btn', STYLE_GUIDE['styled-icon-btn']);
                        deleteBtn.className = deleteBtn.className.replace('styled-icon-btn', STYLE_GUIDE['styled-icon-btn']);
                        
                        tdActions.appendChild(editBtn);
                        tdActions.appendChild(deleteBtn);
                        tr.appendChild(tdActions);
                        
                        tableBody.appendChild(tr);
                    });

                } catch (error) {
                    console.error('MDM Load Error:', error);
                    showToast(`Error loading ${config.title}: ${error.message}`, 'error');
                    tableBody.innerHTML = `<tr><td colspan="${config.fields.length + 1}" class="text-center p-4 text-red-400">Failed to load data.</td></tr>`;
                } finally {
                    loader.classList.add('hidden');
                }
            };

            // --- Event Listeners (Module specific) ---
            
            loadBtn.addEventListener('click', loadData);
            
            createBtn.addEventListener('click', () => {
                mdmState.isEditMode = false;
                mdmState.activeRecord = null;
                modalTitle.textContent = `Create New ${config.title}`;
                populateForm();
                showMdmModal(true);
            });

            // Use event delegation for table actions
            tableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || !btn.dataset.action) return;
                
                const record = JSON.parse(btn.dataset.record);
                mdmState.activeRecord = record; // Set state
                
                if (btn.dataset.action === 'edit') {
                    mdmState.isEditMode = true;
                    modalTitle.textContent = `Edit ${config.title} (ID: ${record.id})`;
                    populateForm(record);
                    showMdmModal(true);
                } else if (btn.dataset.action === 'delete') {
                    deleteMessage.textContent = `Are you sure you want to delete "${record.value || record.id}"?`;
                    showDeleteModal(true);
                }
            });
            
            // --- Event Listeners (Global Modals) ---
            // These are wired once per module, but check activeModuleId
            
            modalCloseBtn.addEventListener('click', () => showMdmModal(false));
            deleteCancelBtn.addEventListener('click', () => showDeleteModal(false));

            modalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (mdmState.activeModuleId !== config.moduleId) return; // Only act if this module is active

                modalSaveBtn.disabled = true;
                
                const formData = new FormData(modalForm);
                const payload = {
                    '@odata.context': `${getGlobalConfig('xpiBaseUrl')}/api/v1/wrikexpi/v1.0/${config.slug}`
                };
                
                formData.forEach((value, key) => {
                    payload[key] = value;
                });

                let url = `/api/v1/wrikexpi/v1.0/record/${config.slug}`;
                let method = 'POST';

                if (mdmState.isEditMode) {
                    method = 'PATCH';
                    payload.id = mdmState.activeRecord.id;
                }

                try {
                    const response = await secureFetch(url, {
                        method: method,
                        body: JSON.stringify(payload)
                    }, 'bearer');
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || `Failed to ${method}`);
                    }
                    
                    showToast(`Record ${mdmState.isEditMode ? 'updated' : 'created'} successfully!`, 'success');
                    showMdmModal(false);
                    loadData(); // Refresh list

                } catch (error) {
                    console.error('MDM Save Error:', error);
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    modalSaveBtn.disabled = false;
                }
            });

            deleteConfirmBtn.addEventListener('click', async () => {
                if (mdmState.activeModuleId !== config.moduleId) return;
                
                deleteConfirmBtn.disabled = true;
                const record = mdmState.activeRecord;
                
                try {
                    const url = `/api/v1/wrikexpi/v1.0/record/${config.slug}/${record.id}`;
                    const response = await secureFetch(url, { method: 'DELETE' }, 'bearer');
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || 'Failed to delete record');
                    }
                    
                    showToast('Record deleted successfully!', 'success');
                    showDeleteModal(false);
                    loadData(); // Refresh list

                } catch (error) {
                    console.error('MDM Delete Error:', error);
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    deleteConfirmBtn.disabled = false;
                }
            });

            container.dataset.initialized = true;
        }


        // ---------------------------------------------------------------------
        // I. APPLICATION INITIALIZATION
        // ---------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Apply dynamic styles FIRST
            initTailwindPlaceholders();
            
            // 2. Inject all SVGs
            initSvgIcons();
            
            // 3. Setup core systems
            initGlobalConfig();
            initNavigation();
            initDevTool();
            
            // 4. Init static modules
            initAdminModule();
            // initCampaignModule(); // <-- REMOVED FROM HERE
            // Note: Login module is initialized by the router
            // Note: MDM & Campaign modules are initialized lazily by the router
            
            // 5. Start the router
            mainRouter();
            window.addEventListener('hashchange', mainRouter);
        });

    </script>
</body>
</html>


