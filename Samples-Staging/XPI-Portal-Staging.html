<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPI Portal</title>
    <!-- 1. Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Inter Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. SHA-256 Library for Login -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

    <!-- Configuration for Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class', // This app is dark mode by default
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <!-- Internal Styles -->
    <style>
        /* 3. Set Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* Spinner Animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tag input styles */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
        }
        .tag-item {
            display: inline-flex;
            align-items: center;
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.875rem;
        }
        .tag-item span {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<!-- 4. Dark mode UI theme -->
<body class="h-full bg-gray-900 text-gray-200 dark antialiased">

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="flex h-full relative overflow-hidden">

        <!-- ===== Navigation Bar (Left) ===== -->
        <nav id="app-nav" class="bg-gray-800 w-64 h-full flex-col p-4 shadow-lg absolute md:relative z-20 -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex-1">
                <!-- Nav Header -->
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-xl font-bold text-white">XPI Portal</h1>
                    <!-- Nav Toggle Button -->
                    <button id="nav-toggle-btn" class="p-1 rounded-md text-gray-400 hover:text-white hover:bg-gray-700">
                        <!-- Menu Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                </div>
                
                <!-- Nav Links (User-defined modules) -->
                <ul id="nav-links" class="space-y-2">
                    <!-- Links will be populated by JS -->
                </ul>
            </div>

            <!-- User Profile Display (Bottom Left) -->
            <div id="user-profile" class="mt-auto pt-4 border-t border-gray-700">
                <div class="flex items-center gap-3">
                    <img id="user-avatar" src="https://placehold.co/40x40/60a5fa/ffffff?text=U" alt="User Avatar" class="w-10 h-10 rounded-full bg-blue-500">
                    <div>
                        <p id="user-name" class="font-medium text-sm text-white">Not Logged In</p>
                        <a id="logout-link" href="#" class="text-xs text-blue-400 hover:text-blue-300">Logout</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ===== Main Content Area ===== -->
        <main id="main-content" class="flex-1 h-full overflow-auto p-6 md:p-10">
            <!-- Global Spinner (hidden by default) -->
            <div id="global-spinner-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
                <div class="spinner"></div>
            </div>

            <!-- Module Containers -->
            
            <!-- A. Admin Module -->
            <section id="module-admin" class="app-module hidden max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-white">Admin Configuration</h2>
                <form id="admin-form" class="bg-gray-800 p-8 rounded-lg shadow-xl space-y-6">
                    <div>
                        <label for="admin-xpiBaseUrl" class="block text-sm font-medium text-gray-300 mb-2">XPI Base URL</label>
                        <input type="url" id="admin-xpiBaseUrl" name="xpiBaseUrl" class="w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="https://api.wrikexpi.groupm.com">
                    </div>
                    <div class="text-right">
                        <button type="submit" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                            Save Configuration
                        </button>
                    </div>
                </form>
            </section>

            <!-- B. Login Module -->
            <section id="module-login" class="app-module hidden max-w-lg mx-auto mt-20">
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                    <!-- Mode 1: Authentication -->
                    <div id="login-auth-mode">
                        <h2 class="text-2xl font-bold mb-6 text-white">Welcome to XPI Portal</h2>
                        <button id="login-auth-btn" class="w-full py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                            Login & Authenticate with Wrike
                        </button>
                    </div>
                    <!-- Mode 2: OAuth Callback -->
                    <div id="login-callback-mode" class="hidden">
                        <h2 class="text-2xl font-bold mb-4 text-white">Authenticating...</h2>
                        <div class="flex justify-center mb-4">
                            <div class="spinner"></div>
                        </div>
                        <p class="text-gray-400">Please wait while we verify your credentials.</p>
                        
                        <!-- Error/Result Display -->
                        <div id="login-result-display" class="hidden mt-6 text-left">
                            <p id="login-result-message" class="p-4 rounded-lg"></p>
                            <pre id="login-result-json" class="mt-4 p-4 bg-gray-900 text-red-300 rounded-lg text-xs overflow-auto"></pre>
                            <button id="login-start-over-btn" class="mt-4 w-full py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-gray-600 hover:bg-gray-700">
                                Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- C. Campaign Submission Module -->
            <section id="module-campaign-submission" class="app-module hidden max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-white">Campaign Submission</h2>
                <form id="campaign-form" class="bg-gray-800 p-8 rounded-lg shadow-xl">
                    <!-- Hidden Fields -->
                    <input type="hidden" name="type" value="Campaign Request">
                    <input type="hidden" name="space" value="GRM-MYS-GMN">
                    <input type="hidden" name="entity" value="Campaign">
                    <input type="hidden" name="varientId" value="1">

                    <!-- Form Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                        <!-- Dynamically populated dropdowns -->
                        <div>
                            <label for="campaign-client" class="block text-sm font-medium text-gray-300 mb-2">Client</label>
                            <select id="campaign-client" name="client" class="styled-select"></select>
                        </div>
                        <div>
                            <label for="campaign-debtor" class="block text-sm font-medium text-gray-300 mb-2">Debtor</label>
                            <select id="campaign-debtor" name="debtor" class="styled-select"></select>
                        </div>
                        <div>
                            <label for="campaign-agency" class="block text-sm font-medium text-gray-300 mb-2">Agency</label>
                            <select id="campaign-agency" name="agency" class="styled-select"></select>
                        </div>

                        <!-- Other fields from 'fields' object -->
                        <div>
                            <label for="campaign-campaignname" class="block text-sm font-medium text-gray-300 mb-2">Campaign Name</label>
                            <input type="text" id="campaign-campaignname" name="campaignname" class="styled-input" value="World Pinball Day 7000">
                        </div>
                        <div>
                            <label for="campaign-requestedstartdate" class="block text-sm font-medium text-gray-300 mb-2">Requested Start Date</label>
                            <input type="date" id="campaign-requestedstartdate" name="requestedstartdate" class="styled-input" value="2026-07-01">
                        </div>
                        <div>
                            <label for="campaign-campaignstartdate" class="block text-sm font-medium text-gray-300 mb-2">Campaign Start Date</label>
                            <input type="date" id="campaign-campaignstartdate" name="campaignstartdate" class="styled-input" value="2026-08-29">
                        </div>
                        <div>
                            <label for="campaign-campaignenddate" class="block text-sm font-medium text-gray-300 mb-2">Campaign End Date</label>
                            <input type="date" id="campaign-campaignenddate" name="campaignenddate" class="styled-input" value="2026-10-29">
                        </div>
                        
                        <div>
                            <label for="campaign-brand" class="block text-sm font-medium text-gray-300 mb-2">Brand</label>
                            <input type="text" id="campaign-brand" name="brand" class="styled-input" value="World Pinball">
                        </div>
                        <div>
                            <label for="campaign-currency" class="block text-sm font-medium text-gray-300 mb-2">Currency</label>
                            <input type="text" id="campaign-currency" name="currency" class="styled-input" value="SGD">
                        </div>
                        <div>
                            <label for="campaign-pod" class="block text-sm font-medium text-gray-300 mb-2">Pod</label>
                            <input type="text" id="campaign-pod" name="pod" class="styled-input" value="Pod 1A">
                        </div>
                        <div>
                            <label for="campaign-campaignobjective" class="block text-sm font-medium text-gray-300 mb-2">Campaign Objective</label>
                            <input type="text" id="campaign-campaignobjective" name="campaignobjective" class="styled-input" value="Upper Funnel / Awareness">
                        </div>
                        <div>
                            <label for="campaign-requestormarket" class="block text-sm font-medium text-gray-300 mb-2">Requestor Market</label>
                            <input type="text" id="campaign-requestormarket" name="requestormarket" class="styled-input" value="Singapore">
                        </div>
                        <div>
                            <label for="campaign-optin" class="block text-sm font-medium text-gray-300 mb-2">Opt-in</label>
                            <select id="campaign-optin" name="optin" class="styled-select">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="campaign-porequired" class="block text-sm font-medium text-gray-300 mb-2">PO Required</label>
                            <select id="campaign-porequired" name="porequired" class="styled-select">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label for="campaign-overallbudget" class="block text-sm font-medium text-gray-300 mb-2">Overall Budget</label>
                            <input type="number" id="campaign-overallbudget" name="overallbudget" class="styled-input" value="100">
                        </div>
                        
                        <!-- Tagging Interface -->
                        <div class="md:col-span-2">
                            <label for="campaign-channels-input" class="block text-sm font-medium text-gray-300 mb-2">Selected Channels (type and press Enter)</label>
                            <input type="text" id="campaign-channels-input" class="styled-input mb-2" placeholder="e.g., Twitter, Facebook...">
                            <div id="campaign-channels-container" class="tag-container min-h-[48px]">
                                <!-- Tags will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="mt-8 text-right">
                        <button type="submit" id="campaign-submit-btn" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                            Submit Campaign
                        </button>
                    </div>
                </form>

                <!-- Result Display -->
                <div id="campaign-result-wrapper" class="mt-6 hidden">
                    <h3 class="text-xl font-semibold mb-2">Submission Result</h3>
                    <pre id="campaign-result-pre" class="p-4 bg-gray-800 rounded-lg text-xs overflow-auto max-h-96"></pre>
                </div>
            </section>
            
            <!-- D. Master Data: Demo Client (MAS.DemoCient) -->
            <section id="module-mas-democient" class="app-module hidden max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Master Data: Demo Clients</h2>
                    <div class="space-x-4">
                        <button class="md-load-btn styled-btn-secondary">Load Data</button>
                        <button class="md-create-btn styled-btn-primary">Create New</button>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <!-- Fields: id, value, note, fincode, code -->
                                <th class="md-table-header">ID</th>
                                <th class="md-table-header">Value</th>
                                <th class="md-table-header">Note</th>
                                <th class="md-table-header">FinCode</th>
                                <th class="md-table-header">Code</th>
                                <th class="md-table-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="md-table-body divide-y divide-gray-700">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- E. Master Data: XPI Field Mapping (MAS.XPICFMapping) -->
            <section id="module-mas-xpicfmapping" class="app-module hidden max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Master Data: XPI Field Mapping</h2>
                    <div class="space-x-4">
                        <button class="md-load-btn styled-btn-secondary">Load Data</button>
                        <button class="md-create-btn styled-btn-primary">Create New</button>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <!-- Fields: id, value, CF Name -->
                                <th class="md-table-header">ID</th>
                                <th class="md-table-header">Value</th>
                                <th class="md-table-header">CF Name</th>
                                <th class="md-table-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="md-table-body divide-y divide-gray-700">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

        </main>

        <!-- ===== Developer Tool (Bottom Right) ===== -->
        <button id="dev-tool-toggle" class="fixed bottom-6 right-6 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none z-30">
            <!-- "Hat" Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
            </svg>
        </button>

    </div> <!-- End #app-wrapper -->


    <!-- ===== Modals ===== -->

    <!-- Generic Modal (for Dev Tool Payloads, etc.) -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="generic-modal-title" class="text-xl font-semibold text-white">Modal Title</h3>
                <button id="generic-modal-close" class="p-1 rounded-full text-gray-400 hover:text-white hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Modal Content -->
            <div id="generic-modal-content" class="p-6 overflow-auto">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Developer Tool Log List Modal -->
    <div id="dev-tool-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <!-- 80% screen size -->
        <div class="bg-gray-800 rounded-lg shadow-xl w-[80vw] h-[80vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">API Call Log</h3>
                <div class="flex items-center gap-4">
                    <button id="dev-tool-clear-logs" class="p-2 rounded-md text-gray-400 hover:text-white hover:bg-red-700">
                        <!-- Rubbish bin icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.576 0c-.342.052-.682.107-1.022.166m11.554 0A48.254 48.254 0 0 1 12 5.11a48.254 48.254 0 0 1-3.478-.397m7.056 0a48.27 48.27 0 0 0-3.582-0.13M12 5.11V4.75" />
                        </svg>
                    </button>
                    <button id="dev-tool-close" class="p-1 rounded-full text-gray-400 hover:text-white hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Modal Content (Scrollable Table) -->
            <div class="flex-1 p-6 overflow-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="md-table-header">Timestamp</th>
                            <th class="md-table-header">Status</th>
                            <th class="md-table-header">Method</th>
                            <th class="md-table-header">URL</th>
                            <th class="md-table-header">Request</th>
                            <th class="md-table-header">Response</th>
                        </tr>
                    </thead>
                    <tbody id="dev-tool-log-body" class="divide-y divide-gray-700">
                        <!-- Logs populated by JS -->
                    </tbody>
                </table>
            </div>
            <!-- Note: Pagination not implemented for simplicity, focusing on core spec -->
        </div>
    </div>
    
    <!-- Master Data Create/Edit Modal -->
    <div id="md-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <form id="md-modal-form" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="md-modal-title" class="text-xl font-semibold text-white">Modal Title</h3>
                <button type="button" id="md-modal-close" class="p-1 rounded-full text-gray-400 hover:text-white hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Modal Content -->
            <div id="md-modal-body" class="p-6 overflow-auto space-y-4">
                <!-- Form fields injected by JS -->
            </div>
            <!-- Modal Footer -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-end items-center gap-4">
                <p id="md-modal-error" class="text-sm text-red-400 mr-auto"></p>
                <button type="button" id="md-modal-cancel" class="styled-btn-secondary">Cancel</button>
                <button type="submit" id="md-modal-save" class="styled-btn-primary">Save</button>
            </div>
        </form>
    </div>

    <!-- Master Data Delete Confirmation Modal -->
    <div id="md-delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-medium text-white">Confirm Deletion</h3>
                <p class="mt-2 text-sm text-gray-400">Are you sure you want to delete this record? This action cannot be undone.</p>
                <p id="md-delete-error" class="text-sm text-red-400 mt-2"></p>
            </div>
            <div class="p-4 bg-gray-700 flex justify-end gap-4 rounded-b-lg">
                <button type="button" id="md-delete-cancel" class="styled-btn-secondary">Cancel</button>
                <button type="button" id="md-delete-confirm" class="styled-btn-danger">Delete</button>
            </div>
        </div>
    </div>


    <!-- ===== Toast Notification Container ===== -->
    <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4">
        <!-- Toasts will be appended here -->
    </div>


    <!-- ============================================= -->
    <!-- ============== JAVASCRIPT =================== -->
    <!-- ============================================= -->
    <script type="module">
        // Helper to apply common form element styles
        function applyFormStyles() {
            const inputs = `
                w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg 
                focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none 
                disabled:opacity-50 disabled:cursor-not-allowed
            `;
            const selects = `${inputs} appearance-none`;
            const buttonsPrimary = `
                inline-flex justify-center py-3 px-6 border border-transparent shadow-sm 
                text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 
                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800
                disabled:opacity-50 disabled:cursor-not-allowed
            `;
            const buttonsSecondary = `
                inline-flex justify-center py-3 px-6 border border-gray-600 shadow-sm 
                text-sm font-medium rounded-lg text-gray-200 bg-gray-700 hover:bg-gray-600 
                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-800
                disabled:opacity-50 disabled:cursor-not-allowed
            `;
            const buttonsDanger = buttonsPrimary.replace(/blue/g, 'red').replace('bg-red-800', 'bg-red-700');
            const tableHeaders = `
                px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider
            `;

            document.querySelectorAll('.styled-input').forEach(el => el.className = inputs);
            document.querySelectorAll('.styled-select').forEach(el => el.className = selects);
            document.querySelectorAll('.styled-btn-primary').forEach(el => el.className = buttonsPrimary);
            document.querySelectorAll('.styled-btn-secondary').forEach(el => el.className = buttonsSecondary);
            document.querySelectorAll('.styled-btn-danger').forEach(el => el.className = buttonsDanger);
            document.querySelectorAll('.md-table-header').forEach(el => el.className = tableHeaders);
        }
        applyFormStyles();


        /**
         * --------------------------------------
         * App State and Configuration
         * --------------------------------------
         */
        
        // Module Configuration Table
        const modules = [
            { id: 'module-admin', code: 'MOD.A', name: 'Admin', type: 'Built-in', hash: '#admin' },
            { id: 'module-login', code: 'MOD.B', name: 'Login', type: 'Built-in', hash: '#login' },
            { id: 'module-campaign-submission', code: 'MOD.C', name: 'Campaign Submission', type: 'User-defined', hash: '#campaign-submission' },
            { id: 'module-mas-democient', code: 'MAS.DemoCient', name: 'Demo Client', type: 'User-defined', hash: '#mas-democient' },
            { id: 'module-mas-xpicfmapping', code: 'MAS.XPICFMapping', name: 'XPI Field Mapping', type: 'User-defined', hash: '#mas-xpicfmapping' },
        ];
        
        const userDefinedModules = modules.filter(m => m.type === 'User-defined');

        const state = {
            currentModule: null,
            isLoggedIn: false,
            apiLogs: [],
            globalConfig: {
                xpiBaseUrl: 'https://api.wrikexpi.groupm.com'
            },
            masterDataCache: {}, // To store module-specific data
        };

        // DOM Element Cache
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const dom = {
            appWrapper: $('#app-wrapper'),
            appNav: $('#app-nav'),
            navToggleBtn: $('#nav-toggle-btn'),
            navLinks: $('#nav-links'),
            userProfile: $('#user-profile'),
            userAvatar: $('#user-avatar'),
            userName: $('#user-name'),
            logoutLink: $('#logout-link'),
            mainContent: $('#main-content'),
            globalSpinner: $('#global-spinner-overlay'),
            toastContainer: $('#toast-container'),
            devToolToggle: $('#dev-tool-toggle'),
            devToolModal: $('#dev-tool-modal'),
            devToolClose: $('#dev-tool-close'),
            devToolClearLogs: $('#dev-tool-clear-logs'),
            devToolLogBody: $('#dev-tool-log-body'),
            genericModal: $('#generic-modal'),
            genericModalTitle: $('#generic-modal-title'),
            genericModalContent: $('#generic-modal-content'),
            genericModalClose: $('#generic-modal-close'),
        };

        /**
         * --------------------------------------
         * Utility Functions
         * --------------------------------------
         */

        function showSpinner() { dom.globalSpinner.classList.remove('hidden'); }
        function hideSpinner() { dom.globalSpinner.classList.add('hidden'); }

        function showToast(message, type = 'success') {
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            const toast = document.createElement('div');
            toast.className = `p-4 ${bgColor} text-white rounded-lg shadow-lg mb-2 opacity-0 transform translate-y-2 transition-all duration-300 ease-out`;
            toast.textContent = message;
            
            dom.toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);
            
            // Animate out
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function openGenericModal(title, content) {
            dom.genericModalTitle.textContent = title;
            dom.genericModalContent.innerHTML = content;
            dom.genericModal.classList.remove('hidden');
        }
        
        function closeGenericModal() {
            dom.genericModal.classList.add('hidden');
        }

        /**
         * --------------------------------------
         * Config & Log Management (localStorage)
         * --------------------------------------
         */

        function loadGlobalConfig() {
            const storedConfig = localStorage.getItem('xpiGlobalConfig');
            if (storedConfig) {
                state.globalConfig = JSON.parse(storedConfig);
            } else {
                localStorage.setItem('xpiGlobalConfig', JSON.stringify(state.globalConfig));
            }
        }
        
        function setGlobalConfig(key, value) {
            state.globalConfig[key] = value;
            localStorage.setItem('xpiGlobalConfig', JSON.stringify(state.globalConfig));
        }
        
        function getGlobalConfig(key) {
            return state.globalConfig[key] || '';
        }
        
        function loadApiLogs() {
            const logs = localStorage.getItem('xpiApiLogs');
            state.apiLogs = logs ? JSON.parse(logs) : [];
        }
        
        function addApiLog(logEntry) {
            // Security Requirement: Scrub Authorization header
            if (logEntry.request.headers && logEntry.request.headers['Authorization']) {
                logEntry.request.headers['Authorization'] = 'Bearer [REDACTED]';
            }
            state.apiLogs.unshift(logEntry); // Add to beginning
            localStorage.setItem('xpiApiLogs', JSON.stringify(state.apiLogs));
        }
        
        function clearApiLogs() {
            state.apiLogs = [];
            localStorage.setItem('xpiApiLogs', JSON.stringify(state.apiLogs));
            renderApiLogs();
        }

        /**
         * --------------------------------------
         * Core App UI & Routing
         * --------------------------------------
         */

        function updateUI() {
            state.isLoggedIn = !!sessionStorage.getItem('xpiToken');
            
            if (state.isLoggedIn) {
                dom.userProfile.classList.remove('hidden');
                dom.devToolToggle.classList.remove('hidden');
                dom.appNav.classList.remove('hidden'); // Show nav container
                
                dom.userName.textContent = `${sessionStorage.getItem('xpiFirstName')} ${sessionStorage.getItem('xpiLastName')}`;
                dom.userAvatar.src = sessionStorage.getItem('xpiAvatarUrl') || `https://placehold.co/40x40/60a5fa/ffffff?text=${sessionStorage.getItem('xpiFirstName')?.charAt(0) || 'U'}`;
                
                // Populate nav links
                dom.navLinks.innerHTML = userDefinedModules.map(m => `
                    <li>
                        <a href="${m.hash}" 
                           class="nav-link block px-4 py-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white"
                           data-module-id="${m.id}">
                            ${m.name}
                        </a>
                    </li>
                `).join('');
            } else {
                dom.userProfile.classList.add('hidden');
                dom.devToolToggle.classList.add('hidden');
                dom.appNav.classList.add('hidden'); // Hide nav container
                dom.appWrapper.classList.remove('nav-open');
                dom.appNav.classList.add('-translate-x-full');
            }
        }

        function showModule(moduleId) {
            if (state.currentModule === moduleId) return;
            
            $$('.app-module').forEach(module => module.classList.add('hidden'));
            const moduleEl = $(`#${moduleId}`);
            
            if (moduleEl) {
                moduleEl.classList.remove('hidden');
                state.currentModule = moduleId;
                
                // Update active nav link
                $$('.nav-link').forEach(link => {
                    link.classList.toggle('bg-gray-700', link.dataset.moduleId === moduleId);
                });

                // Call module-specific init function if it exists
                switch(moduleId) {
                    case 'module-admin':
                        initAdminModule();
                        break;
                    case 'module-login':
                        initLoginModule();
                        break;
                    case 'module-campaign-submission':
                        initCampaignModule();
                        break;
                    case 'module-mas-democient':
                        initMasterDataModule('mas-democient', 'demoxpiclients', ['id', 'value', 'note', 'fincode', 'code']);
                        break;
                    case 'module-mas-xpicfmapping':
                        initMasterDataModule('mas-xpicfmapping', 'xpicfmapping', ['id', 'value', 'CF Name']);
                        break;
                }
            } else {
                console.error(`Module not found: ${moduleId}`);
                if (state.isLoggedIn) {
                    showModule('module-campaign-submission'); // Fallback
                }
            }
        }

        function handleRouting() {
            const hash = location.hash;
            const params = new URLSearchParams(location.search);
            const code = params.get('code');
            
            updateUI(); // Ensure UI reflects login state first

            if (hash === '#admin') {
                showModule('module-admin');
            } else if (code) {
                showModule('module-login');
            } else if (state.isLoggedIn) {
                const module = modules.find(m => m.hash === hash);
                if (module && module.type === 'User-defined') {
                    showModule(module.id);
                } else {
                    // Default to Campaign Submission if logged in
                    location.hash = '#campaign-submission';
                    showModule('module-campaign-submission');
                }
            } else {
                // Not logged in, no code, not admin -> show login
                showModule('module-login');
            }
        }

        function handleLogout() {
            sessionStorage.clear();
            state.isLoggedIn = false;
            location.hash = '';
            location.search = '';
            handleRouting();
            updateUI();
        }

        function toggleNav() {
            dom.appNav.classList.toggle('-translate-x-full');
            dom.appWrapper.classList.toggle('nav-open');
        }

        /**
         * --------------------------------------
         * Safe Fetch API Wrapper
         * --------------------------------------
         */
        
        async function safeFetch(url, options = {}, isBasicAuth = false) {
            showSpinner();
            const logEntry = {
                timestamp: new Date().toISOString(),
                method: options.method || 'GET',
                url: url,
                request: { headers: { ...options.headers }, body: options.body },
                response: null,
                status: null
            };

            const fullOptions = { ...options };
            fullOptions.headers = { ...options.headers };

            if (!isBasicAuth) {
                const token = sessionStorage.getItem('xpiToken');
                if (token) {
                    fullOptions.headers['Authorization'] = `Bearer ${token}`;
                }
            }
            
            try {
                const response = await fetch(url, fullOptions);
                logEntry.status = response.status;
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                logEntry.response = responseData;
                addApiLog(logEntry);
                
                if (!response.ok) {
                    let errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
                    if (typeof responseData === 'object' && responseData.message) {
                        errorMsg = responseData.message;
                    } else if (typeof responseData === 'string' && responseData.length < 100) {
                        errorMsg = responseData;
                    }
                    
                    if (response.status === 401 || response.status === 403) {
                        showToast('Session expired. Please log in again.', 'error');
                        handleLogout();
                    }
                    
                    hideSpinner();
                    return [null, new Error(errorMsg), responseData];
                }
                
                hideSpinner();
                return [responseData, null];
                
            } catch (error) {
                console.error('Fetch Error:', error);
                logEntry.status = 'Network Error';
                logEntry.response = error.message;
                addApiLog(logEntry);
                hideSpinner();
                return [null, error, error.message];
            }
        }
        
        
        /**
         * --------------------------------------
         * Developer Tool Module
         * --------------------------------------
         */

        function renderApiLogs() {
            if (!state.apiLogs.length) {
                dom.devToolLogBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">No API calls logged.</td></tr>`;
                return;
            }
            
            dom.devToolLogBody.innerHTML = state.apiLogs.map((log, index) => {
                const statusColor = log.status >= 400 ? 'text-red-400' : (log.status >= 300 ? 'text-yellow-400' : 'text-green-400');
                const methodColor = log.method === 'GET' ? 'text-blue-400' : (log.method === 'POST' ? 'text-green-400' : (log.method === 'PATCH' ? 'text-yellow-400' : (log.method === 'DELETE' ? 'text-red-400' : 'text-gray-400')));
                
                return `
                    <tr class="hover:bg-gray-700">
                        <td class="px-6 py-3 text-sm text-gray-300">${new Date(log.timestamp).toLocaleTimeString()}</td>
                        <td class="px-6 py-3 text-sm font-medium ${statusColor}">${log.status}</td>
                        <td class="px-6 py-3 text-sm font-medium ${methodColor}">${log.method}</td>
                        <td class="px-6 py-3 text-sm text-gray-300 truncate max-w-xs" title="${log.url}">${log.url}</td>
                        <td class="px-6 py-3 text-sm">
                            <button class="view-payload-btn text-blue-400 hover:underline" data-log-index="${index}" data-payload-type="request">View</button>
                        </td>
                        <td class="px-6 py-3 text-sm">
                            <button class="view-payload-btn text-blue-400 hover:underline" data-log-index="${index}" data-payload-type="response">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function showLogPayload(e) {
            if (!e.target.classList.contains('view-payload-btn')) return;
            
            const index = e.target.dataset.logIndex;
            const type = e.target.dataset.payloadType;
            const log = state.apiLogs[index];
            
            if (!log) return;
            
            let title = '';
            let content = '';
            
            if (type === 'request') {
                title = `Request Payload (${log.method})`;
                content = `
                    <h4 class="font-semibold text-gray-300 mb-2">Headers</h4>
                    <pre class="p-3 bg-gray-900 rounded-md text-xs overflow-auto max-h-48">${JSON.stringify(log.request.headers, null, 2)}</pre>
                    <h4 class="font-semibold text-gray-300 mt-4 mb-2">Body</h4>
                    <pre class="p-3 bg-gray-900 rounded-md text-xs overflow-auto max-h-64">${JSON.stringify(log.request.body ? JSON.parse(log.request.body) : 'No Body', null, 2)}</pre>
                `;
            } else {
                title = `Response Payload (Status: ${log.status})`;
                content = `<pre class="p-3 bg-gray-900 rounded-md text-xs overflow-auto max-h-96">${JSON.stringify(log.response, null, 2)}</pre>`;
            }
            
            openGenericModal(title, content);
        }

        function toggleDevTool() {
            if (dom.devToolModal.classList.contains('hidden')) {
                renderApiLogs();
                dom.devToolModal.classList.remove('hidden');
            } else {
                dom.devToolModal.classList.add('hidden');
            }
        }


        /**
         * --------------------------------------
         * Module A: Admin
         * --------------------------------------
         */
         
        function initAdminModule() {
            const form = $('#admin-form');
            form.elements.xpiBaseUrl.value = getGlobalConfig('xpiBaseUrl');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                const newUrl = form.elements.xpiBaseUrl.value;
                setGlobalConfig('xpiBaseUrl', newUrl);
                showToast('Configuration saved successfully!');
            };
        }


        /**
         * --------------------------------------
         * Module B: Login
         * --------------------------------------
         */

        async function initLoginModule() {
            const params = new URLSearchParams(location.search);
            const code = params.get('code');
            
            const authMode = $('#login-auth-mode');
            const callbackMode = $('#login-callback-mode');
            const resultDisplay = $('#login-result-display');
            const resultMsg = $('#login-result-message');
            const resultJson = $('#login-result-json');
            
            if (code) {
                // 2. OAuth Callback Mode
                authMode.classList.add('hidden');
                callbackMode.classList.remove('hidden');
                resultDisplay.classList.add('hidden');

                const clientId = sessionStorage.getItem('xpiClientId');
                
                if (!code || !clientId) {
                    resultDisplay.classList.remove('hidden');
                    resultMsg.className = 'p-4 rounded-lg bg-red-800 text-red-200';
                    resultMsg.textContent = 'Error: Missing "code" or "clientId". Authentication flow is invalid.';
                    setTimeout(() => {
                        location.search = '';
                        location.hash = '';
                    }, 10000);
                    return;
                }
                
                // API Call: Exchange code for token
                const baseUrl = getGlobalConfig('xpiBaseUrl');
                const url = `${baseUrl}/api/v1/wrikexpi/token/exchange?code=${code}&client_id=${clientId}&grant_type=authorization_code`;

                const [tokenData, tokenError, tokenErrorBody] = await safeFetch(url, {}, false);

                if (tokenError) {
                    resultDisplay.classList.remove('hidden');
                    resultMsg.className = 'p-4 rounded-lg bg-red-800 text-red-200';
                    resultMsg.textContent = 'Login Error: Failed to exchange token. Please try again.';
                    resultJson.textContent = JSON.stringify(tokenErrorBody || tokenError.message, null, 2);
                    $('#login-start-over-btn').classList.remove('hidden');
                    return;
                }
                
                if (!tokenData.success || !tokenData.data.token) {
                    resultDisplay.classList.remove('hidden');
                    resultMsg.className = 'p-4 rounded-lg bg-red-800 text-red-200';
                    resultMsg.textContent = 'Login Error: Invalid token response.';
                    resultJson.textContent = JSON.stringify(tokenData, null, 2);
                    $('#login-start-over-btn').classList.remove('hidden');
                    return;
                }
                
                // Store token
                const { token, credentials } = tokenData.data;
                sessionStorage.setItem('xpiToken', token);
                
                // API Call: Verify credentials and get profile
                // Use Basic Auth *only* for this one call
                const profileUrl = `${baseUrl}/api/v1/wrikexpi/amoeba/wrikeapi/contacts?me`;
                const basicAuth = btoa(`${credentials.username}:${credentials.password}`);
                
                const [profileData, profileError, profileErrorBody] = await safeFetch(profileUrl, {
                    headers: { 'Authorization': `Basic ${basicAuth}` }
                }, true); // true = isBasicAuth, skip Bearer token

                if (profileError || !profileData.success || !profileData.data[0]) {
                    resultDisplay.classList.remove('hidden');
                    resultMsg.className = 'p-4 rounded-lg bg-red-800 text-red-200';
                    resultMsg.textContent = 'Login failed, we are unable to verify your account. Please try again.';
                    resultJson.textContent = JSON.stringify(profileErrorBody || profileError.message || profileData, null, 2);
                    $('#login-start-over-btn').classList.remove('hidden');
                    sessionStorage.removeItem('xpiToken'); // Clear bad token
                    return;
                }
                
                // If credential is valid
                const user = profileData.data[0];
                sessionStorage.setItem('xpiFirstName', user.firstName);
                sessionStorage.setItem('xpiLastName', user.lastName);
                sessionStorage.setItem('xpiAvatarUrl', user.avatarUrl);
                
                resultDisplay.classList.remove('hidden');
                resultMsg.className = 'p-4 rounded-lg bg-green-800 text-green-200';
                resultMsg.textContent = `${user.firstName} ${user.lastName} login successfully. Redirecting...`;
                
                // Redirect to main app
                setTimeout(() => {
                    location.search = ''; // Clear query params
                    location.hash = '#campaign-submission'; // Go to default module
                    handleRouting(); // This will also call updateUI()
                }, 2000);

            } else {
                // 1. Authentication Mode
                authMode.classList.remove('hidden');
                callbackMode.classList.add('hidden');
            }
        }
        
        async function handleAuthRedirect() {
            // Generate clientId
            const timestamp = new Date().getTime().toString();
            const random = Math.random().toString();
            const hash = sha256(timestamp + random);
            const clientId = hash.slice(-7);
            
            sessionStorage.setItem('xpiClientId', clientId);
            
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            const redirectUri = location.origin + location.pathname;
            
            const authUrl = `${baseUrl}/?accountId=3128883&redirectUri=${encodeURIComponent(redirectUri)}&client_id=${clientId}`;
            
            // Redirect
            location.href = authUrl;
        }


        /**
         * --------------------------------------
         * Module C: Campaign Submission
         * --------------------------------------
         */

        const campaignState = {
            channels: new Set(['Twitter']) // Default
        };
         
        async function initCampaignModule() {
            // Populate dropdowns
            await populateCampaignDropdown('client', 'clients-grm-mys');
            await populateCampaignDropdown('debtor', 'debtors-grm-mys');
            await populateCampaignDropdown('agency', 'agencies');
            
            renderCampaignTags();
        }
        
        async function populateCampaignDropdown(elementId, apiSlug) {
            const selectEl = $(`#campaign-${elementId}`);
            if (selectEl.options.length > 1) return; // Already populated
            
            selectEl.disabled = true;
            selectEl.innerHTML = '<option>Loading...</option>';
            
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            const url = `${baseUrl}/api/v1/wrikexpi/v1.0/value/${apiSlug}`;
            
            const [data, error] = await safeFetch(url);
            
            if (error || !data.value) {
                selectEl.innerHTML = '<option>Error loading data</option>';
                console.error(`Failed to load ${elementId}:`, error);
                return;
            }
            
            selectEl.innerHTML = '<option value="">Select an option</option>';
            data.value.forEach(item => {
                selectEl.innerHTML += `<option value="${item.value}">${item.value}</option>`;
            });
            selectEl.disabled = false;
        }

        function renderCampaignTags() {
            const container = $('#campaign-channels-container');
            container.innerHTML = '';
            campaignState.channels.forEach(channel => {
                const tag = document.createElement('div');
                tag.className = 'tag-item';
                tag.innerHTML = `
                    ${channel}
                    <span data-value="${channel}" class="tag-remove">&times;</span>
                `;
                container.appendChild(tag);
            });
        }
        
        function handleTagInput(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const input = $('#campaign-channels-input');
                const value = input.value.trim();
                if (value) {
                    campaignState.channels.add(value);
                    renderCampaignTags();
                    input.value = '';
                }
            }
        }
        
        function handleTagRemove(e) {
            if (e.target.classList.contains('tag-remove')) {
                const value = e.target.dataset.value;
                campaignState.channels.delete(value);
                renderCampaignTags();
            }
        }
        
        async function handleCampaignSubmit(e) {
            e.preventDefault();
            const form = $('#campaign-form');
            const submitBtn = $('#campaign-submit-btn');
            const resultWrapper = $('#campaign-result-wrapper');
            const resultPre = $('#campaign-result-pre');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            resultWrapper.classList.add('hidden');
            
            // Construct payload
            const formData = new FormData(form);
            const payload = {
                fields: {}
            };
            
            formData.forEach((value, key) => {
                // Top-level fields
                if (key === 'type' || key === 'space' || key === 'entity' || key === 'varientId') {
                    payload[key] = (key === 'varientId') ? parseInt(value) : value;
                } else {
                    // 'fields' object
                    payload.fields[key] = value;
                }
            });
            
            // Add channels array
            payload.fields.selectedchannels = Array.from(campaignState.channels);
            
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            const url = `${baseUrl}/api/v1/wrikexpi/campaign`;
            
            const [data, error, errorBody] = await safeFetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            resultWrapper.classList.remove('hidden');
            if (error) {
                resultPre.className = 'p-4 bg-gray-800 rounded-lg text-xs overflow-auto max-h-96 text-red-300';
                resultPre.textContent = `Error: ${error.message}\n\n${JSON.stringify(errorBody, null, 2)}`;
            } else {
                resultPre.className = 'p-4 bg-gray-800 rounded-lg text-xs overflow-auto max-h-96 text-green-300';
                resultPre.textContent = JSON.stringify(data, null, 2);
                showToast('Campaign submitted successfully!', 'success');
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Campaign';
        }


        /**
         * --------------------------------------
         * Modules D & E: Master Data Template
         * --------------------------------------
         */
        
        function initMasterDataModule(moduleId, slug, fields) {
            state.masterDataCache[moduleId] = { slug, fields, data: [] };
            const moduleEl = $(`#${moduleId}`);
            
            // Attach event listeners (only once)
            const loadBtn = moduleEl.querySelector('.md-load-btn');
            if (!loadBtn.dataset.listener) {
                loadBtn.addEventListener('click', () => loadMasterData(moduleId));
                loadBtn.dataset.listener = true;
            }

            const createBtn = moduleEl.querySelector('.md-create-btn');
            if (!createBtn.dataset.listener) {
                createBtn.addEventListener('click', () => openMasterDataModal(moduleId, null));
                createBtn.dataset.listener = true;
            }
            
            const tableBody = moduleEl.querySelector('.md-table-body');
            if (!tableBody.dataset.listener) {
                tableBody.addEventListener('click', (e) => handleMasterDataAction(e, moduleId));
                tableBody.dataset.listener = true;
            }
        }
        
        async function loadMasterData(moduleId) {
            const { slug } = state.masterDataCache[moduleId];
            const tableBody = $(`#${moduleId} .md-table-body`);
            tableBody.innerHTML = `<tr><td colspan="100" class="p-4 text-center text-gray-400">Loading...</td></tr>`;
            
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            const url = `${baseUrl}/api/v1/wrikexpi/v1.0/record/${slug}`;
            
            const [data, error] = await safeFetch(url);
            
            if (error || !data.value) {
                tableBody.innerHTML = `<tr><td colspan="100" class="p-4 text-center text-red-400">Error loading data: ${error?.message || 'Unknown error'}</td></tr>`;
                return;
            }
            
            state.masterDataCache[moduleId].data = data.value;
            renderMasterDataTable(moduleId);
        }
        
        function renderMasterDataTable(moduleId) {
            const { fields, data } = state.masterDataCache[moduleId];
            const tableBody = $(`#${moduleId} .md-table-body`);

            if (!data.length) {
                tableBody.innerHTML = `<tr><td colspan="100" class="p-4 text-center text-gray-400">No records found.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(record => `
                <tr class="hover:bg-gray-700">
                    ${fields.map(field => `
                        <td class="px-6 py-3 text-sm text-gray-300 whitespace-nowrap">
                            ${record[field] || 'N/A'}
                        </td>
                    `).join('')}
                    <td class="px-6 py-3 text-sm text-right space-x-2 whitespace-nowrap">
                        <button class="md-edit-btn text-blue-400 hover:underline" data-id="${record.id}">Edit</button>
                        <button class="md-delete-btn text-red-400 hover:underline" data-id="${record.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function handleMasterDataAction(e, moduleId) {
            const id = e.target.dataset.id;
            if (!id) return;
            
            if (e.target.classList.contains('md-edit-btn')) {
                const record = state.masterDataCache[moduleId].data.find(r => r.id === id);
                openMasterDataModal(moduleId, record);
            }
            
            if (e.target.classList.contains('md-delete-btn')) {
                openDeleteConfirmation(moduleId, id);
            }
        }

        function openMasterDataModal(moduleId, record) {
            const { fields, slug } = state.masterDataCache[moduleId];
            const modal = $('#md-modal');
            const form = $('#md-modal-form');
            const title = $('#md-modal-title');
            const body = $('#md-modal-body');
            const errorMsg = $('#md-modal-error');

            const isCreate = !record;
            title.textContent = isCreate ? `Create New ${slug} Record` : `Edit Record ${record.id}`;
            form.dataset.mode = isCreate ? 'create' : 'edit';
            form.dataset.moduleId = moduleId;
            form.dataset.recordId = isCreate ? '' : record.id;
            errorMsg.textContent = '';
            
            // Build form fields
            body.innerHTML = fields.map(field => {
                const isReadOnly = (field === 'id');
                const isRequired = (field === 'value');
                const value = record ? (record[field] || '') : '';
                
                return `
                    <div>
                        <label for="md-field-${field}" class="block text-sm font-medium text-gray-300 mb-2">${field}</label>
                        <input type="text" id="md-field-${field}" name="${field}" 
                               class="${applyFormStyles.inputs} styled-input"
                               value="${value}"
                               ${isReadOnly ? 'readonly class="bg-gray-800 !border-gray-700"' : ''}
                               ${isRequired ? 'required' : ''}>
                    </div>
                `;
            }).join('');
            
            // Re-apply styles to new inputs
            body.querySelectorAll('.styled-input').forEach(el => el.className = `
                w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg 
                focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none 
                disabled:opacity-50 disabled:cursor-not-allowed
                read-only:bg-gray-800 read-only:!border-gray-700 read-only:text-gray-400
            `);
            
            modal.classList.remove('hidden');
        }
        
        function closeMasterDataModal() {
            $('#md-modal').classList.add('hidden');
            $('#md-modal-form').reset();
        }
        
        async function handleMasterDataSave(e) {
            e.preventDefault();
            const form = $('#md-modal-form');
            const saveBtn = $('#md-modal-save');
            const errorMsg = $('#md-modal-error');
            
            const mode = form.dataset.mode;
            const moduleId = form.dataset.moduleId;
            const recordId = form.dataset.recordId;
            const { slug, fields } = state.masterDataCache[moduleId];
            
            saveBtn.disabled = true;
            errorMsg.textContent = '';
            
            // Construct payload
            const formData = new FormData(form);
            const payload = {};
            fields.forEach(field => {
                if (field !== 'id' || mode === 'edit') { // Don't send 'id' on create
                    payload[field] = formData.get(field);
                }
            });
            
            // Add OData context
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            payload['@odata.context'] = `${baseUrl}/api/v1/wrikexpi/v1.0/${slug}`;
            
            let url = `${baseUrl}/api/v1/wrikexpi/v1.0/record/${slug}`;
            let method = 'POST';
            
            if (mode === 'edit') {
                method = 'PATCH';
                payload.id = recordId; // Ensure ID is in payload for PATCH
            }
            
            const [data, error] = await safeFetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (error) {
                errorMsg.textContent = `Error: ${error.message}`;
                saveBtn.disabled = false;
                return;
            }
            
            showToast(`Record ${mode === 'create' ? 'created' : 'updated'} successfully!`, 'success');
            closeMasterDataModal();
            loadMasterData(moduleId); // Refresh data
            saveBtn.disabled = false;
        }

        function openDeleteConfirmation(moduleId, id) {
            const modal = $('#md-delete-modal');
            const confirmBtn = $('#md-delete-confirm');
            const errorMsg = $('#md-delete-error');
            
            confirmBtn.dataset.moduleId = moduleId;
            confirmBtn.dataset.recordId = id;
            errorMsg.textContent = '';
            modal.classList.remove('hidden');
        }
        
        function closeDeleteConfirmation() {
            $('#md-delete-modal').classList.add('hidden');
        }
        
        async function handleMasterDataDelete() {
            const confirmBtn = $('#md-delete-confirm');
            const errorMsg = $('#md-delete-error');
            const moduleId = confirmBtn.dataset.moduleId;
            const recordId = confirmBtn.dataset.recordId;
            const { slug } = state.masterDataCache[moduleId];

            confirmBtn.disabled = true;
            errorMsg.textContent = '';
            
            const baseUrl = getGlobalConfig('xpiBaseUrl');
            const url = `${baseUrl}/api/v1/wrikexpi/v1.0/record/${slug}/${recordId}`;
            
            const [data, error] = await safeFetch(url, { method: 'DELETE' });
            
            if (error) {
                errorMsg.textContent = `Error: ${error.message}`;
                confirmBtn.disabled = false;
                return;
            }
            
            showToast('Record deleted successfully!', 'success');
            closeDeleteConfirmation();
            loadMasterData(moduleId); // Refresh data
            confirmBtn.disabled = false;
        }


        /**
         * --------------------------------------
         * App Initialization
         * --------------------------------------
         */
        
        function initApp() {
            // Load state
            loadGlobalConfig();
            loadApiLogs();
            
            // Init Routing
            handleRouting();
            window.addEventListener('hashchange', handleRouting);
            
            // Nav Listeners
            dom.navToggleBtn.addEventListener('click', toggleNav);
            dom.logoutLink.addEventListener('click', handleLogout);
            dom.navLinks.addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-link')) {
                    // Close nav on mobile after click
                    if (window.innerWidth < 768) {
                        toggleNav();
                    }
                }
            });
            
            // Dev Tool Listeners
            dom.devToolToggle.addEventListener('click', toggleDevTool);
            dom.devToolClose.addEventListener('click', toggleDevTool);
            dom.devToolClearLogs.addEventListener('click', clearApiLogs);
            dom.devToolLogBody.addEventListener('click', showLogPayload);
            
            // Generic Modal Listeners
            dom.genericModalClose.addEventListener('click', closeGenericModal);
            
            // Login Module Listeners
            $('#login-auth-btn').addEventListener('click', handleAuthRedirect);
            $('#login-start-over-btn').addEventListener('click', () => {
                location.search = '';
                location.hash = '';
            });
            
            // Campaign Module Listeners
            $('#campaign-channels-input').addEventListener('keyup', handleTagInput);
            $('#campaign-channels-container').addEventListener('click', handleTagRemove);
            $('#campaign-form').addEventListener('submit', handleCampaignSubmit);

            // Master Data Modal Listeners
            $('#md-modal-close').addEventListener('click', closeMasterDataModal);
            $('#md-modal-cancel').addEventListener('click', closeMasterDataModal);
            $('#md-modal-form').addEventListener('submit', handleMasterDataSave);
            $('#md-delete-modal').addEventListener('click', (e) => {
                if (e.target.id === 'md-delete-cancel' || e.target.id === 'md-delete-modal') {
                    closeDeleteConfirmation();
                } else if (e.target.id === 'md-delete-confirm') {
                    handleMasterDataDelete();
                }
            });
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
